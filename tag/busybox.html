<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Tprrt's Blog | articles tagged "busybox"</title>
    <link rel="shortcut icon" type="image/png" href="https://tprrt.tupi.fr/favicon.png">
    <link rel="shortcut icon" type="image/x-icon" href="https://tprrt.tupi.fr/favicon.ico">
    <link href="/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Tprrt's Blog Full Atom Feed" />
    <link rel="stylesheet" href="https://tprrt.tupi.fr/theme/css/screen.css" type="text/css" />
    <link rel="stylesheet" href="https://tprrt.tupi.fr/theme/css/pygments.css" type="text/css" />
    <link rel="stylesheet" href="https://tprrt.tupi.fr/theme/css/print.css" type="text/css" media="print" />
    <meta name="generator" content="Pelican" />
    <meta name="description" content="" />
    <meta name="author" content="Thomas Perrot" />

      <script data-ad-client="ca-pub-8632147971669760" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
</head>
<body>
    <header>
        <nav>
            <ul>
                <li class="ephemeral selected"><a href="https://tprrt.tupi.fr/tag/busybox.html">busybox</a></li>
                <li><a href="https://tprrt.tupi.fr/">Home</a></li>
                <li><a href="https://tprrt.tupi.fr/pages/contributions.html">Contributions</a></li>
                <li><a href="https://tprrt.tupi.fr/archives">Archives</a></li>
                <li><a href="https://tprrt.tupi.fr/categories">Categories</a></li>
                <li><a href="https://tprrt.tupi.fr/tags">Tags</a></li>
                <li><a href="https://tprrt.tupi.fr/authors">Authors</a></li>
            </ul>
        </nav>
        <div class="header_box">
            <h1><a href="https://tprrt.tupi.fr/">Tprrt's Blog</a></h1>
            <h2>Yet another blog about embedded Linux, the open source and hardware</h2>
        </div>
    </header>
    <div id="wrapper">
        <div id="content">            <h4 class="date">Sep 08, 2020</h4>

            <article class="post">
                <h2 class="title">
                    <a href="https://tprrt.tupi.fr/busybox-chrt-dissection.html" rel="bookmark" title="Permanent Link to &quot;How the Busybox's chrt applet works&quot;">How the Busybox's chrt applet works</a>
                </h2>

                
                

                <div class="section" id="introduction">
<h2>Introduction</h2>
<p>In this article, I will dissect how the <em>chrt</em> applet from the release 1.32.0 of <a class="reference external" href="https://www.busybox.net">Busybox</a> works, what it does, etc.</p>
<p>This command is a Linux utils allowing to consult or to modify the scheduling attributes of a process.</p>
<div class="highlight"><pre><span></span>chrt -m
SCHED_OTHER min/max priority    : <span class="m">0</span>/0
SCHED_FIFO min/max priority     : <span class="m">1</span>/99
SCHED_RR min/max priority       : <span class="m">1</span>/99
SCHED_BATCH min/max priority    : <span class="m">0</span>/0
SCHED_IDLE min/max priority     : <span class="m">0</span>/0
SCHED_DEADLINE min/max priority : <span class="m">0</span>/0

pidof firefox
<span class="m">6987</span> <span class="m">6851</span> <span class="m">6825</span> <span class="m">6816</span> <span class="m">6800</span> <span class="m">6771</span> <span class="m">6767</span> <span class="m">6761</span> <span class="m">6720</span> <span class="m">6611</span>

chrt -p <span class="m">6987</span>
pid <span class="m">6987</span><span class="s1">&#39;s current scheduling policy: SCHED_OTHER</span>
<span class="s1">pid 6987&#39;</span>s current scheduling priority: <span class="m">0</span>

sudo chrt -f -p <span class="m">1</span> <span class="m">6987</span>
chrt -p <span class="m">6987</span>
pid <span class="m">6987</span><span class="s1">&#39;s current scheduling policy: SCHED_FIFO</span>
<span class="s1">pid 6987&#39;</span>s current scheduling priority: <span class="m">1</span>
</pre></div>
<p><a class="reference external" href="https://www.busybox.net">Busybox</a> provides an applet which size, once compiled, and ten times smaller than that of the binary implementation
and with some limitations.</p>
</div>
<div class="section" id="the-dissection">
<h2>The dissection</h2>
<p>The implementation of the <em>chrt</em> applet is in the file <a class="reference external" href="https://elixir.bootlin.com/busybox/1.32.0/source/util-linux/chrt.c">util-linux/chrt.c</a> that containing several functions which are
called in the main function of this applet.</p>
<p>The main function of this applet is divised in three main parts:
- the first parses the command options
- the second prints the scheduler's information
- the last one, to apply scheduler changes in case of a set</p>
<p>At start of main, the character string containing the options are parsed to obtain a bitfield easier to use:</p>
<div class="highlight"><pre><span></span><span class="n">opt</span> <span class="o">=</span> <span class="n">getopt32</span><span class="p">(</span><span class="n">argv</span><span class="p">,</span> <span class="s">&quot;^&quot;</span>
                <span class="s">&quot;+&quot;</span> <span class="s">&quot;mprfobi&quot;</span>
                <span class="s">&quot;</span><span class="se">\0</span><span class="s">&quot;</span>
                <span class="cm">/* only one policy accepted: */</span>
                <span class="s">&quot;r--fobi:f--robi:o--rfbi:b--rfoi:i--rfob&quot;</span>
<span class="p">);</span>
</pre></div>
<p>If the (-m) is set then the min and max valid priorities for each scheduling policies are shown and the command is existed:</p>
<div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="n">opt</span> <span class="o">&amp;</span> <span class="n">OPT_m</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* print min/max and exit */</span>
        <span class="n">show_min_max</span><span class="p">(</span><span class="n">SCHED_OTHER</span><span class="p">);</span>
        <span class="n">show_min_max</span><span class="p">(</span><span class="n">SCHED_FIFO</span><span class="p">);</span>
        <span class="n">show_min_max</span><span class="p">(</span><span class="n">SCHED_RR</span><span class="p">);</span>
        <span class="n">show_min_max</span><span class="p">(</span><span class="n">SCHED_BATCH</span><span class="p">);</span>
        <span class="n">show_min_max</span><span class="p">(</span><span class="n">SCHED_IDLE</span><span class="p">);</span>
        <span class="n">fflush_stdout_and_exit</span><span class="p">(</span><span class="n">EXIT_SUCCESS</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
<p>The function <em>show_min_max</em> sends use the Posix functions <em>sched_get_priority_max</em> and <em>sched_get_priority_min</em> from the
standard C library to send a syscall to the kernel in order to obtain the min and max values accepted by each policy:</p>
<div class="highlight"><pre><span></span><span class="n">max</span> <span class="o">=</span> <span class="n">sched_get_priority_max</span><span class="p">(</span><span class="n">pol</span><span class="p">);</span>
<span class="n">min</span> <span class="o">=</span> <span class="n">sched_get_priority_min</span><span class="p">(</span><span class="n">pol</span><span class="p">);</span>
<span class="k">if</span> <span class="p">((</span><span class="n">max</span><span class="o">|</span><span class="n">min</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">fmt</span> <span class="o">=</span> <span class="s">&quot;SCHED_%s not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
</pre></div>
<p>Otherwise the required options and arguments to show or to apply real-time attributes of a process:</p>
<div class="highlight"><pre><span></span><span class="c1">//if (opt &amp; OPT_r)</span>
<span class="c1">//  policy = SCHED_RR; - default, already set</span>
<span class="k">if</span> <span class="p">(</span><span class="n">opt</span> <span class="o">&amp;</span> <span class="n">OPT_f</span><span class="p">)</span>
    <span class="n">policy</span> <span class="o">=</span> <span class="n">SCHED_FIFO</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="n">opt</span> <span class="o">&amp;</span> <span class="n">OPT_o</span><span class="p">)</span>
    <span class="n">policy</span> <span class="o">=</span> <span class="n">SCHED_OTHER</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="n">opt</span> <span class="o">&amp;</span> <span class="n">OPT_b</span><span class="p">)</span>
    <span class="n">policy</span> <span class="o">=</span> <span class="n">SCHED_BATCH</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="n">opt</span> <span class="o">&amp;</span> <span class="n">OPT_i</span><span class="p">)</span>
    <span class="n">policy</span> <span class="o">=</span> <span class="n">SCHED_IDLE</span><span class="p">;</span>

<span class="n">argv</span> <span class="o">+=</span> <span class="n">optind</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">bb_show_usage</span><span class="p">();</span>
<span class="k">if</span> <span class="p">(</span><span class="n">opt</span> <span class="o">&amp;</span> <span class="n">OPT_p</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">pid_str</span> <span class="o">=</span> <span class="o">*</span><span class="n">argv</span><span class="o">++</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">argv</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* &quot;-p PRIO PID [...]&quot; */</span>
            <span class="n">priority</span> <span class="o">=</span> <span class="n">pid_str</span><span class="p">;</span>
            <span class="n">pid_str</span> <span class="o">=</span> <span class="o">*</span><span class="n">argv</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="cm">/* else &quot;-p PID&quot;, and *argv == NULL */</span>
    <span class="n">pid</span> <span class="o">=</span> <span class="n">xatoul_range</span><span class="p">(</span><span class="n">pid_str</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">((</span><span class="kt">unsigned</span><span class="p">)(</span><span class="kt">pid_t</span><span class="p">)</span><span class="n">ULONG_MAX</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">priority</span> <span class="o">=</span> <span class="o">*</span><span class="n">argv</span><span class="o">++</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">argv</span><span class="p">)</span>
            <span class="n">bb_show_usage</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
<p>Then the applet uses the Posix function <em>sched_getscheduler</em> provides by the standard C library to obtain the scheduling attributes of the process specified by the pid.</p>
<div class="highlight"><pre><span></span><span class="nl">print_rt_info</span><span class="p">:</span>
    <span class="n">pol</span> <span class="o">=</span> <span class="n">sched_getscheduler</span><span class="p">(</span><span class="n">pid</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pol</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">bb_perror_msg_and_die</span><span class="p">(</span><span class="s">&quot;can&#39;t %cet pid %u&#39;s policy&quot;</span><span class="p">,</span> <span class="sc">&#39;g&#39;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">pid</span><span class="p">);</span>
</pre></div>
<p>Finally, when the <em>chrt</em> applet is used to modify scheduling attributes then the Posix function <em>sched_getscheduler</em> is used and the new scheduling attributes are showed:</p>
<div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="n">sched_setscheduler</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">policy</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sp</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">bb_perror_msg_and_die</span><span class="p">(</span><span class="s">&quot;can&#39;t %cet pid %u&#39;s policy&quot;</span><span class="p">,</span> <span class="sc">&#39;s&#39;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">pid</span><span class="p">);</span>

<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="cm">/* &quot;-p PRIO PID [...]&quot; */</span>
    <span class="k">goto</span> <span class="n">print_rt_info</span><span class="p">;</span>
</pre></div>
<p>The function <em>sched_getscheduler</em> and <em>sched_getscheduler</em> will send a syscall to the scheduler subsystem of the kernel Linux.
This subsystem also exposes this information from <em>/proc</em>:</p>
<div class="highlight"><pre><span></span>cat /proc/6987/sched
WebExtensions <span class="o">(</span><span class="m">6987</span>, <span class="c1">#threads: 23)</span>
-------------------------------------------------------------------
se.exec_start                                :       <span class="m">4421312</span>.640001
se.vruntime                                  :        <span class="m">344438</span>.942254
se.sum_exec_runtime                          :         <span class="m">38238</span>.466094
se.nr_migrations                             :                 <span class="m">6811</span>
nr_switches                                  :                <span class="m">49452</span>
nr_voluntary_switches                        :                <span class="m">21749</span>
nr_involuntary_switches                      :                <span class="m">27703</span>
se.load.weight                               :              <span class="m">1048576</span>
se.runnable_weight                           :              <span class="m">1048576</span>
se.avg.load_sum                              :                 <span class="m">3415</span>
se.avg.runnable_load_sum                     :                 <span class="m">3415</span>
se.avg.util_sum                              :              <span class="m">3497621</span>
se.avg.load_avg                              :                   <span class="m">74</span>
se.avg.runnable_load_avg                     :                   <span class="m">74</span>
se.avg.util_avg                              :                   <span class="m">74</span>
se.avg.last_update_time                      :        <span class="m">4421312640000</span>
se.avg.util_est.ewma                         :                   <span class="m">75</span>
se.avg.util_est.enqueued                     :                   <span class="m">75</span>
policy                                       :                    <span class="m">0</span>
prio                                         :                  <span class="m">120</span>
clock-delta                                  :                   <span class="m">89</span>
mm-&gt;numa_scan_seq                            :                    <span class="m">0</span>
numa_pages_migrated                          :                    <span class="m">0</span>
numa_preferred_nid                           :                   -1
total_numa_faults                            :                    <span class="m">0</span>
<span class="nv">current_node</span><span class="o">=</span><span class="m">0</span>, <span class="nv">numa_group_id</span><span class="o">=</span><span class="m">0</span>
numa_faults <span class="nv">node</span><span class="o">=</span><span class="m">0</span> <span class="nv">task_private</span><span class="o">=</span><span class="m">0</span> <span class="nv">task_shared</span><span class="o">=</span><span class="m">0</span> <span class="nv">group_private</span><span class="o">=</span><span class="m">0</span> <span class="nv">group_shared</span><span class="o">=</span><span class="m">0</span>
</pre></div>
</div>
<div class="section" id="limitations">
<h2>Limitations</h2>
<p>Below a short list of limitations that I observed during my analysis of this applet.</p>
<div class="section" id="resetting-scheduling-policy">
<h3>Resetting scheduling policy</h3>
<p>The <em>chrt</em> applet doesn't offer an option (-R) to specify if the scheduling policy should be applied or reseted when a
process is fork to create children. This feature, introduced since Linux 2.6.32, can be only enabled or disabled at the
build of busybox and it is applied on all scheduling attributes modifications done with this applet.</p>
</div>
<div class="section" id="deadline-support">
<h3>Deadline support</h3>
<p>The <em>chrt</em> applet doesn't provide the required scheduling options (-d, -T, -P and -D) to set the deadline scheduling attributes of a process.</p>
</div>
</div>

                <div class="clear"></div>

                <div class="info">
                    <a href="https://tprrt.tupi.fr/busybox-chrt-dissection.html">posted at 19:20</a>
                    &nbsp;&middot;&nbsp;<a href="https://tprrt.tupi.fr/category/busybox.html" rel="tag">busybox</a>
                    &nbsp;&middot;
                    &nbsp;<a href="https://tprrt.tupi.fr/tag/busybox.html" class="tags selected">busybox</a>
                    &nbsp;<a href="https://tprrt.tupi.fr/tag/chrt.html" class="tags">chrt</a>
                    &nbsp;<a href="https://tprrt.tupi.fr/tag/dissection.html" class="tags">dissection</a>
                    &nbsp;<a href="https://tprrt.tupi.fr/tag/beginner.html" class="tags">beginner</a>
                </div>
            </article>            <h4 class="date">Jun 27, 2020</h4>

            <article class="post">
                <h2 class="title">
                    <a href="https://tprrt.tupi.fr/build-an-embedded-linux-in-fifteen-min.html" rel="bookmark" title="Permanent Link to &quot;Build an embedded Linux in less than 15 minutes&quot;">Build an embedded Linux in less than 15 minutes</a>
                </h2>

                
                

                <div class="section" id="introduction">
<h2>Introduction</h2>
<p>Since some years, I no longer built a embedded Linux without using a framework, like <a class="reference external" href="https://openembedded.org">Open Embedded</a> from the <a class="reference external" href="https://yoctoproject.org">Yocto</a>
project.
Then here, I wanted to make a guide to help you to build quickly, from &quot;scratch&quot; a very minimal embedded Linux to boot a
target.
The following examples have been writen to boot a virtual Qemu target but, they can be adapted to boot a real target.
Moreover, the build environment will be boot strapped with a prebuilt cross-toolchain, I have chosen to use one provided
by <a class="reference external" href="https://toolchains.bootlin.com">Bootlin</a> and using glibc.</p>
</div>
<div class="section" id="setup-the-environment">
<h2>Setup the environment</h2>
<p>First, It is required to install the packages that are needed to install and use the cross-toolchain but also to compile the host tools and to provide Qemu:</p>
<ul class="simple">
<li>The Ncurses libraries are only required to execute the command <cite>make menuconfig</cite>.</li>
<li>The certificates and wget will be used to download the prebuilt toolchain.</li>
<li>In the same way, git will be used to checkout the source of <a class="reference external" href="https://busybox.net">Busybox</a> and <a class="reference external" href="https://www.kernel.org">Linux</a>.</li>
<li>The Qemu packages will be used to emulate systeme platform and to execute static binaries cross-compiled for aarch64 on the x86-64 host.</li>
</ul>
<div class="highlight"><pre><span></span>apt update
apt install -y --no-install-recommends <span class="se">\</span>
    bc <span class="se">\</span>
    build-essential <span class="se">\</span>
    ca-certificates <span class="se">\</span>
    cpio <span class="se">\</span>
    file <span class="se">\</span>
    flex <span class="se">\</span>
    git <span class="se">\</span>
    ipxe-qemu <span class="se">\</span>
    libncurses5-dev <span class="se">\</span>
    libncursesw5-dev <span class="se">\</span>
    libssl-dev <span class="se">\</span>
    qemu <span class="se">\</span>
    qemu-system-aarch64 <span class="se">\</span>
    qemu-user-static <span class="se">\</span>
    wget
</pre></div>
<p>Now, it is time to download and install the prebuild toolchain:</p>
<div class="highlight"><pre><span></span>mkdir ~/src
<span class="nb">cd</span> ~/src
wget https://toolchains.bootlin.com/downloads/releases/toolchains/aarch64/tarballs/aarch64--glibc--stable-2020.08-1.tar.bz2
tar xvjf aarch64--glibc--stable-2020.08-1.tar.bz2
</pre></div>
<p>Once the toolchain has been extracted you have to set the required environment variables to cross-compile binaries:</p>
<ul class="simple">
<li><tt class="docutils literal">PATH</tt>: It shall be extended then the cross-tools from the cross-toolchain will be available from the environment</li>
<li><tt class="docutils literal">CROSS_COMPILE</tt>: In order to clarify the prefix used by the cross-tools</li>
<li><tt class="docutils literal">ARCH</tt>: The architecture of the target platform</li>
</ul>
<div class="highlight"><pre><span></span>ls ~/src/aarch64--glibc--stable-2020.08-1/bin/*gcc
~/src/aarch64--glibc--stable-2020.08-1/bin/aarch64-linux-gcc

<span class="nb">export</span> <span class="nb">export</span> <span class="nv">PATH</span><span class="o">=</span>~/src/aarch64--glibc--stable-2020.08-1/bin:<span class="nv">$PATH</span>
<span class="nb">export</span> <span class="nv">CROSS_COMPILE</span><span class="o">=</span>aarch64-linux-
</pre></div>
<p>Now, it is possible to call the cross-tools from the shell:</p>
<div class="highlight"><pre><span></span>aarch64-linux-gcc -v
Using built-in specs.
<span class="nv">COLLECT_GCC</span><span class="o">=</span>~/src/aarch64--glibc--stable-2020.08-1/bin/aarch64-linux-gcc.br_real
<span class="nv">COLLECT_LTO_WRAPPER</span><span class="o">=</span>~/src/aarch64--glibc--stable-2020.08-1/bin/../libexec/gcc/aarch64-buildroot-linux-gnu/9.3.0/lto-wrapper
Target: aarch64-buildroot-linux-gnu
&lt;...&gt;
Thread model: posix
gcc version <span class="m">9</span>.3.0 <span class="o">(</span>Buildroot <span class="m">2020</span>.08-14-ge5a2a90<span class="o">)</span>
</pre></div>
<p>Concerning the variable <tt class="docutils literal">PATH</tt> this one will be set afterwards because its value depends of the binary that will be built.</p>
</div>
<div class="section" id="build-the-linux-kernel">
<h2>Build the Linux kernel</h2>
<p>So, the environment is ready to pull the sources of the latest stable branch of the kernel <a class="reference external" href="https://www.kernel.org">Linux</a> and to build them:</p>
<div class="highlight"><pre><span></span>git clone git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git
<span class="nb">cd</span> linux
git checkout -b local/linux-5.4.y origin/linux-5.4.y
<span class="c1"># git show HEAD</span>

<span class="nb">export</span> <span class="nv">ARCH</span><span class="o">=</span>arm64

make defconfig
  HOSTCC  scripts/basic/fixdep
  HOSTCC  scripts/kconfig/conf.o
  HOSTCC  scripts/kconfig/confdata.o
  HOSTCC  scripts/kconfig/expr.o
  LEX     scripts/kconfig/lexer.lex.c
  YACC    scripts/kconfig/parser.tab.<span class="o">[</span>ch<span class="o">]</span>
  HOSTCC  scripts/kconfig/lexer.lex.o
  HOSTCC  scripts/kconfig/parser.tab.o
  HOSTCC  scripts/kconfig/preprocess.o
  HOSTCC  scripts/kconfig/symbol.o
  HOSTLD  scripts/kconfig/conf
*** Default configuration is based on <span class="s1">&#39;defconfig&#39;</span>
<span class="c1">#</span>
<span class="c1"># configuration written to .config</span>
<span class="c1">#</span>

<span class="c1"># make menuconfig</span>

make -j<span class="k">$(</span>nproc<span class="k">)</span>
  &lt;...&gt;
  AR      drivers/net/ethernet/built-in.a
  AR      drivers/net/built-in.a
  AR      drivers/built-in.a
  GEN     .version
  CHK     include/generated/compile.h
  LD      vmlinux.o
  MODPOST vmlinux.o
  MODINFO modules.builtin.modinfo
  LD      .tmp_vmlinux.kallsyms1
  KSYM    .tmp_vmlinux.kallsyms1.o
  LD      .tmp_vmlinux.kallsyms2
  KSYM    .tmp_vmlinux.kallsyms2.o
  LD      vmlinux
  SORTEX  vmlinux
  SYSMAP  System.map
  Building modules, stage <span class="m">2</span>.
  MODPOST <span class="m">531</span> modules
  OBJCOPY arch/arm64/boot/Image
  GZIP    arch/arm64/boot/Image.gz
</pre></div>
<p>The command <tt class="docutils literal">make defconfig</tt> will apply the default configuration for the target platform (cf. <tt class="docutils literal">ARCH=arm64</tt>), and the
compilation will be performed by <tt class="docutils literal">make <span class="pre">-j$(nproc)</span></tt>.</p>
<p>The commands <tt class="docutils literal">git show HEAD</tt> and <tt class="docutils literal">make defconfig</tt> are optional:
- the first is usefull to verify that the latest commit corresponding to the latest tag of the branch <tt class="docutils literal"><span class="pre">linux-5.4.y</span></tt>.
- the second can be used if you want to customize the kernel configuration.</p>
<p><em>NB</em>. The kernel <a class="reference external" href="https://www.kernel.org">Linux</a> but also <a class="reference external" href="https://busybox.net">Busybox</a> and some projects use <a class="reference external" href="https://www.kernel.org/doc/html/latest/kbuild/kbuild.html">Kbuild</a> to manage the build options</p>
</div>
<div class="section" id="populate-the-sysroot">
<h2>Populate the sysroot</h2>
<p>The easy way to bootstrap a sysroot is to use <a class="reference external" href="https://busybox.net">Busybox</a> that has been created to offer common UNIX tools into a single
executable and it has size-optimized. To create a sysroot, it is only required to add a few configuration files.</p>
<p>The steps to pull and build <a class="reference external" href="https://busybox.net">Busybox</a> are similar to those of the kernel <a class="reference external" href="https://www.kernel.org">Linux</a>.</p>
<div class="highlight"><pre><span></span>git clone git://git.busybox.net/busybox
<span class="nb">cd</span> busybox
git checkout -b local/1_32_stable origin/1_32_stable
<span class="c1"># git show HEAD</span>

<span class="nb">export</span> <span class="nv">ARCH</span><span class="o">=</span>aarch64
<span class="nb">export</span> <span class="nv">LDFLAGS</span><span class="o">=</span><span class="s2">&quot;--static&quot;</span>

make defconfig
<span class="c1"># make menuconfig</span>
make -j<span class="k">$(</span>nproc<span class="k">)</span>

make install
</pre></div>
<p>Here, the <em>LDFLAGS</em> is set to force the static link of <a class="reference external" href="https://busybox.net">Busybox</a> quickly, but it is also possible to use
<em>make menuconfig</em> to set <em>CONFIG_STATIC=y</em>. The advantage of the static executable is that it can be tested with Qemu:</p>
<div class="highlight"><pre><span></span>qemu-aarch64-static busybox <span class="nb">echo</span> <span class="s2">&quot;Hello!&quot;</span>
Hello!
qemu-aarch64-static busybox date
Sat Jun <span class="m">27</span> <span class="m">15</span>:06:41 UTC <span class="m">2020</span>
</pre></div>
<p>The binary <em>qemu-aarch64-static</em> allows to execute a binary built for another architecture on the host computer, for
example here it allows to execute the <a class="reference external" href="https://busybox.net">Busybox</a> binary compiled for an aarch64 target on a x86-64 host.</p>
<p>The last command <em>make install</em> created a tree into the <em>_install</em> directory that can be used to populate the sysroot:</p>
<div class="highlight"><pre><span></span>ls -l _install
total <span class="m">4</span>
drwxr-xr-x. <span class="m">1</span> tperrot tperrot <span class="m">974</span> Nov <span class="m">30</span> <span class="m">15</span>:22 bin
lrwxrwxrwx. <span class="m">1</span> tperrot tperrot  <span class="m">11</span> Nov <span class="m">30</span> <span class="m">15</span>:22 linuxrc -&gt; bin/busybox
drwxr-xr-x. <span class="m">1</span> tperrot tperrot <span class="m">986</span> Nov <span class="m">30</span> <span class="m">15</span>:22 sbin
drwxr-xr-x. <span class="m">1</span> tperrot tperrot  <span class="m">14</span> Nov <span class="m">30</span> <span class="m">15</span>:22 usr

ls -l _install/bin
&lt;...&gt;
lrwxrwxrwx. <span class="m">1</span> tperrot tperrot       <span class="m">7</span> Nov <span class="m">30</span> <span class="m">15</span>:22 umount -&gt; busybox
lrwxrwxrwx. <span class="m">1</span> tperrot tperrot       <span class="m">7</span> Nov <span class="m">30</span> <span class="m">15</span>:22 uname -&gt; busybox
lrwxrwxrwx. <span class="m">1</span> tperrot tperrot       <span class="m">7</span> Nov <span class="m">30</span> <span class="m">15</span>:22 usleep -&gt; busybox
lrwxrwxrwx. <span class="m">1</span> tperrot tperrot       <span class="m">7</span> Nov <span class="m">30</span> <span class="m">15</span>:22 vi -&gt; busybox
lrwxrwxrwx. <span class="m">1</span> tperrot tperrot       <span class="m">7</span> Nov <span class="m">30</span> <span class="m">15</span>:22 watch -&gt; busybox
lrwxrwxrwx. <span class="m">1</span> tperrot tperrot       <span class="m">7</span> Nov <span class="m">30</span> <span class="m">15</span>:22 zcat -&gt; busybox
</pre></div>
<p>In order, to finalize this minimal sysroot, it is required to create a rcS init script:</p>
<div class="highlight"><pre><span></span>mkdir _install/proc _install/sys _install/dev _install/etc _install/etc/init.d
cat &gt; _install/etc/init.d/rcS <span class="s">&lt;&lt; EOF</span>
<span class="s">#!/bin/sh</span>
<span class="s">mount -t proc none /proc</span>
<span class="s">mount -t sysfs none /sys</span>
<span class="s">/sbin/mdev -s</span>
<span class="s">[ ! -h /etc/mtab ]  &amp;&amp; ln -s /proc/mounts /etc/mtab</span>
<span class="s">[ ! -f /etc/resolv.conf ] &amp;&amp; cat /proc/net/pnp &gt; /etc/resolv.conf</span>
<span class="s">EOF</span>
chmod +x _install/etc/init.d/rcS
</pre></div>
</div>
<div class="section" id="build-the-filesystem">
<h2>Build the filesystem</h2>
<p>The target of this step is to package the sysroot tree into a filesystem that can be mounted by the kernel.
There is two available possibilities, either build a <em>ramfs</em> or a <em>rootfs</em>.</p>
<p>Globally, the difference between both is that:</p>
<ul class="simple">
<li>the ramfs is a very simple filesystem that can be used by the kernel to create a block device into the RAM space from an archive.</li>
<li>the rootfs is a filesystem mounted from a non volatile device by the kernel.</li>
</ul>
<p>For more information about the difference between the ramfs and the rootfs, you can you refer to the <a class="reference external" href="https://www.kernel.org/doc/html/latest/filesystems/ramfs-rootfs-initramfs.html">kernel documentation</a>.</p>
<div class="section" id="build-a-ramfs">
<h3>Build a ramfs</h3>
<p>To build the ramfs we will use <em>cpio</em> and <em>gzip</em> to construct the compressed archive after modifying the rights:</p>
<div class="highlight"><pre><span></span>mkdir _rootfs
rsync -a _install/ _rootfs
chown -R root:root _rootfs
<span class="nb">cd</span> _rootfs
find . <span class="p">|</span> cpio -o --format<span class="o">=</span>newc &gt; ../rootfs.cpio
<span class="nb">cd</span> ..
gzip -c rootfs.cpio &gt; rootfs.cpio.gz
</pre></div>
</div>
<div class="section" id="build-a-rootfs">
<h3>Build a rootfs</h3>
<p>To build the rootfs, the first step is to create an empty binary blob that will be mounted into a loop device to be
formated to create a ext3 filesytem. Then the tree can be copied and the rights updated.</p>
<div class="highlight"><pre><span></span>dd <span class="k">if</span><span class="o">=</span>/dev/zero <span class="nv">of</span><span class="o">=</span>rootfs.img <span class="nv">bs</span><span class="o">=</span>1M <span class="nv">count</span><span class="o">=</span><span class="m">10</span>
mke2fs -j rootfs.img
mkdir _rootfs
mount -o loop rootfs.img _rootfs
rsync -a _install/ _rootfs
chown -R root:root _rootfs
sync
umount _rootfs
</pre></div>
</div>
</div>
<div class="section" id="boot-the-target">
<h2>Boot the target</h2>
<p>Following, the qemu commands to boot the minimal embedded Linux system that has been built.</p>
<div class="highlight"><pre><span></span><span class="c1"># With the ramfs</span>
qemu-system-aarch64 -nographic -no-reboot -machine virt -cpu cortex-a57 -smp <span class="m">2</span> -m <span class="m">256</span> <span class="se">\</span>
    -kernel ~/src/linux/arch/arm64/boot/Image <span class="se">\</span>
    -initrd ~/src/busybox/rootfs.cpio.gz <span class="se">\</span>
    -append <span class="s2">&quot;panic=5 ro ip=dhcp root=/dev/ram rdinit=/sbin/init&quot;</span>

<span class="c1"># With the rootfs</span>
qemu-system-aarch64 -nographic -no-reboot -machine virt -cpu cortex-a57 -smp <span class="m">2</span> -m <span class="m">256</span> <span class="se">\</span>
    -kernel ~/src/linux/arch/arm64/boot/Image <span class="se">\</span>
    -append <span class="s2">&quot;panic=5 ro ip=dhcp root=/dev/vda&quot;</span> <span class="se">\</span>
    -drive <span class="nv">file</span><span class="o">=</span>~/src/busybox/rootfs.img,format<span class="o">=</span>raw,if<span class="o">=</span>none,id<span class="o">=</span>hd0 -device virtio-blk-device,drive<span class="o">=</span>hd0
</pre></div>
<p>Then the target will be boot to shell, <em>&quot;It's alive!&quot;</em>:</p>
<div class="highlight"><pre><span></span><span class="o">[</span>    <span class="m">0</span>.000000<span class="o">]</span> Booting Linux on physical CPU 0x0000000000 <span class="o">[</span>0x411fd070<span class="o">]</span>
<span class="o">[</span>    <span class="m">0</span>.000000<span class="o">]</span> Linux version <span class="m">5</span>.10.0-rc5 <span class="o">(</span>tperrot@27ea4a863f61<span class="o">)</span> <span class="o">(</span>aarch64-linux-gcc.br_real <span class="o">(</span>Buildroot <span class="m">2020</span>.08-14-ge5a2a90<span class="o">)</span> <span class="m">9</span>.3.0, GNU ld <span class="o">(</span>GNU Binutils<span class="o">)</span> <span class="m">2</span>.33.1<span class="o">)</span> <span class="c1">#1 SMP PREEMPT Mon Nov 30 14:40:05 UTC 2020</span>
<span class="o">[</span>    <span class="m">0</span>.000000<span class="o">]</span> Machine model: linux,dummy-virt
&lt;...&gt;
<span class="o">[</span>    <span class="m">0</span>.858346<span class="o">]</span> Sending DHCP requests ., OK
<span class="o">[</span>    <span class="m">0</span>.870558<span class="o">]</span> IP-Config: Got DHCP answer from <span class="m">10</span>.0.2.2, my address is <span class="m">10</span>.0.2.15
<span class="o">[</span>    <span class="m">0</span>.870909<span class="o">]</span> IP-Config: Complete:
<span class="o">[</span>    <span class="m">0</span>.871199<span class="o">]</span>      <span class="nv">device</span><span class="o">=</span>eth0, <span class="nv">hwaddr</span><span class="o">=</span><span class="m">52</span>:54:00:12:34:56, <span class="nv">ipaddr</span><span class="o">=</span><span class="m">10</span>.0.2.15, <span class="nv">mask</span><span class="o">=</span><span class="m">255</span>.255.255.0, <span class="nv">gw</span><span class="o">=</span><span class="m">10</span>.0.2.2
<span class="o">[</span>    <span class="m">0</span>.871566<span class="o">]</span>      <span class="nv">host</span><span class="o">=</span><span class="m">10</span>.0.2.15, <span class="nv">domain</span><span class="o">=</span>, nis-domain<span class="o">=(</span>none<span class="o">)</span>
<span class="o">[</span>    <span class="m">0</span>.871825<span class="o">]</span>      <span class="nv">bootserver</span><span class="o">=</span><span class="m">10</span>.0.2.2, <span class="nv">rootserver</span><span class="o">=</span><span class="m">10</span>.0.2.2, <span class="nv">rootpath</span><span class="o">=</span>
<span class="o">[</span>    <span class="m">0</span>.871866<span class="o">]</span>      <span class="nv">nameserver0</span><span class="o">=</span><span class="m">10</span>.0.2.3
<span class="o">[</span>    <span class="m">0</span>.872389<span class="o">]</span>
<span class="o">[</span>    <span class="m">0</span>.875863<span class="o">]</span> ALSA device list:
<span class="o">[</span>    <span class="m">0</span>.876151<span class="o">]</span>   No soundcards found.
<span class="o">[</span>    <span class="m">0</span>.879353<span class="o">]</span> uart-pl011 <span class="m">9000000</span>.pl011: no DMA platform data
<span class="o">[</span>    <span class="m">0</span>.920237<span class="o">]</span> Freeing unused kernel memory: 5952K
<span class="o">[</span>    <span class="m">0</span>.921223<span class="o">]</span> Run /sbin/init as init process

Please press Enter to activate this console.
</pre></div>
</div>

                <div class="clear"></div>

                <div class="info">
                    <a href="https://tprrt.tupi.fr/build-an-embedded-linux-in-fifteen-min.html">posted at 13:01</a>
                    &nbsp;&middot;&nbsp;<a href="https://tprrt.tupi.fr/category/linux.html" rel="tag">linux</a>
                    &nbsp;&middot;
                    &nbsp;<a href="https://tprrt.tupi.fr/tag/busybox.html" class="tags selected">busybox</a>
                    &nbsp;<a href="https://tprrt.tupi.fr/tag/embedded.html" class="tags">embedded</a>
                    &nbsp;<a href="https://tprrt.tupi.fr/tag/intermediate.html" class="tags">intermediate</a>
                    &nbsp;<a href="https://tprrt.tupi.fr/tag/linux.html" class="tags">linux</a>
                    &nbsp;<a href="https://tprrt.tupi.fr/tag/qemu.html" class="tags">qemu</a>
                </div>
            </article>

            <div class="clear"></div>
            <footer>
                <p>
                <a href="https://github.com/jody-frankowski/blue-penguin">Blue Penguin</a> Theme
                &middot;
                Powered by <a href="http://getpelican.com">Pelican</a>
                &middot;
                <a href="https://tprrt.tupi.fr/feeds/all.atom.xml" rel="alternate">Atom Feed</a>
            </footer>
        </div>
        <div class="clear"></div>
    </div>
    <script type="text/javascript">
    var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
    document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
    try {
        var pageTracker = _gat._getTracker("UA-169118252-1");
    pageTracker._trackPageview();
    } catch(err) {}</script>
</body>
</html>