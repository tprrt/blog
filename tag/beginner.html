<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Tprrt's Blog | articles tagged "beginner"</title>
    <link rel="shortcut icon" type="image/png" href="https://tprrt.tupi.fr/favicon.png">
    <link rel="shortcut icon" type="image/x-icon" href="https://tprrt.tupi.fr/favicon.ico">
    <link href="/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Tprrt's Blog Full Atom Feed" />
    <link href="/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="Tprrt's Blog Full RSS Feed" />
    <link rel="stylesheet" href="https://tprrt.tupi.fr/theme/css/screen.css" type="text/css" />
    <link rel="stylesheet" href="https://tprrt.tupi.fr/theme/css/pygments.css" type="text/css" />
    <link rel="stylesheet" href="https://tprrt.tupi.fr/theme/css/print.css" type="text/css" media="print" />
    <meta name="generator" content="Pelican" />
    <meta name="description" content="" />
    <meta name="author" content="Thomas Perrot" />

    <script data-ad-client="ca-pub-8632147971669760"
            async="async"
            src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"
            integrity="sha256-H0yTZ/g80w4995dyBRDArJlCXWcYuBANtPbA82uyu00="
            crossorigin="anonymous">
    </script>
</head>
<body>
    <header>
        <nav>
            <ul>
                <li class="ephemeral selected"><a href="https://tprrt.tupi.fr/tag/beginner.html">beginner</a></li>
                <li><a href="https://tprrt.tupi.fr/">Home</a></li>
                <li><a href="https://tprrt.tupi.fr/contributions">Contributions</a></li>
                <li><a href="https://tprrt.tupi.fr/archives">Archives</a></li>
                <li><a href="https://tprrt.tupi.fr/categories">Categories</a></li>
                <li><a href="https://tprrt.tupi.fr/contact">Contact</a></li>
            </ul>
        </nav>
        <div class="header_box">
            <h1><a href="https://tprrt.tupi.fr/">Tprrt's Blog</a></h1>
            <h2>Yet another blog about embedded Linux, the open source and hardware</h2>
        </div>
    </header>
    <div id="wrapper">
        <div id="content">            <h4 class="date">Sep 08, 2020</h4>

            <article class="post">
                <h2 class="title">
                    <a href="https://tprrt.tupi.fr/busybox-chrt-dissection.html" rel="bookmark" title="Permanent Link to &quot;How the Busybox's chrt applet works&quot;">How the Busybox's chrt applet works</a>
                </h2>

                
                

                <div class="section" id="introduction">
<h2>Introduction</h2>
<p>In this article, I will dissect how the <em>chrt</em> applet from the release 1.32.0 of <a class="reference external" href="https://www.busybox.net">Busybox</a> works, what it does, etc.</p>
<p>This command is a Linux utils allowing to consult or to modify the scheduling attributes of a process.</p>
<div class="highlight"><pre><span></span>chrt -m
SCHED_OTHER min/max priority    : <span class="m">0</span>/0
SCHED_FIFO min/max priority     : <span class="m">1</span>/99
SCHED_RR min/max priority       : <span class="m">1</span>/99
SCHED_BATCH min/max priority    : <span class="m">0</span>/0
SCHED_IDLE min/max priority     : <span class="m">0</span>/0
SCHED_DEADLINE min/max priority : <span class="m">0</span>/0

pidof firefox
<span class="m">6987</span> <span class="m">6851</span> <span class="m">6825</span> <span class="m">6816</span> <span class="m">6800</span> <span class="m">6771</span> <span class="m">6767</span> <span class="m">6761</span> <span class="m">6720</span> <span class="m">6611</span>

chrt -p <span class="m">6987</span>
pid <span class="m">6987</span><span class="s1">&#39;s current scheduling policy: SCHED_OTHER</span>
<span class="s1">pid 6987&#39;</span>s current scheduling priority: <span class="m">0</span>

sudo chrt -f -p <span class="m">1</span> <span class="m">6987</span>
chrt -p <span class="m">6987</span>
pid <span class="m">6987</span><span class="s1">&#39;s current scheduling policy: SCHED_FIFO</span>
<span class="s1">pid 6987&#39;</span>s current scheduling priority: <span class="m">1</span>
</pre></div>
<p><a class="reference external" href="https://www.busybox.net">Busybox</a> provides an applet which size, once compiled, and ten times smaller than that of the binary implementation
and with some limitations.</p>
</div>
<div class="section" id="the-dissection">
<h2>The dissection</h2>
<p>The implementation of the <em>chrt</em> applet is in the file <a class="reference external" href="https://elixir.bootlin.com/busybox/1.32.0/source/util-linux/chrt.c">util-linux/chrt.c</a> that containing several functions which are
called in the main function of this applet.</p>
<p>The main function of this applet is divised in three main parts:
- the first parses the command options
- the second prints the scheduler's information
- the last one, to apply scheduler changes in case of a set</p>
<p>At start of main, the character string containing the options are parsed to obtain a bitfield easier to use:</p>
<div class="highlight"><pre><span></span><span class="n">opt</span> <span class="o">=</span> <span class="n">getopt32</span><span class="p">(</span><span class="n">argv</span><span class="p">,</span> <span class="s">&quot;^&quot;</span>
                <span class="s">&quot;+&quot;</span> <span class="s">&quot;mprfobi&quot;</span>
                <span class="s">&quot;</span><span class="se">\0</span><span class="s">&quot;</span>
                <span class="cm">/* only one policy accepted: */</span>
                <span class="s">&quot;r--fobi:f--robi:o--rfbi:b--rfoi:i--rfob&quot;</span>
<span class="p">);</span>
</pre></div>
<p>If the (-m) is set then the min and max valid priorities for each scheduling policies are shown and the command is existed:</p>
<div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="n">opt</span> <span class="o">&amp;</span> <span class="n">OPT_m</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* print min/max and exit */</span>
        <span class="n">show_min_max</span><span class="p">(</span><span class="n">SCHED_OTHER</span><span class="p">);</span>
        <span class="n">show_min_max</span><span class="p">(</span><span class="n">SCHED_FIFO</span><span class="p">);</span>
        <span class="n">show_min_max</span><span class="p">(</span><span class="n">SCHED_RR</span><span class="p">);</span>
        <span class="n">show_min_max</span><span class="p">(</span><span class="n">SCHED_BATCH</span><span class="p">);</span>
        <span class="n">show_min_max</span><span class="p">(</span><span class="n">SCHED_IDLE</span><span class="p">);</span>
        <span class="n">fflush_stdout_and_exit</span><span class="p">(</span><span class="n">EXIT_SUCCESS</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
<p>The function <em>show_min_max</em> sends use the Posix functions <em>sched_get_priority_max</em> and <em>sched_get_priority_min</em> from the
standard C library to send a syscall to the kernel in order to obtain the min and max values accepted by each policy:</p>
<div class="highlight"><pre><span></span><span class="n">max</span> <span class="o">=</span> <span class="n">sched_get_priority_max</span><span class="p">(</span><span class="n">pol</span><span class="p">);</span>
<span class="n">min</span> <span class="o">=</span> <span class="n">sched_get_priority_min</span><span class="p">(</span><span class="n">pol</span><span class="p">);</span>
<span class="k">if</span> <span class="p">((</span><span class="n">max</span><span class="o">|</span><span class="n">min</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">fmt</span> <span class="o">=</span> <span class="s">&quot;SCHED_%s not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
</pre></div>
<p>Otherwise the required options and arguments to show or to apply real-time attributes of a process:</p>
<div class="highlight"><pre><span></span><span class="c1">//if (opt &amp; OPT_r)</span>
<span class="c1">//  policy = SCHED_RR; - default, already set</span>
<span class="k">if</span> <span class="p">(</span><span class="n">opt</span> <span class="o">&amp;</span> <span class="n">OPT_f</span><span class="p">)</span>
    <span class="n">policy</span> <span class="o">=</span> <span class="n">SCHED_FIFO</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="n">opt</span> <span class="o">&amp;</span> <span class="n">OPT_o</span><span class="p">)</span>
    <span class="n">policy</span> <span class="o">=</span> <span class="n">SCHED_OTHER</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="n">opt</span> <span class="o">&amp;</span> <span class="n">OPT_b</span><span class="p">)</span>
    <span class="n">policy</span> <span class="o">=</span> <span class="n">SCHED_BATCH</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="n">opt</span> <span class="o">&amp;</span> <span class="n">OPT_i</span><span class="p">)</span>
    <span class="n">policy</span> <span class="o">=</span> <span class="n">SCHED_IDLE</span><span class="p">;</span>

<span class="n">argv</span> <span class="o">+=</span> <span class="n">optind</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">bb_show_usage</span><span class="p">();</span>
<span class="k">if</span> <span class="p">(</span><span class="n">opt</span> <span class="o">&amp;</span> <span class="n">OPT_p</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">pid_str</span> <span class="o">=</span> <span class="o">*</span><span class="n">argv</span><span class="o">++</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">argv</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* &quot;-p PRIO PID [...]&quot; */</span>
            <span class="n">priority</span> <span class="o">=</span> <span class="n">pid_str</span><span class="p">;</span>
            <span class="n">pid_str</span> <span class="o">=</span> <span class="o">*</span><span class="n">argv</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="cm">/* else &quot;-p PID&quot;, and *argv == NULL */</span>
    <span class="n">pid</span> <span class="o">=</span> <span class="n">xatoul_range</span><span class="p">(</span><span class="n">pid_str</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">((</span><span class="kt">unsigned</span><span class="p">)(</span><span class="kt">pid_t</span><span class="p">)</span><span class="n">ULONG_MAX</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">priority</span> <span class="o">=</span> <span class="o">*</span><span class="n">argv</span><span class="o">++</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">argv</span><span class="p">)</span>
            <span class="n">bb_show_usage</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
<p>Then the applet uses the Posix function <em>sched_getscheduler</em> provides by the standard C library to obtain the scheduling attributes of the process specified by the pid.</p>
<div class="highlight"><pre><span></span><span class="nl">print_rt_info</span><span class="p">:</span>
    <span class="n">pol</span> <span class="o">=</span> <span class="n">sched_getscheduler</span><span class="p">(</span><span class="n">pid</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pol</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">bb_perror_msg_and_die</span><span class="p">(</span><span class="s">&quot;can&#39;t %cet pid %u&#39;s policy&quot;</span><span class="p">,</span> <span class="sc">&#39;g&#39;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">pid</span><span class="p">);</span>
</pre></div>
<p>Finally, when the <em>chrt</em> applet is used to modify scheduling attributes then the Posix function <em>sched_getscheduler</em> is used and the new scheduling attributes are showed:</p>
<div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="n">sched_setscheduler</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">policy</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sp</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">bb_perror_msg_and_die</span><span class="p">(</span><span class="s">&quot;can&#39;t %cet pid %u&#39;s policy&quot;</span><span class="p">,</span> <span class="sc">&#39;s&#39;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">pid</span><span class="p">);</span>

<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="cm">/* &quot;-p PRIO PID [...]&quot; */</span>
    <span class="k">goto</span> <span class="n">print_rt_info</span><span class="p">;</span>
</pre></div>
<p>The function <em>sched_getscheduler</em> and <em>sched_getscheduler</em> will send a syscall to the scheduler subsystem of the kernel Linux.
This subsystem also exposes this information from <em>/proc</em>:</p>
<div class="highlight"><pre><span></span>cat /proc/6987/sched
WebExtensions <span class="o">(</span><span class="m">6987</span>, <span class="c1">#threads: 23)</span>
-------------------------------------------------------------------
se.exec_start                                :       <span class="m">4421312</span>.640001
se.vruntime                                  :        <span class="m">344438</span>.942254
se.sum_exec_runtime                          :         <span class="m">38238</span>.466094
se.nr_migrations                             :                 <span class="m">6811</span>
nr_switches                                  :                <span class="m">49452</span>
nr_voluntary_switches                        :                <span class="m">21749</span>
nr_involuntary_switches                      :                <span class="m">27703</span>
se.load.weight                               :              <span class="m">1048576</span>
se.runnable_weight                           :              <span class="m">1048576</span>
se.avg.load_sum                              :                 <span class="m">3415</span>
se.avg.runnable_load_sum                     :                 <span class="m">3415</span>
se.avg.util_sum                              :              <span class="m">3497621</span>
se.avg.load_avg                              :                   <span class="m">74</span>
se.avg.runnable_load_avg                     :                   <span class="m">74</span>
se.avg.util_avg                              :                   <span class="m">74</span>
se.avg.last_update_time                      :        <span class="m">4421312640000</span>
se.avg.util_est.ewma                         :                   <span class="m">75</span>
se.avg.util_est.enqueued                     :                   <span class="m">75</span>
policy                                       :                    <span class="m">0</span>
prio                                         :                  <span class="m">120</span>
clock-delta                                  :                   <span class="m">89</span>
mm-&gt;numa_scan_seq                            :                    <span class="m">0</span>
numa_pages_migrated                          :                    <span class="m">0</span>
numa_preferred_nid                           :                   -1
total_numa_faults                            :                    <span class="m">0</span>
<span class="nv">current_node</span><span class="o">=</span><span class="m">0</span>, <span class="nv">numa_group_id</span><span class="o">=</span><span class="m">0</span>
numa_faults <span class="nv">node</span><span class="o">=</span><span class="m">0</span> <span class="nv">task_private</span><span class="o">=</span><span class="m">0</span> <span class="nv">task_shared</span><span class="o">=</span><span class="m">0</span> <span class="nv">group_private</span><span class="o">=</span><span class="m">0</span> <span class="nv">group_shared</span><span class="o">=</span><span class="m">0</span>
</pre></div>
</div>
<div class="section" id="limitations">
<h2>Limitations</h2>
<p>Below a short list of limitations that I observed during my analysis of this applet.</p>
<div class="section" id="resetting-scheduling-policy">
<h3>Resetting scheduling policy</h3>
<p>The <em>chrt</em> applet doesn't offer an option (-R) to specify if the scheduling policy should be applied or reseted when a
process is fork to create children. This feature, introduced since Linux 2.6.32, can be only enabled or disabled at the
build of busybox and it is applied on all scheduling attributes modifications done with this applet.</p>
</div>
<div class="section" id="deadline-support">
<h3>Deadline support</h3>
<p>The <em>chrt</em> applet doesn't provide the required scheduling options (-d, -T, -P and -D) to set the deadline scheduling attributes of a process.</p>
</div>
</div>

                <div class="clear"></div>

                <div class="info">
                    <a href="https://tprrt.tupi.fr/busybox-chrt-dissection.html">posted at 19:20</a>
                    &nbsp;&middot;&nbsp;<a href="https://tprrt.tupi.fr/category/busybox.html" rel="tag">busybox</a>
                    &nbsp;&middot;
                    &nbsp;<a href="https://tprrt.tupi.fr/tag/busybox.html" class="tags">busybox</a>
                    &nbsp;<a href="https://tprrt.tupi.fr/tag/chrt.html" class="tags">chrt</a>
                    &nbsp;<a href="https://tprrt.tupi.fr/tag/dissection.html" class="tags">dissection</a>
                    &nbsp;<a href="https://tprrt.tupi.fr/tag/beginner.html" class="tags selected">beginner</a>
                </div>
            </article>

            <div class="clear"></div>
            <footer>
                <p>
                <a href="https://github.com/jody-frankowski/blue-penguin">Blue Penguin</a> Theme
                &middot;
                Powered by <a href="http://getpelican.com">Pelican</a>
                &middot;
                <a href="https://tprrt.tupi.fr/feeds/all.atom.xml" rel="alternate">Atom Feed</a>
                &middot;
                <a href="https://tprrt.tupi.fr/feeds/all.rss.xml" rel="alternate">Rss Feed</a>
            </footer>
        </div>
        <div class="clear"></div>
    </div>
    <script type="text/javascript">
    var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
    document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
    try {
        var pageTracker = _gat._getTracker("UA-169118252-1");
    pageTracker._trackPageview();
    } catch(err) {}</script>
</body>
</html>