<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Tprrt's Blog | articles tagged "intermediate"</title>
    <link rel="shortcut icon" type="image/png" href="https://tprrt.tupi.fr/favicon.png">
    <link rel="shortcut icon" type="image/x-icon" href="https://tprrt.tupi.fr/favicon.ico">
    <link href="/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Tprrt's Blog Full Atom Feed" />
    <link href="/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="Tprrt's Blog Full RSS Feed" />
    <link rel="stylesheet" href="https://tprrt.tupi.fr/theme/css/screen.css" type="text/css" />
    <link rel="stylesheet" href="https://tprrt.tupi.fr/theme/css/pygments.css" type="text/css" />
    <link rel="stylesheet" href="https://tprrt.tupi.fr/theme/css/print.css" type="text/css" media="print" />
    <meta name="generator" content="Pelican" />
    <meta name="description" content="" />
    <meta name="author" content="Thomas Perrot" />

    <script data-ad-client="ca-pub-8632147971669760"
            async="async"
            src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"
            integrity="sha256-H0yTZ/g80w4995dyBRDArJlCXWcYuBANtPbA82uyu00="
            crossorigin="anonymous">
    </script>
</head>
<body>
    <header>
        <nav>
            <ul>
                <li class="ephemeral selected"><a href="https://tprrt.tupi.fr/tag/intermediate.html">intermediate</a></li>
                <li><a href="https://tprrt.tupi.fr/">Home</a></li>
                <li><a href="https://tprrt.tupi.fr/contributions">Contributions</a></li>
                <li><a href="https://tprrt.tupi.fr/archives">Archives</a></li>
                <li><a href="https://tprrt.tupi.fr/categories">Categories</a></li>
                <li><a href="https://tprrt.tupi.fr/contact">Contact</a></li>
            </ul>
        </nav>
        <div class="header_box">
            <h1><a href="https://tprrt.tupi.fr/">Tprrt's Blog</a></h1>
            <h2>Yet another blog about embedded Linux, the open source and hardware</h2>
        </div>
    </header>
    <div id="wrapper">
        <div id="content">            <h4 class="date">Jun 27, 2020</h4>

            <article class="post">
                <h2 class="title">
                    <a href="https://tprrt.tupi.fr/build-an-embedded-linux-in-fifteen-min.html" rel="bookmark" title="Permanent Link to &quot;Build an embedded Linux in less than 15 minutes&quot;">Build an embedded Linux in less than 15 minutes</a>
                </h2>

                
                

                <div class="section" id="introduction">
<h2>Introduction</h2>
<p>Since some years, I haven't built an embedded Linux without using a framework, like <a class="reference external" href="https://openembedded.org">Open Embedded</a> from the <a class="reference external" href="https://yoctoproject.org">Yocto</a>
project.
Then here, I wanted to make a guide to help you to build quickly, from &quot;scratch&quot; a very minimal embedded Linux to boot a
target.
The following examples have been written to boot a virtual Qemu target but, they can be adapted to boot a real target.
Moreover, the build environment will be bootstrapped with a prebuilt cross-toolchain, I have chosen to use one provided
by <a class="reference external" href="https://toolchains.bootlin.com">Bootlin</a> and using glibc.</p>
</div>
<div class="section" id="setup-the-environment">
<h2>Setup the environment</h2>
<p>First, it is required to install the packages that are needed to install and use the cross-toolchain but also to compile the host tools and to provide Qemu:</p>
<ul class="simple">
<li>The Ncurses libraries are only required to execute the command <cite>make menuconfig</cite>.</li>
<li>The certificates and wget will be used to download the prebuilt toolchain.</li>
<li>In the same way, git will be used to checkout the source of <a class="reference external" href="https://busybox.net">Busybox</a> and <a class="reference external" href="https://www.kernel.org">Linux</a>.</li>
<li>The Qemu packages will be used to emulate system platform and to execute static binaries cross-compiled for aarch64 on the x86-64 host.</li>
</ul>
<div class="highlight"><pre><span></span>apt<span class="w"> </span>update
apt<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>--no-install-recommends<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>bc<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>build-essential<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>ca-certificates<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>cpio<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>file<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>flex<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>git<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>ipxe-qemu<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>libncurses5-dev<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>libncursesw5-dev<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>libssl-dev<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>qemu<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>qemu-system-aarch64<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>qemu-user-static<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>wget
</pre></div>
<p>Now, it is time to download and install the prebuilt toolchain:</p>
<div class="highlight"><pre><span></span>mkdir<span class="w"> </span>~/src
<span class="nb">cd</span><span class="w"> </span>~/src
wget<span class="w"> </span>https://toolchains.bootlin.com/downloads/releases/toolchains/aarch64/tarballs/aarch64--glibc--stable-2020.08-1.tar.bz2
tar<span class="w"> </span>xvjf<span class="w"> </span>aarch64--glibc--stable-2020.08-1.tar.bz2
</pre></div>
<p>Once the toolchain has been extracted you have to set the required environment variables to cross-compile binaries:</p>
<ul class="simple">
<li><tt class="docutils literal">PATH</tt>: It shall be extended so that the cross-tools from the cross-toolchain will be available from the environment</li>
<li><tt class="docutils literal">CROSS_COMPILE</tt>: In order to clarify the prefix used by the cross-tools</li>
<li><tt class="docutils literal">ARCH</tt>: The architecture of the target platform</li>
</ul>
<div class="highlight"><pre><span></span>ls<span class="w"> </span>~/src/aarch64--glibc--stable-2020.08-1/bin/*gcc
~/src/aarch64--glibc--stable-2020.08-1/bin/aarch64-linux-gcc

<span class="nb">export</span><span class="w"> </span><span class="nv">PATH</span><span class="o">=</span>~/src/aarch64--glibc--stable-2020.08-1/bin:<span class="nv">$PATH</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">CROSS_COMPILE</span><span class="o">=</span>aarch64-linux-
</pre></div>
<p>Now, it is possible to call the cross-tools from the shell:</p>
<div class="highlight"><pre><span></span>aarch64-linux-gcc<span class="w"> </span>-v
Using<span class="w"> </span>built-in<span class="w"> </span>specs.
<span class="nv">COLLECT_GCC</span><span class="o">=</span>~/src/aarch64--glibc--stable-2020.08-1/bin/aarch64-linux-gcc.br_real
<span class="nv">COLLECT_LTO_WRAPPER</span><span class="o">=</span>~/src/aarch64--glibc--stable-2020.08-1/bin/../libexec/gcc/aarch64-buildroot-linux-gnu/9.3.0/lto-wrapper
Target:<span class="w"> </span>aarch64-buildroot-linux-gnu
&lt;...&gt;
Thread<span class="w"> </span>model:<span class="w"> </span>posix
gcc<span class="w"> </span>version<span class="w"> </span><span class="m">9</span>.3.0<span class="w"> </span><span class="o">(</span>Buildroot<span class="w"> </span><span class="m">2020</span>.08-14-ge5a2a90<span class="o">)</span>
</pre></div>
<p>Concerning the variable <tt class="docutils literal">PATH</tt> this one will be set afterwards because its value depends on the binary that will be built.</p>
</div>
<div class="section" id="build-the-linux-kernel">
<h2>Build the Linux kernel</h2>
<p>So, the environment is ready to pull the sources of the latest stable branch of the kernel <a class="reference external" href="https://www.kernel.org">Linux</a> and to build them:</p>
<div class="highlight"><pre><span></span>git<span class="w"> </span>clone<span class="w"> </span>git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git
<span class="nb">cd</span><span class="w"> </span>linux
git<span class="w"> </span>checkout<span class="w"> </span>-b<span class="w"> </span>local/linux-5.4.y<span class="w"> </span>origin/linux-5.4.y
<span class="c1"># git show HEAD</span>

<span class="nb">export</span><span class="w"> </span><span class="nv">ARCH</span><span class="o">=</span>arm64

make<span class="w"> </span>defconfig
<span class="w">  </span>HOSTCC<span class="w">  </span>scripts/basic/fixdep
<span class="w">  </span>HOSTCC<span class="w">  </span>scripts/kconfig/conf.o
<span class="w">  </span>HOSTCC<span class="w">  </span>scripts/kconfig/confdata.o
<span class="w">  </span>HOSTCC<span class="w">  </span>scripts/kconfig/expr.o
<span class="w">  </span>LEX<span class="w">     </span>scripts/kconfig/lexer.lex.c
<span class="w">  </span>YACC<span class="w">    </span>scripts/kconfig/parser.tab.<span class="o">[</span>ch<span class="o">]</span>
<span class="w">  </span>HOSTCC<span class="w">  </span>scripts/kconfig/lexer.lex.o
<span class="w">  </span>HOSTCC<span class="w">  </span>scripts/kconfig/parser.tab.o
<span class="w">  </span>HOSTCC<span class="w">  </span>scripts/kconfig/preprocess.o
<span class="w">  </span>HOSTCC<span class="w">  </span>scripts/kconfig/symbol.o
<span class="w">  </span>HOSTLD<span class="w">  </span>scripts/kconfig/conf
***<span class="w"> </span>Default<span class="w"> </span>configuration<span class="w"> </span>is<span class="w"> </span>based<span class="w"> </span>on<span class="w"> </span><span class="s1">&#39;defconfig&#39;</span>
<span class="c1">#</span>
<span class="c1"># configuration written to .config</span>
<span class="c1">#</span>

<span class="c1"># make menuconfig</span>

make<span class="w"> </span>-j<span class="k">$(</span>nproc<span class="k">)</span>
<span class="w">  </span>&lt;...&gt;
<span class="w">  </span>AR<span class="w">      </span>drivers/net/ethernet/built-in.a
<span class="w">  </span>AR<span class="w">      </span>drivers/net/built-in.a
<span class="w">  </span>AR<span class="w">      </span>drivers/built-in.a
<span class="w">  </span>GEN<span class="w">     </span>.version
<span class="w">  </span>CHK<span class="w">     </span>include/generated/compile.h
<span class="w">  </span>LD<span class="w">      </span>vmlinux.o
<span class="w">  </span>MODPOST<span class="w"> </span>vmlinux.o
<span class="w">  </span>MODINFO<span class="w"> </span>modules.builtin.modinfo
<span class="w">  </span>LD<span class="w">      </span>.tmp_vmlinux.kallsyms1
<span class="w">  </span>KSYM<span class="w">    </span>.tmp_vmlinux.kallsyms1.o
<span class="w">  </span>LD<span class="w">      </span>.tmp_vmlinux.kallsyms2
<span class="w">  </span>KSYM<span class="w">    </span>.tmp_vmlinux.kallsyms2.o
<span class="w">  </span>LD<span class="w">      </span>vmlinux
<span class="w">  </span>SORTEX<span class="w">  </span>vmlinux
<span class="w">  </span>SYSMAP<span class="w">  </span>System.map
<span class="w">  </span>Building<span class="w"> </span>modules,<span class="w"> </span>stage<span class="w"> </span><span class="m">2</span>.
<span class="w">  </span>MODPOST<span class="w"> </span><span class="m">531</span><span class="w"> </span>modules
<span class="w">  </span>OBJCOPY<span class="w"> </span>arch/arm64/boot/Image
<span class="w">  </span>GZIP<span class="w">    </span>arch/arm64/boot/Image.gz
</pre></div>
<p>The command <tt class="docutils literal">make defconfig</tt> will apply the default configuration for the target platform (cf. <tt class="docutils literal">ARCH=arm64</tt>), and the
compilation will be performed by <tt class="docutils literal">make <span class="pre">-j$(nproc)</span></tt>.</p>
<p>The commands <tt class="docutils literal">git show HEAD</tt> and <tt class="docutils literal">make defconfig</tt> are optional:
- the first is useful to verify that the latest commit corresponding to the latest tag of the branch <tt class="docutils literal"><span class="pre">linux-5.4.y</span></tt>.
- the second can be used if you want to customize the kernel configuration.</p>
<p><em>NB</em>. The kernel <a class="reference external" href="https://www.kernel.org">Linux</a> but also <a class="reference external" href="https://busybox.net">Busybox</a> and some projects use <a class="reference external" href="https://www.kernel.org/doc/html/latest/kbuild/kbuild.html">Kbuild</a> to manage the build options</p>
</div>
<div class="section" id="populate-the-sysroot">
<h2>Populate the sysroot</h2>
<p>The easy way to bootstrap a sysroot is to use <a class="reference external" href="https://busybox.net">Busybox</a> that has been created to offer common UNIX tools into a single
executable and it is size-optimized. To create a sysroot, it is only required to add a few configuration files.</p>
<p>The steps to pull and build <a class="reference external" href="https://busybox.net">Busybox</a> are similar to those of the kernel <a class="reference external" href="https://www.kernel.org">Linux</a>.</p>
<div class="highlight"><pre><span></span>git<span class="w"> </span>clone<span class="w"> </span>git://git.busybox.net/busybox
<span class="nb">cd</span><span class="w"> </span>busybox
git<span class="w"> </span>checkout<span class="w"> </span>-b<span class="w"> </span>local/1_32_stable<span class="w"> </span>origin/1_32_stable
<span class="c1"># git show HEAD</span>

<span class="nb">export</span><span class="w"> </span><span class="nv">ARCH</span><span class="o">=</span>aarch64
<span class="nb">export</span><span class="w"> </span><span class="nv">LDFLAGS</span><span class="o">=</span><span class="s2">&quot;--static&quot;</span>

make<span class="w"> </span>defconfig
<span class="c1"># make menuconfig</span>
make<span class="w"> </span>-j<span class="k">$(</span>nproc<span class="k">)</span>

make<span class="w"> </span>install
</pre></div>
<p>Here, the <em>LDFLAGS</em> is set to force static linking of <a class="reference external" href="https://busybox.net">Busybox</a> quickly, but it is also possible to use
<em>make menuconfig</em> to set <em>CONFIG_STATIC=y</em>. The advantage of the static executable is that it can be tested with Qemu:</p>
<div class="highlight"><pre><span></span>qemu-aarch64-static<span class="w"> </span>busybox<span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Hello!&quot;</span>
Hello!
qemu-aarch64-static<span class="w"> </span>busybox<span class="w"> </span>date
Sat<span class="w"> </span>Jun<span class="w"> </span><span class="m">27</span><span class="w"> </span><span class="m">15</span>:06:41<span class="w"> </span>UTC<span class="w"> </span><span class="m">2020</span>
</pre></div>
<p>The binary <em>qemu-aarch64-static</em> allows to execute a binary built for another architecture on the host computer, for
example here it allows to execute the <a class="reference external" href="https://busybox.net">Busybox</a> binary compiled for an aarch64 target on a x86-64 host.</p>
<p>The last command <em>make install</em> created a tree into the <em>_install</em> directory that can be used to populate the sysroot:</p>
<div class="highlight"><pre><span></span>ls<span class="w"> </span>-l<span class="w"> </span>_install
total<span class="w"> </span><span class="m">4</span>
drwxr-xr-x.<span class="w"> </span><span class="m">1</span><span class="w"> </span>tperrot<span class="w"> </span>tperrot<span class="w"> </span><span class="m">974</span><span class="w"> </span>Nov<span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="m">15</span>:22<span class="w"> </span>bin
lrwxrwxrwx.<span class="w"> </span><span class="m">1</span><span class="w"> </span>tperrot<span class="w"> </span>tperrot<span class="w">  </span><span class="m">11</span><span class="w"> </span>Nov<span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="m">15</span>:22<span class="w"> </span>linuxrc<span class="w"> </span>-&gt;<span class="w"> </span>bin/busybox
drwxr-xr-x.<span class="w"> </span><span class="m">1</span><span class="w"> </span>tperrot<span class="w"> </span>tperrot<span class="w"> </span><span class="m">986</span><span class="w"> </span>Nov<span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="m">15</span>:22<span class="w"> </span>sbin
drwxr-xr-x.<span class="w"> </span><span class="m">1</span><span class="w"> </span>tperrot<span class="w"> </span>tperrot<span class="w">  </span><span class="m">14</span><span class="w"> </span>Nov<span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="m">15</span>:22<span class="w"> </span>usr

ls<span class="w"> </span>-l<span class="w"> </span>_install/bin
&lt;...&gt;
lrwxrwxrwx.<span class="w"> </span><span class="m">1</span><span class="w"> </span>tperrot<span class="w"> </span>tperrot<span class="w">       </span><span class="m">7</span><span class="w"> </span>Nov<span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="m">15</span>:22<span class="w"> </span>umount<span class="w"> </span>-&gt;<span class="w"> </span>busybox
lrwxrwxrwx.<span class="w"> </span><span class="m">1</span><span class="w"> </span>tperrot<span class="w"> </span>tperrot<span class="w">       </span><span class="m">7</span><span class="w"> </span>Nov<span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="m">15</span>:22<span class="w"> </span>uname<span class="w"> </span>-&gt;<span class="w"> </span>busybox
lrwxrwxrwx.<span class="w"> </span><span class="m">1</span><span class="w"> </span>tperrot<span class="w"> </span>tperrot<span class="w">       </span><span class="m">7</span><span class="w"> </span>Nov<span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="m">15</span>:22<span class="w"> </span>usleep<span class="w"> </span>-&gt;<span class="w"> </span>busybox
lrwxrwxrwx.<span class="w"> </span><span class="m">1</span><span class="w"> </span>tperrot<span class="w"> </span>tperrot<span class="w">       </span><span class="m">7</span><span class="w"> </span>Nov<span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="m">15</span>:22<span class="w"> </span>vi<span class="w"> </span>-&gt;<span class="w"> </span>busybox
lrwxrwxrwx.<span class="w"> </span><span class="m">1</span><span class="w"> </span>tperrot<span class="w"> </span>tperrot<span class="w">       </span><span class="m">7</span><span class="w"> </span>Nov<span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="m">15</span>:22<span class="w"> </span>watch<span class="w"> </span>-&gt;<span class="w"> </span>busybox
lrwxrwxrwx.<span class="w"> </span><span class="m">1</span><span class="w"> </span>tperrot<span class="w"> </span>tperrot<span class="w">       </span><span class="m">7</span><span class="w"> </span>Nov<span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="m">15</span>:22<span class="w"> </span>zcat<span class="w"> </span>-&gt;<span class="w"> </span>busybox
</pre></div>
<p>In order, to finalize this minimal sysroot, it is required to create a rcS init script:</p>
<div class="highlight"><pre><span></span>mkdir<span class="w"> </span>_install/proc<span class="w"> </span>_install/sys<span class="w"> </span>_install/dev<span class="w"> </span>_install/etc<span class="w"> </span>_install/etc/init.d
cat<span class="w"> </span>&gt;<span class="w"> </span>_install/etc/init.d/rcS<span class="w"> </span><span class="s">&lt;&lt; EOF</span>
<span class="s">#!/bin/sh</span>
<span class="s">mount -t proc none /proc</span>
<span class="s">mount -t sysfs none /sys</span>
<span class="s">/sbin/mdev -s</span>
<span class="s">[ ! -h /etc/mtab ]  &amp;&amp; ln -s /proc/mounts /etc/mtab</span>
<span class="s">[ ! -f /etc/resolv.conf ] &amp;&amp; cat /proc/net/pnp &gt; /etc/resolv.conf</span>
<span class="s">EOF</span>
chmod<span class="w"> </span>+x<span class="w"> </span>_install/etc/init.d/rcS
</pre></div>
</div>
<div class="section" id="build-the-filesystem">
<h2>Build the filesystem</h2>
<p>The target of this step is to package the sysroot tree into a filesystem that can be mounted by the kernel.
There is two available possibilities, either build a <em>ramfs</em> or a <em>rootfs</em>.</p>
<p>Globally, the difference between both is that:</p>
<ul class="simple">
<li>the ramfs is a very simple filesystem that can be used by the kernel to create a block device into the RAM space from an archive.</li>
<li>the rootfs is a filesystem mounted from a non volatile device by the kernel.</li>
</ul>
<p>For more information about the difference between the ramfs and the rootfs, you can you refer to the <a class="reference external" href="https://www.kernel.org/doc/html/latest/filesystems/ramfs-rootfs-initramfs.html">kernel documentation</a>.</p>
<div class="section" id="build-a-ramfs">
<h3>Build a ramfs</h3>
<p>To build the ramfs we will use <em>cpio</em> and <em>gzip</em> to construct the compressed archive after modifying the rights:</p>
<div class="highlight"><pre><span></span>mkdir<span class="w"> </span>_rootfs
rsync<span class="w"> </span>-a<span class="w"> </span>_install/<span class="w"> </span>_rootfs
chown<span class="w"> </span>-R<span class="w"> </span>root:root<span class="w"> </span>_rootfs
<span class="nb">cd</span><span class="w"> </span>_rootfs
find<span class="w"> </span>.<span class="w"> </span><span class="p">|</span><span class="w"> </span>cpio<span class="w"> </span>-o<span class="w"> </span>--format<span class="o">=</span>newc<span class="w"> </span>&gt;<span class="w"> </span>../rootfs.cpio
<span class="nb">cd</span><span class="w"> </span>..
gzip<span class="w"> </span>-c<span class="w"> </span>rootfs.cpio<span class="w"> </span>&gt;<span class="w"> </span>rootfs.cpio.gz
</pre></div>
</div>
<div class="section" id="build-a-rootfs">
<h3>Build a rootfs</h3>
<p>To build the rootfs, the first step is to create an empty binary blob that will be mounted into a loop device to be
formatted to create a ext3 filesystem. Then the tree can be copied and the rights updated.</p>
<div class="highlight"><pre><span></span>dd<span class="w"> </span><span class="k">if</span><span class="o">=</span>/dev/zero<span class="w"> </span><span class="nv">of</span><span class="o">=</span>rootfs.img<span class="w"> </span><span class="nv">bs</span><span class="o">=</span>1M<span class="w"> </span><span class="nv">count</span><span class="o">=</span><span class="m">10</span>
mke2fs<span class="w"> </span>-j<span class="w"> </span>rootfs.img
mkdir<span class="w"> </span>_rootfs
mount<span class="w"> </span>-o<span class="w"> </span>loop<span class="w"> </span>rootfs.img<span class="w"> </span>_rootfs
rsync<span class="w"> </span>-a<span class="w"> </span>_install/<span class="w"> </span>_rootfs
chown<span class="w"> </span>-R<span class="w"> </span>root:root<span class="w"> </span>_rootfs
sync
umount<span class="w"> </span>_rootfs
</pre></div>
</div>
</div>
<div class="section" id="boot-the-target">
<h2>Boot the target</h2>
<p>Following, the qemu commands to boot the minimal embedded Linux system that has been built.</p>
<div class="highlight"><pre><span></span><span class="c1"># With the ramfs</span>
qemu-system-aarch64<span class="w"> </span>-nographic<span class="w"> </span>-no-reboot<span class="w"> </span>-machine<span class="w"> </span>virt<span class="w"> </span>-cpu<span class="w"> </span>cortex-a57<span class="w"> </span>-smp<span class="w"> </span><span class="m">2</span><span class="w"> </span>-m<span class="w"> </span><span class="m">256</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-kernel<span class="w"> </span>~/src/linux/arch/arm64/boot/Image<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-initrd<span class="w"> </span>~/src/busybox/rootfs.cpio.gz<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-append<span class="w"> </span><span class="s2">&quot;panic=5 ro ip=dhcp root=/dev/ram rdinit=/sbin/init&quot;</span>

<span class="c1"># With the rootfs</span>
qemu-system-aarch64<span class="w"> </span>-nographic<span class="w"> </span>-no-reboot<span class="w"> </span>-machine<span class="w"> </span>virt<span class="w"> </span>-cpu<span class="w"> </span>cortex-a57<span class="w"> </span>-smp<span class="w"> </span><span class="m">2</span><span class="w"> </span>-m<span class="w"> </span><span class="m">256</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-kernel<span class="w"> </span>~/src/linux/arch/arm64/boot/Image<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-append<span class="w"> </span><span class="s2">&quot;panic=5 ro ip=dhcp root=/dev/vda&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-drive<span class="w"> </span><span class="nv">file</span><span class="o">=</span>~/src/busybox/rootfs.img,format<span class="o">=</span>raw,if<span class="o">=</span>none,id<span class="o">=</span>hd0<span class="w"> </span>-device<span class="w"> </span>virtio-blk-device,drive<span class="o">=</span>hd0
</pre></div>
<p>Then the target will be boot to shell, <em>&quot;It's alive!&quot;</em>:</p>
<div class="highlight"><pre><span></span><span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w"> </span>Booting<span class="w"> </span>Linux<span class="w"> </span>on<span class="w"> </span>physical<span class="w"> </span>CPU<span class="w"> </span>0x0000000000<span class="w"> </span><span class="o">[</span>0x411fd070<span class="o">]</span>
<span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w"> </span>Linux<span class="w"> </span>version<span class="w"> </span><span class="m">5</span>.10.0-rc5<span class="w"> </span><span class="o">(</span>tperrot@27ea4a863f61<span class="o">)</span><span class="w"> </span><span class="o">(</span>aarch64-linux-gcc.br_real<span class="w"> </span><span class="o">(</span>Buildroot<span class="w"> </span><span class="m">2020</span>.08-14-ge5a2a90<span class="o">)</span><span class="w"> </span><span class="m">9</span>.3.0,<span class="w"> </span>GNU<span class="w"> </span>ld<span class="w"> </span><span class="o">(</span>GNU<span class="w"> </span>Binutils<span class="o">)</span><span class="w"> </span><span class="m">2</span>.33.1<span class="o">)</span><span class="w"> </span><span class="c1">#1 SMP PREEMPT Mon Nov 30 14:40:05 UTC 2020</span>
<span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w"> </span>Machine<span class="w"> </span>model:<span class="w"> </span>linux,dummy-virt
&lt;...&gt;
<span class="o">[</span><span class="w">    </span><span class="m">0</span>.858346<span class="o">]</span><span class="w"> </span>Sending<span class="w"> </span>DHCP<span class="w"> </span>requests<span class="w"> </span>.,<span class="w"> </span>OK
<span class="o">[</span><span class="w">    </span><span class="m">0</span>.870558<span class="o">]</span><span class="w"> </span>IP-Config:<span class="w"> </span>Got<span class="w"> </span>DHCP<span class="w"> </span>answer<span class="w"> </span>from<span class="w"> </span><span class="m">10</span>.0.2.2,<span class="w"> </span>my<span class="w"> </span>address<span class="w"> </span>is<span class="w"> </span><span class="m">10</span>.0.2.15
<span class="o">[</span><span class="w">    </span><span class="m">0</span>.870909<span class="o">]</span><span class="w"> </span>IP-Config:<span class="w"> </span>Complete:
<span class="o">[</span><span class="w">    </span><span class="m">0</span>.871199<span class="o">]</span><span class="w">      </span><span class="nv">device</span><span class="o">=</span>eth0,<span class="w"> </span><span class="nv">hwaddr</span><span class="o">=</span><span class="m">52</span>:54:00:12:34:56,<span class="w"> </span><span class="nv">ipaddr</span><span class="o">=</span><span class="m">10</span>.0.2.15,<span class="w"> </span><span class="nv">mask</span><span class="o">=</span><span class="m">255</span>.255.255.0,<span class="w"> </span><span class="nv">gw</span><span class="o">=</span><span class="m">10</span>.0.2.2
<span class="o">[</span><span class="w">    </span><span class="m">0</span>.871566<span class="o">]</span><span class="w">      </span><span class="nv">host</span><span class="o">=</span><span class="m">10</span>.0.2.15,<span class="w"> </span><span class="nv">domain</span><span class="o">=</span>,<span class="w"> </span>nis-domain<span class="o">=(</span>none<span class="o">)</span>
<span class="o">[</span><span class="w">    </span><span class="m">0</span>.871825<span class="o">]</span><span class="w">      </span><span class="nv">bootserver</span><span class="o">=</span><span class="m">10</span>.0.2.2,<span class="w"> </span><span class="nv">rootserver</span><span class="o">=</span><span class="m">10</span>.0.2.2,<span class="w"> </span><span class="nv">rootpath</span><span class="o">=</span>
<span class="o">[</span><span class="w">    </span><span class="m">0</span>.871866<span class="o">]</span><span class="w">      </span><span class="nv">nameserver0</span><span class="o">=</span><span class="m">10</span>.0.2.3
<span class="o">[</span><span class="w">    </span><span class="m">0</span>.872389<span class="o">]</span>
<span class="o">[</span><span class="w">    </span><span class="m">0</span>.875863<span class="o">]</span><span class="w"> </span>ALSA<span class="w"> </span>device<span class="w"> </span>list:
<span class="o">[</span><span class="w">    </span><span class="m">0</span>.876151<span class="o">]</span><span class="w">   </span>No<span class="w"> </span>soundcards<span class="w"> </span>found.
<span class="o">[</span><span class="w">    </span><span class="m">0</span>.879353<span class="o">]</span><span class="w"> </span>uart-pl011<span class="w"> </span><span class="m">9000000</span>.pl011:<span class="w"> </span>no<span class="w"> </span>DMA<span class="w"> </span>platform<span class="w"> </span>data
<span class="o">[</span><span class="w">    </span><span class="m">0</span>.920237<span class="o">]</span><span class="w"> </span>Freeing<span class="w"> </span>unused<span class="w"> </span>kernel<span class="w"> </span>memory:<span class="w"> </span>5952K
<span class="o">[</span><span class="w">    </span><span class="m">0</span>.921223<span class="o">]</span><span class="w"> </span>Run<span class="w"> </span>/sbin/init<span class="w"> </span>as<span class="w"> </span>init<span class="w"> </span>process

Please<span class="w"> </span>press<span class="w"> </span>Enter<span class="w"> </span>to<span class="w"> </span>activate<span class="w"> </span>this<span class="w"> </span>console.
</pre></div>
</div>

                <div class="clear"></div>

                <div class="info">
                    <a href="https://tprrt.tupi.fr/build-an-embedded-linux-in-fifteen-min.html">posted at 13:01</a>
                    &nbsp;&middot;&nbsp;<a href="https://tprrt.tupi.fr/category/linux.html" rel="tag">linux</a>
                    &nbsp;&middot;
                    &nbsp;<a href="https://tprrt.tupi.fr/tag/busybox.html" class="tags">busybox</a>
                    &nbsp;<a href="https://tprrt.tupi.fr/tag/embedded.html" class="tags">embedded</a>
                    &nbsp;<a href="https://tprrt.tupi.fr/tag/intermediate.html" class="tags selected">intermediate</a>
                    &nbsp;<a href="https://tprrt.tupi.fr/tag/linux.html" class="tags">linux</a>
                    &nbsp;<a href="https://tprrt.tupi.fr/tag/qemu.html" class="tags">qemu</a>
                </div>
            </article>

            <div class="clear"></div>
            <footer>
                <p>
                <a href="https://github.com/jody-frankowski/blue-penguin">Blue Penguin</a> Theme
                &middot;
                Powered by <a href="http://getpelican.com">Pelican</a>
                &middot;
                <a href="https://tprrt.tupi.fr/feeds/all.atom.xml" rel="alternate">Atom Feed</a>
                &middot;
                <a href="https://tprrt.tupi.fr/feeds/all.rss.xml" rel="alternate">Rss Feed</a>
            </footer>
        </div>
        <div class="clear"></div>
    </div>
    <script type="text/javascript">
    var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
    document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
    try {
        var pageTracker = _gat._getTracker("UA-169118252-1");
    pageTracker._trackPageview();
    } catch(err) {}</script>
</body>
</html>