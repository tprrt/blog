<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Tprrt's Blog | articles tagged "embedded"</title>
    <link rel="shortcut icon" type="image/png" href="https://tprrt.tupi.fr/favicon.png">
    <link rel="shortcut icon" type="image/x-icon" href="https://tprrt.tupi.fr/favicon.ico">
    <link href="/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Tprrt's Blog Full Atom Feed" />
    <link href="/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="Tprrt's Blog Full RSS Feed" />
    <link rel="stylesheet" href="https://tprrt.tupi.fr/theme/css/screen.css" type="text/css" />
    <link rel="stylesheet" href="https://tprrt.tupi.fr/theme/css/pygments.css" type="text/css" />
    <link rel="stylesheet" href="https://tprrt.tupi.fr/theme/css/print.css" type="text/css" media="print" />
    <meta name="generator" content="Pelican" />
    <meta name="description" content="" />
    <meta name="author" content="Thomas Perrot" />

    <script data-ad-client="ca-pub-8632147971669760"
            async="async"
            src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"
            integrity="sha256-H0yTZ/g80w4995dyBRDArJlCXWcYuBANtPbA82uyu00="
            crossorigin="anonymous">
    </script>
<style>
    footer .license-info {
        margin-top: 0.5em;
        font-size: 0.9em;
    }
</style>
<script>
// Add license information to footer
document.addEventListener('DOMContentLoaded', function() {
    var footer = document.querySelector('footer p');
    if (footer) {
        var licenseInfo = document.createElement('p');
        licenseInfo.className = 'license-info';
        licenseInfo.innerHTML = 'Content licensed under <a href="https://creativecommons.org/licenses/by-sa/4.0/" rel="license">CC BY-SA 4.0</a> &middot; Code licensed under <a href="https://www.gnu.org/licenses/gpl-3.0.html">GPLv3</a>';
        footer.parentNode.appendChild(licenseInfo);
    }
});
</script>
</head>
<body>
    <header>
        <nav>
            <ul>
                <li class="ephemeral selected"><a href="https://tprrt.tupi.fr/tag/embedded.html">embedded</a></li>
                <li><a href="https://tprrt.tupi.fr/">Home</a></li>
                <li><a href="https://tprrt.tupi.fr/contributions">Contributions</a></li>
                <li><a href="https://tprrt.tupi.fr/archives">Archives</a></li>
                <li><a href="https://tprrt.tupi.fr/categories">Categories</a></li>
                <li><a href="https://tprrt.tupi.fr/contact">Contact</a></li>
            </ul>
        </nav>
        <div class="header_box">
            <h1><a href="https://tprrt.tupi.fr/">Tprrt's Blog</a></h1>
            <h2>Yet another blog about embedded Linux, the open source and hardware</h2>
        </div>
    </header>
    <div id="wrapper">
        <div id="content">            <h4 class="date">Aug 06, 2024</h4>

            <article class="post">
                <h2 class="title">
                    <a href="https://tprrt.tupi.fr/secure-boot-with-ahab-on-imx93.html" rel="bookmark" title="Permanent Link to &quot;Secure Boot with AHAB on i.MX93: A Complete Guide&quot;">Secure Boot with AHAB on i.MX93: A Complete Guide</a>
                </h2>

                
                

                <p><strong>The security of embedded devices has never been more critical.</strong> In a world
where attacks targeting IoT systems are becoming increasingly sophisticated,
ensuring the integrity of the boot process is a must. This is where <strong>Secure
Boot</strong> comes inâ€”an essential technology that guarantees only authorized code can
execute on a device from the moment it starts. In this article, we will explore
the implementation of Secure Boot using AHAB, the solution provided by NXP to
secure the i.MX93 from its initial boot stages.</p>
<p><strong>Why is Secure Boot crucial for your device?</strong></p>
<p>A secure boot ensures that no malicious code interferes with the critical boot
process, protecting your device from attacks targeting the bootloader and early
boot stages. Furthermore, AHAB, integrated into i.MX93 processors, enables
advanced authentication right from the initial boot stages, ensuring that only
validated components can be loaded, thereby strengthening security from the
get-go.</p>
<p>Secure boot is a critical security feature that ensures only authenticated and
authorized code can run on a device. It operates through a chain of trust, where
each component verifies the integrity of the next element in the chain.</p>
<p>Several mechanisms must be used to authenticate each element of this chain, but
the mechanism for authenticating the first boot stages depends on the target SoC.
The i.MX93 series uses NXP's Advanced High Assurance Boot (AHAB) to secure the
first boot stages.</p>
<p>For subsequent stages, you can implement mechanisms such as:</p>
<ul class="simple">
<li>Using U-Boot's &quot;verified boot&quot; feature to sign the kernel,</li>
<li>Using the default environment (cf. USE_DEFAULT_ENV_FILE), and restricting
write access to only a few environment variables (cf. ENV_WRITEABLE_LIST),
which are necessary for writable access, such as for OTA updates,</li>
<li>Using DM-verity to authenticate the root filesystem,</li>
<li>And finally, using OverlayFS combined with DM-crypt to mount encrypted,
writable subfolders.</li>
</ul>
<p>Here, we'll focus on the first part of the secure boot process, using NXP's AHAB
to authenticate the bootloader on the NXP i.MX93 in single-boot mode. We will
also briefly discuss how to generate the keys to sign the bootloader and provide
an introduction to AHAB.</p>
<p><em>Note: AHAB also provides a complementary encryption feature designed to protect
the confidentiality and integrity of data, whereas secure boot focuses on
verifying the integrity and authenticity of the boot process. This post will not
cover encryption in detail.</em></p>
<div class="section" id="ahab-architecture">
<h2>AHAB Architecture</h2>
<p>The AHAB authentication mechanism is based on public key cryptography using
asymmetric keys.</p>
<p>On the i.MX93, AHAB support is provided by a security co-processor, the EdgeLock
enclave (ELE), which handles the authentication of binaries signed with one or
more private keys. This co-processor contains fuses that must be burned with the
hash of the public keys.</p>
<div class="section" id="ahab-containers">
<h3>AHAB Containers</h3>
<p>Since multiple boot stages (e.g., TF-A, OP-TEE, U-Boot, etc.) and firmwares are
required to boot i.MX93 platforms, these binaries are packed into containers
using the <a class="reference external" href="https://github.com/nxp-imx/imx-mkimage">imx-mkimage</a> tool:</p>
<div class="highlight"><pre><span></span>bl31.bin
lpddr4_dmem_1d_v202201.bin
lpddr4_dmem_2d_v202201.bin
lpddr4_imem_1d_v202201.bin
lpddr4_imem_2d_v202201.bin
mx93a1-ahab-container.img
tee.bin
u-boot.bin
u-boot-spl.bin
</pre></div>
<p>In i.MX93 single-boot mode, the bootloader image contains at least three
containers:</p>
<ul class="simple">
<li><strong>mx93a1-ahab-container.img</strong>: Contains the ELE Firmware.</li>
<li><strong>u-boot-atf-container.img</strong>: Contains at least the SPL.</li>
<li><strong>flash.bin</strong>: Contains TF-A, OP-TEE, and U-Boot.</li>
</ul>
<div class="highlight"><pre><span></span>        *start ----&gt; +---------------------------+ ---------
                     |   1st Container header    |   ^
                     |       and signature       |   |
                     +---------------------------+   |
                     | Padding for 1kB alignment |   |
*start + 0x400 ----&gt; +---------------------------+   |
                     |   2nd Container header    |   |
                     |       and signature       |   |
                     +---------------------------+   |
                     |          Padding          |   |  Authenticated at
                     +---------------------------+   |  ELE ROM/FW Level
                     |           ELE FW          |   |
                     +---------------------------+   |
                     |          Padding          |   |
                     +---------------------------+   |
                     |       Cortex-M Image      |   |
                     +---------------------------+   |
                     |         SPL Image         |   v
                     +---------------------------+ ---------
                     |   3rd Container header    |   ^
                     |       and signature       |   |
                     +---------------------------+   |
                     |          Padding          |   | Authenticated
                     +---------------------------+   | at SPL Level
                     |            TF-A           |   |
                     +---------------------------+   |
                     |           OP-TEE          |   |
                     +---------------------------+   |
                     |           U-Boot          |   v
                     +---------------------------+ ---------
</pre></div>
<p>These containers are signed offline using <a class="reference external" href="https://www.nxp.com/webapp/sps/download/license.jsp?colCode=IMX_CST_TOOL_NEW">NXP Code-Signing Tools (CST)</a>, which
also allow the creation of an OEM private key infrastructure (PKI) and the
generation of the associated public keys (SRK) table, which is burned into the
fuses. The CST can also be used with the PKCS#11 standard to access
cryptographic services from tokens or devices such as HSM, TPM, and smart cards.</p>
<p>The first container is signed with NXP keys and is authenticated by the ELE ROM,
while the other containers are signed with OEM keys.</p>
</div>
<div class="section" id="ahab-boot-flow">
<h3>AHAB Boot Flow</h3>
<p>In single boot mode, the Cortex-A55 ROM reads data from the selected boot
device, loading all containers in the chosen boot image set one by one. All
images within each container (e.g., EdgeLock secure enclave firmware, Cortex-M33
firmware, A55 firmware, OP-TEE, and U-Boot) are loaded, and the EdgeLock secure
enclave (ELE) is tasked with authenticating them. The ELE firmware is
authenticated by the ELE ROM, and images in the second container are verified by
the ELE firmware.</p>
<p>If the bootloader image contains more than two containers, the third and
subsequent containers are authenticated by the SPL instead of the ELE.</p>
</div>
</div>
<div class="section" id="pki-generation">
<h2>PKI Generation</h2>
<p>To authenticate the bootloader, we need to generate keys. These keys can be
created with the <a class="reference external" href="https://www.nxp.com/webapp/sps/download/license.jsp?colCode=IMX_CST_TOOL_NEW">CST</a>. The private key will be used to sign the bootloader, and
the public key will be burned into the i.MX93 fuses to authenticate the
bootloader during boot.</p>
<p>Follow these steps to generate the keys:</p>
<div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span>cst-3.4.1/keys
<span class="nb">echo</span><span class="w"> </span><span class="m">00000001</span><span class="w"> </span>&gt;<span class="w"> </span>serial
</pre></div>
<p>Write the passphrase for the certificate (replace &quot;fooahabcert&quot; with your
choice) in two lines, separated by <tt class="docutils literal">\n</tt>. It is important to store this
passphrase securely with backups:</p>
<div class="highlight"><pre><span></span><span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;fooahabcert\nfooahabcert&quot;</span><span class="w"> </span>&gt;<span class="w"> </span>key_pass.txt
</pre></div>
<p>Generate a P384 ECC PKI tree with a subordinate SGK key on CST:</p>
<div class="highlight"><pre><span></span>./ahab_pki_tree.sh
<span class="o">[</span>...<span class="o">]</span>
Do<span class="w"> </span>you<span class="w"> </span>want<span class="w"> </span>to<span class="w"> </span>use<span class="w"> </span>an<span class="w"> </span>existing<span class="w"> </span>CA<span class="w"> </span>key<span class="w"> </span><span class="o">(</span>y/n<span class="o">)</span>?:<span class="w"> </span>n

Key<span class="w"> </span><span class="nb">type</span><span class="w"> </span>options<span class="w"> </span><span class="o">(</span>confirm<span class="w"> </span>targeted<span class="w"> </span>device<span class="w"> </span>supports<span class="w"> </span>desired<span class="w"> </span>key<span class="w"> </span><span class="nb">type</span><span class="o">)</span>:
Select<span class="w"> </span>the<span class="w"> </span>key<span class="w"> </span><span class="nb">type</span><span class="w"> </span><span class="o">(</span>possible<span class="w"> </span>values:<span class="w"> </span>rsa,<span class="w"> </span>rsa-pss,<span class="w"> </span>ecc<span class="o">)</span>?:<span class="w"> </span>ecc
Enter<span class="w"> </span>length<span class="w"> </span><span class="k">for</span><span class="w"> </span>elliptic<span class="w"> </span>curve<span class="w"> </span>to<span class="w"> </span>be<span class="w"> </span>used<span class="w"> </span><span class="k">for</span><span class="w"> </span>PKI<span class="w"> </span>tree:
Possible<span class="w"> </span>values<span class="w"> </span>p256,<span class="w"> </span>p384,<span class="w"> </span>p521:<span class="w">  </span>p384
Enter<span class="w"> </span>the<span class="w"> </span>digest<span class="w"> </span>algorithm<span class="w"> </span>to<span class="w"> </span>use:<span class="w"> </span>sha384
Enter<span class="w"> </span>PKI<span class="w"> </span>tree<span class="w"> </span>duration<span class="w"> </span><span class="o">(</span>years<span class="o">)</span>:<span class="w"> </span><span class="m">10</span>
Do<span class="w"> </span>you<span class="w"> </span>want<span class="w"> </span>the<span class="w"> </span>SRK<span class="w"> </span>certificates<span class="w"> </span>to<span class="w"> </span>have<span class="w"> </span>the<span class="w"> </span>CA<span class="w"> </span>flag<span class="w"> </span>set?<span class="w"> </span><span class="o">(</span>y/n<span class="o">)</span>?:<span class="w"> </span>n
</pre></div>
<p>Generate the Signing Root Keys (SRK) Table and SRK Hash for 64-bit Linux machines:</p>
<div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span>../crts/
../linux64/bin/srktool<span class="w"> </span>-a<span class="w"> </span>-d<span class="w"> </span>sha256<span class="w"> </span>-s<span class="w"> </span>sha384<span class="w"> </span>-t<span class="w"> </span>SRK_1_2_3_4_table.bin<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-e<span class="w"> </span>SRK_1_2_3_4_fuse.bin<span class="w"> </span>-f<span class="w"> </span><span class="m">1</span><span class="w"> </span>-c<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>SRK1_sha384_secp384r1_v3_usr_crt.pem,<span class="se">\</span>
<span class="w">    </span>SRK2_sha384_secp384r1_v3_usr_crt.pem,<span class="se">\</span>
<span class="w">    </span>SRK3_sha384_secp384r1_v3_usr_crt.pem,<span class="se">\</span>
<span class="w">    </span>SRK4_sha384_secp384r1_v3_usr_crt.pem
</pre></div>
<p>Do not enter spaces between the commas when specifying the SRKs in the &quot;-c&quot; or
&quot;--certs&quot; option. Otherwise, the certificates specified after the first space
will be excluded from the table.</p>
<p>Regenerate the SRK HASH (SRK_1_2_3_4_fuse.bin) using SHA256 with the
SRK_1_2_3_4_table.bin:</p>
<div class="highlight"><pre><span></span>openssl<span class="w"> </span>dgst<span class="w"> </span>-binary<span class="w"> </span>-sha256<span class="w"> </span>SRK_1_2_3_4_table.bin
</pre></div>
<p>Optionally, verify that the sha256sum of SRK_1_2_3_4_table matches the SRK_1_2_3_4_fuse.bin:</p>
<div class="highlight"><pre><span></span>od<span class="w"> </span>-t<span class="w"> </span>x4<span class="w"> </span>SRK_1_2_3_4_fuse.bin
<span class="m">0000000</span><span class="w"> </span>29eec727<span class="w"> </span>eaed9aa7<span class="w"> </span>c7e53bc0<span class="w"> </span>36835f78
<span class="m">0000020</span><span class="w"> </span>6901bc47<span class="w"> </span>b244753c<span class="w"> </span>f78d3162<span class="w"> </span>27ae36b9
<span class="m">0000040</span>
</pre></div>
</div>
<div class="section" id="bootloader-signature">
<h2>Bootloader Signature</h2>
<p>The CST uses CSF description files to sign (and encrypt) containers generated by
imx-mkimage with OEM keys. When imx-mkimage generates containers, it also
specifies the block offsets to be used in the CSF description files. For
example, imx-mkimage returns the following values for your bootloader:</p>
<div class="highlight"><pre><span></span>CST: CONTAINER 0 offset: 0x0
CST: CONTAINER 0: Signature Block: offset is at 0x190
CST: CONTAINER 0 offset: 0x400
CST: CONTAINER 0: Signature Block: offset is at 0x490
</pre></div>
<p>Where <em>0x190</em> is the block offset for the second container header and <em>0x490</em> is
the block offset for the third container header.</p>
<p>The CSF description file used to sign a container contains three sections:</p>
<ul class="simple">
<li><em>[Header]</em>: Information about the HAB version to use for signing.</li>
<li><em>[Authenticate Data]</em>: Information about the key used to sign.</li>
<li><em>[Install SRK]</em>: Information about the container being signed.</li>
</ul>
<p>The following CSF description files were used to sign the
<em>u-boot-atf-container.img</em> in our example:</p>
<div class="highlight"><pre><span></span><span class="k">[Header]</span>
<span class="na">Target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">AHAB</span>
<span class="na">Version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">1.0</span>

<span class="k">[Install SRK]</span>
<span class="c1"># SRK table generated by srktool</span>
<span class="na">File</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;SRK_1_2_3_4_table.bin&quot;</span>
<span class="c1"># Public key certificate in PEM format</span>
<span class="na">Source</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;SRK1_sha384_secp384r1_v3_usr_crt.pem&quot;</span>
<span class="c1"># Index of the public key certificate within the SRK table (0 .. 3)</span>
<span class="na">Source index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">0</span>
<span class="c1"># Type of SRK set (NXP or OEM)</span>
<span class="na">Source set</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">OEM</span>
<span class="c1"># bitmask of the revoked SRKs</span>
<span class="na">Revocations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">0x0</span>

<span class="k">[Authenticate Data]</span>
<span class="c1"># Binary to be signed generated by mkimage</span>
<span class="na">File</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;u-boot-atf-container.img&quot;</span>
<span class="c1"># Offsets = Container header  Signature block (printed out by mkimage)</span>
<span class="na">Offsets</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">0x0 0x190</span>
</pre></div>
<p>The following CSF description files were used to sign <em>flash.bin</em> in our
example:</p>
<div class="highlight"><pre><span></span><span class="k">[Header]</span>
<span class="na">Target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">AHAB</span>
<span class="na">Version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">1.0</span>

<span class="k">[Install SRK]</span>
<span class="c1"># SRK table generated by srktool</span>
<span class="na">File</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;SRK_1_2_3_4_table.bin&quot;</span>
<span class="c1"># Public key certificate in PEM format</span>
<span class="na">Source</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;SRK1_sha384_secp384r1_v3_usr_crt.pem&quot;</span>
<span class="c1"># Index of the public key certificate within the SRK table (0 .. 3)</span>
<span class="na">Source index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">0</span>
<span class="c1"># Type of SRK set (NXP or OEM)</span>
<span class="na">Source set</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">OEM</span>
<span class="c1"># bitmask of the revoked SRKs</span>
<span class="na">Revocations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">0x0</span>

<span class="k">[Authenticate Data]</span>
<span class="c1"># Binary to be signed generated by mkimage</span>
<span class="na">File</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;flash.bin&quot;</span>
<span class="c1"># Offsets = Container header  Signature block (printed out by mkimage)</span>
<span class="na">Offsets</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">0x400 0x490</span>
</pre></div>
<p>The first step is to generate a <em>u-boot-atf-container.img</em>, then copy the block
offsets into the CSF description file to sign it:</p>
<div class="highlight"><pre><span></span>make<span class="w"> </span><span class="nv">SOC</span><span class="o">=</span>iMX9<span class="w"> </span><span class="nv">REV</span><span class="o">=</span>A1<span class="w"> </span><span class="nv">dtbs</span><span class="o">=</span>imx93-11x11-evk.dtb<span class="w"> </span>u-boot-atf-container.img
</pre></div>
<p>Next, sign it with the following command and replace the unsigned version:</p>
<div class="highlight"><pre><span></span>cst<span class="w"> </span>-i<span class="w"> </span>u-boot-atf-container.img.csf<span class="w"> </span>-o<span class="w"> </span>u-boot-atf-container.img.signed
mv<span class="w"> </span>u-boot-atf-container.img.signed<span class="w"> </span>u-boot-atf-container.img
</pre></div>
<p>Then generate a <em>flash.bin</em> containing the signed <em>u-boot-atf-container.img</em>:</p>
<div class="highlight"><pre><span></span>make<span class="w"> </span><span class="nv">SOC</span><span class="o">=</span>iMX9<span class="w"> </span><span class="nv">REV</span><span class="o">=</span>A1<span class="w"> </span><span class="nv">V2X</span><span class="o">=</span>NO<span class="w"> </span><span class="nv">dtbs</span><span class="o">=</span>imx93-11x11-evk.dtb<span class="w"> </span>flash_singleboot
</pre></div>
<p>Finally, sign the resulting <em>flash.bin</em>:</p>
<div class="highlight"><pre><span></span>cst<span class="w"> </span>-i<span class="w"> </span>flash.bin.csf<span class="w"> </span>-o<span class="w"> </span>flash.bin.signed
</pre></div>
</div>
<div class="section" id="burn-fuses">
<h2>Burn Fuses</h2>
<p>Once the signed <em>flash.bin</em> is flashed, you need to burn the public keys used to
sign the bootloader into the i.MX93 fuses to finalize AHAB secure boot. This
requires using a U-Boot that provides AHAB functionalities, such as checking ELE
events during bootloader authentication and securing the device.</p>
<div class="section" id="program-srk">
<h3>Program SRK</h3>
<p>The following commands enable AHAB secure boot by programming the
<em>SRK_HASH[255:0]</em> fuses on i.MX93, ensuring that only bootloaders signed with
keys matching the SRK hash programmed into the fuses will be accepted:</p>
<div class="highlight"><pre><span></span>fuse<span class="w"> </span>prog<span class="w"> </span>-y<span class="w"> </span><span class="m">16</span><span class="w"> </span><span class="m">0</span><span class="w"> </span>0x29eec727
fuse<span class="w"> </span>prog<span class="w"> </span>-y<span class="w"> </span><span class="m">16</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>0xeaed9aa7
fuse<span class="w"> </span>prog<span class="w"> </span>-y<span class="w"> </span><span class="m">16</span><span class="w"> </span><span class="m">2</span><span class="w"> </span>0xc7e53bc0
fuse<span class="w"> </span>prog<span class="w"> </span>-y<span class="w"> </span><span class="m">16</span><span class="w"> </span><span class="m">3</span><span class="w"> </span>0x36835f78
fuse<span class="w"> </span>prog<span class="w"> </span>-y<span class="w"> </span><span class="m">16</span><span class="w"> </span><span class="m">4</span><span class="w"> </span>0x6901bc47
fuse<span class="w"> </span>prog<span class="w"> </span>-y<span class="w"> </span><span class="m">16</span><span class="w"> </span><span class="m">5</span><span class="w"> </span>0xb244753c
fuse<span class="w"> </span>prog<span class="w"> </span>-y<span class="w"> </span><span class="m">16</span><span class="w"> </span><span class="m">6</span><span class="w"> </span>0xf78d3162
fuse<span class="w"> </span>prog<span class="w"> </span>-y<span class="w"> </span><span class="m">16</span><span class="w"> </span><span class="m">7</span><span class="w"> </span>0x27ae36b9
</pre></div>
</div>
<div class="section" id="close-the-device">
<h3>Close the Device</h3>
<p>Once the SRK fuses are programmed, you can &quot;close&quot; the device to allow only the
bootloader signed with keys matching the SRK table to boot:</p>
<div class="highlight"><pre><span></span>ahab_close
</pre></div>
<p>Before closing the device, you can verify that the fuses have been written
correctly by checking that no ELE events are raised:</p>
<div class="highlight"><pre><span></span>ahab_status
Lifecycle:<span class="w"> </span>0x00000008,<span class="w"> </span>OEM<span class="w"> </span>Open

No<span class="w"> </span>Events<span class="w"> </span>Found!
<span class="o">=</span>&gt;
Lifecycle:<span class="w"> </span>0x00000008,<span class="w"> </span>OEM<span class="w"> </span>Open

No<span class="w"> </span>Events<span class="w"> </span>Found!
</pre></div>
<p>Once the device is closed, the <em>ahab_status</em> command will show <em>OEM closed</em>:</p>
<div class="highlight"><pre><span></span>ahab_status
Lifecycle:<span class="w"> </span>0x00000020,<span class="w"> </span>OEM<span class="w"> </span>closed

No<span class="w"> </span>Events<span class="w"> </span>Found!
<span class="o">=</span>&gt;
Lifecycle:<span class="w"> </span>0x00000020,<span class="w"> </span>OEM<span class="w"> </span>closed
No<span class="w"> </span>Events<span class="w"> </span>Found!
</pre></div>
<p>As long as <em>OEM Open</em> appears in the status, the device is not secured and can still
execute unsigned bootloaders or those signed with invalid keys.</p>
</div>
</div>
<div class="section" id="conclusion">
<h2>Conclusion</h2>
<p>By implementing AHAB on the i.MX93 platform, you can ensure that your boot
process is protected from unauthorized code. The use of public key cryptography
and secure containers adds an extra layer of security, making your device more
resilient to attacks. This process is crucial for applications where integrity
and authenticity from the very first boot stage are paramount.</p>
</div>

                <div class="clear"></div>

                <div class="info">
                    <a href="https://tprrt.tupi.fr/secure-boot-with-ahab-on-imx93.html">posted at 19:21</a>
                    &nbsp;&middot;&nbsp;<a href="https://tprrt.tupi.fr/category/security.html" rel="tag">Security</a>
                    &nbsp;&middot;
                    &nbsp;<a href="https://tprrt.tupi.fr/tag/security.html" class="tags">security</a>
                    &nbsp;<a href="https://tprrt.tupi.fr/tag/embedded.html" class="tags selected">embedded</a>
                    &nbsp;<a href="https://tprrt.tupi.fr/tag/imx93.html" class="tags">imx93</a>
                    &nbsp;<a href="https://tprrt.tupi.fr/tag/secure-boot.html" class="tags">secure-boot</a>
                    &nbsp;<a href="https://tprrt.tupi.fr/tag/ahab.html" class="tags">ahab</a>
                    &nbsp;<a href="https://tprrt.tupi.fr/tag/nxp.html" class="tags">nxp</a>
                </div>
            </article>            <h4 class="date">Jul 29, 2022</h4>

            <article class="post">
                <h2 class="title">
                    <a href="https://tprrt.tupi.fr/zephyr-device-tree-guide.html" rel="bookmark" title="Permanent Link to &quot;Zephyr Device Tree Guide&quot;">Zephyr Device Tree Guide</a>
                </h2>

                
                

                <div class="section" id="introduction">
<h2>Introduction</h2>
<p>The goal of the <a class="reference external" href="https://zephyrproject.org/">Zephyr project</a>, hosted by the Linux foundation, since 2016, is to provide a safe and secured real time operating system (RTOS) for connected devices that are too small for Linux, or for core companion, through the Apache 2.0 open source license.</p>
<p>It is designed for resource-constrained devices such as microcontrollers and Internet of Things (IoT) devices, to be modular and scalable. This makes it ideal for a wide range of devices, from simple sensors to complex systems. The operating system is written in C and is fully compatible with the C11 and C++17 standards.</p>
<p>One of the key benefits of the Zephyr device model is its small footprint, it can be configured to run on devices with as little as 10 KB of memory.</p>
<p>It supports multiple 32 bits and 64 bits architectures: Cortex-A, Cortex-M, Cortex-R, RISC-V, x86-64, etc.
But it also support several boards and extensions: Feather, nRF52840, ST Discovery, ST Nucleo, ESP-32, etc.
It is able to manage several kinds of connectivity: Bluetooth, ethernet, wifi, LoRa.
And it support some network protocols: IPv4, IPv6,UDP, TCP, CoAP, LWM2M, MQTT, DNS, etc.</p>
<p>As Linux, Zephyr use <a class="reference external" href="https://www.kernel.org/doc/html/latest/kbuild/kconfig-language.html">Kconfig</a>, and its device model is mainly based on <a class="reference external" href="https://www.devicetree.org/">device tree</a>.</p>
</div>
<div class="section" id="device-tree">
<h2>Device tree</h2>
<p>Device trees are tree data structures that describe the hardware components and their relationships in a system.
They are stored in a text file, named device tree sources (*.dts), and they written by developers to describe hardware architectures of SoCs and boards.
And they are used by the operating system to determine how to initialize and interact with the hardware.</p>
<p>Each node describe a device of the system, has its own properties that describe their characteristics, and they have only one parent (except for the root node).</p>
<p>Each device driver is associated with a specific device tree node, which represents a hardware component in the system. The device driver provides the necessary code and data to control the behavior of the hardware component.</p>
<div class="highlight"><pre><span></span><span class="nl">test_i2c_bme280</span><span class="p">:</span><span class="w"> </span><span class="n">bme280</span><span class="err">@</span><span class="mi">6</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">compatible</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;bosch,bme280&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="n">reg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x6</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
<p>In the Linux kernel, device tree sources are compiled to device tree binaries (dtb) that are parsed, at boot, by bootloader stages (U-Boot, TF-A...) and the kernel to allow support several hardware configuration with same binaries.</p>
<p>But in Zephyr, device tree sources are transformed to a &quot;devicetree_generated.h&quot; C header file at build, that contains macro definitions and data structures allowing device drivers to access information about the hardware components in the system, such as the memory mapping of a device, its pin assignments, and its IRQ numbers:</p>
<div class="highlight"><pre><span></span><span class="cp">#define DT_COMPAT_HAS_OKAY_bosch_bme280 1</span>
<span class="cp">#define DT_N_INST_bosch_bme280_NUM_OKAY 1</span>
<span class="cp">#define DT_FOREACH_OKAY_bosch_bme280(fn) fn(DT_N_S_soc_S_i2c_40005400_S_bme280_77)</span>
<span class="cp">#define DT_FOREACH_OKAY_VARGS_bosch_bme280(fn, ...) fn(DT_N_S_soc_S_i2c_40005400_S_bme280_77, __VA_ARGS__)</span>
<span class="cp">#define DT_FOREACH_OKAY_INST_bosch_bme280(fn) fn(0)</span>
<span class="cp">#define DT_FOREACH_OKAY_INST_VARGS_bosch_bme280(fn, ...) fn(0, __VA_ARGS__)</span>
<span class="cp">#define DT_COMPAT_bosch_bme280_BUS_i2c 1</span>
</pre></div>
<p>Where:</p>
<ul class="simple">
<li><strong>DT_COMPAT_HAS_OKAY_bosch_bme280</strong>: indicates that there is at least one instance of BME280</li>
<li><strong>DT_N_INST_bosch_bme280_NUM_OKAY</strong>: defines the number of BME280 instances that are marked okay</li>
<li><strong>DT_FOREACH_OKAY_bosch_bme280</strong>: allows you to apply a function <em>fn</em> to each instance of the BME280</li>
<li><strong>DT_FOREACH_OKAY_VARGS_bosch_bme280</strong>: also allows you to apply a function <em>fn</em> to each instance of the BME280, but with additional arguments</li>
<li><strong>DT_FOREACH_OKAY_INST_bosch_bme280</strong>: allows you to apply a function <em>fn</em> to each instance of the BME280, passing the instance number as an argument</li>
<li><strong>DT_FOREACH_OKAY_INST_VARGS_bosch_bme280</strong>: is similar to the previous macro, but this one allows for additional arguments</li>
<li><strong>DT_COMPAT_bosch_bme280_BUS_i2c</strong>: indicates that the BME280 device is connected to an I2C bus.</li>
<li><strong>DT_N_S_soc_S_i2c_40005400_S_bme280_77</strong>: refers to a specific node in the device tree, here it refers to the BME280 sensor connected to the I2C controller with the base address 0x40005400 within the SoC. The sensor's address on this I2C bus is 0x77.</li>
</ul>
<p>In addition, device tree sources can be extended or overridden, for example to connect additional devices to a board, or to disable board devices which will not be used:</p>
<div class="highlight"><pre><span></span><span class="o">/</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">aliases</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">bme280</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">bme280</span><span class="p">;</span>
<span class="w">        </span><span class="p">};</span>
<span class="p">};</span>

<span class="o">&amp;</span><span class="n">spi1</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;disabled&quot;</span><span class="p">;</span>
<span class="p">};</span>

<span class="o">&amp;</span><span class="n">i2c1</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;okay&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="nl">bme280</span><span class="p">:</span><span class="w"> </span><span class="n">bme280</span><span class="err">@</span><span class="mi">77</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">compatible</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;bosch,bme280&quot;</span><span class="p">;</span>
<span class="w">                </span><span class="n">reg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x77</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">        </span><span class="p">};</span>
<span class="p">};</span>
</pre></div>
</div>
<div class="section" id="binding">
<h2>Binding</h2>
<p>Content of device tree sources is described in binding files, that are written in human readable and easy to parse YAML.
Binding files can be also used to validate device tree sources by comparing the information in the YAML file with the information in the device tree sources.</p>
<div class="highlight"><pre><span></span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">BME280 integrated environmental sensor</span>

<span class="nt">compatible</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;bosch,bme280&quot;</span>

<span class="nt">include</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">sensor-device.yaml</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">i2c-device.yaml</span><span class="p p-Indicator">]</span>
</pre></div>
</div>
<div class="section" id="device-driver">
<h2>Device driver</h2>
<p>In Zephyr, a device driver can access the properties of an associated node in the device tree using the macro that are defined in C header files.
For example, the following code can be used to initialize a BME280 sensor using properties defined in the device tree:</p>
<div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;device.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;drivers/i2c.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;devicetree.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr.h&gt;</span>

<span class="c1">// Define the node identifier for the BME280 sensor</span>
<span class="cp">#define BME280_NODE DT_N_S_soc_S_i2c_40005400_S_bme280_77</span>

<span class="c1">// Function to initialize the BME280 sensor</span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">bme280_init</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// Check if the node is available</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">device_is_ready</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;Device %s is not ready</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Retrieve the I2C device associated with the BME280 node</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">i2c_dev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DEVICE_DT_GET</span><span class="p">(</span><span class="n">DT_BUS</span><span class="p">(</span><span class="n">BME280_NODE</span><span class="p">));</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">device_is_ready</span><span class="p">(</span><span class="n">i2c_dev</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;I2C device not ready</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Write some initialization code here, such as configuring registers</span>

<span class="w">    </span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;BME280 sensor initialized</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Initialize the BME280 sensor at boot time</span>
<span class="n">SYS_INIT</span><span class="p">(</span><span class="n">bme280_init</span><span class="p">,</span><span class="w"> </span><span class="n">APPLICATION</span><span class="p">,</span><span class="w"> </span><span class="n">CONFIG_APPLICATION_INIT_PRIORITY</span><span class="p">);</span>
</pre></div>
</div>
<div class="section" id="conclusion">
<h2>Conclusion</h2>
<p>Those who have already implemented BSP or driver on Linux shouldn't encounter too much difficulty, but on the other hand, the step is a little higher for people coming from the world of micro-controllers.</p>
</div>

                <div class="clear"></div>

                <div class="info">
                    <a href="https://tprrt.tupi.fr/zephyr-device-tree-guide.html">posted at 20:32</a>
                    &nbsp;&middot;&nbsp;<a href="https://tprrt.tupi.fr/category/embedded.html" rel="tag">Embedded</a>
                    &nbsp;&middot;
                    &nbsp;<a href="https://tprrt.tupi.fr/tag/zephyr.html" class="tags">zephyr</a>
                    &nbsp;<a href="https://tprrt.tupi.fr/tag/device-tree.html" class="tags">device-tree</a>
                    &nbsp;<a href="https://tprrt.tupi.fr/tag/rtos.html" class="tags">rtos</a>
                    &nbsp;<a href="https://tprrt.tupi.fr/tag/embedded.html" class="tags selected">embedded</a>
                </div>
            </article>            <h4 class="date">Jun 27, 2020</h4>

            <article class="post">
                <h2 class="title">
                    <a href="https://tprrt.tupi.fr/build-an-embedded-linux-in-fifteen-min.html" rel="bookmark" title="Permanent Link to &quot;Build an embedded Linux in less than 15 minutes&quot;">Build an embedded Linux in less than 15 minutes</a>
                </h2>

                
                

                <div class="section" id="introduction">
<h2>Introduction</h2>
<p>Since some years, I haven't built an embedded Linux without using a framework, like <a class="reference external" href="https://openembedded.org">Open Embedded</a> from the <a class="reference external" href="https://yoctoproject.org">Yocto</a>
project.
Then here, I wanted to make a guide to help you to build quickly, from &quot;scratch&quot; a very minimal embedded Linux to boot a
target.
The following examples have been written to boot a virtual Qemu target but, they can be adapted to boot a real target.
Moreover, the build environment will be bootstrapped with a prebuilt cross-toolchain, I have chosen to use one provided
by <a class="reference external" href="https://toolchains.bootlin.com">Bootlin</a> and using glibc.</p>
</div>
<div class="section" id="setup-the-environment">
<h2>Setup the environment</h2>
<p>First, it is required to install the packages that are needed to install and use the cross-toolchain but also to compile the host tools and to provide Qemu:</p>
<ul class="simple">
<li>The Ncurses libraries are only required to execute the command <cite>make menuconfig</cite>.</li>
<li>The certificates and wget will be used to download the prebuilt toolchain.</li>
<li>In the same way, git will be used to checkout the source of <a class="reference external" href="https://busybox.net">Busybox</a> and <a class="reference external" href="https://www.kernel.org">Linux</a>.</li>
<li>The Qemu packages will be used to emulate system platform and to execute static binaries cross-compiled for aarch64 on the x86-64 host.</li>
</ul>
<div class="highlight"><pre><span></span>apt<span class="w"> </span>update
apt<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>--no-install-recommends<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>bc<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>build-essential<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>ca-certificates<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>cpio<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>file<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>flex<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>git<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>ipxe-qemu<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>libncurses5-dev<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>libncursesw5-dev<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>libssl-dev<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>qemu<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>qemu-system-aarch64<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>qemu-user-static<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>wget
</pre></div>
<p>Now, it is time to download and install the prebuilt toolchain:</p>
<div class="highlight"><pre><span></span>mkdir<span class="w"> </span>~/src
<span class="nb">cd</span><span class="w"> </span>~/src
wget<span class="w"> </span>https://toolchains.bootlin.com/downloads/releases/toolchains/aarch64/tarballs/aarch64--glibc--stable-2020.08-1.tar.bz2
tar<span class="w"> </span>xvjf<span class="w"> </span>aarch64--glibc--stable-2020.08-1.tar.bz2
</pre></div>
<p>Once the toolchain has been extracted you have to set the required environment variables to cross-compile binaries:</p>
<ul class="simple">
<li><tt class="docutils literal">PATH</tt>: It shall be extended so that the cross-tools from the cross-toolchain will be available from the environment</li>
<li><tt class="docutils literal">CROSS_COMPILE</tt>: In order to clarify the prefix used by the cross-tools</li>
<li><tt class="docutils literal">ARCH</tt>: The architecture of the target platform</li>
</ul>
<div class="highlight"><pre><span></span>ls<span class="w"> </span>~/src/aarch64--glibc--stable-2020.08-1/bin/*gcc
~/src/aarch64--glibc--stable-2020.08-1/bin/aarch64-linux-gcc

<span class="nb">export</span><span class="w"> </span><span class="nv">PATH</span><span class="o">=</span>~/src/aarch64--glibc--stable-2020.08-1/bin:<span class="nv">$PATH</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">CROSS_COMPILE</span><span class="o">=</span>aarch64-linux-
</pre></div>
<p>Now, it is possible to call the cross-tools from the shell:</p>
<div class="highlight"><pre><span></span>aarch64-linux-gcc<span class="w"> </span>-v
Using<span class="w"> </span>built-in<span class="w"> </span>specs.
<span class="nv">COLLECT_GCC</span><span class="o">=</span>~/src/aarch64--glibc--stable-2020.08-1/bin/aarch64-linux-gcc.br_real
<span class="nv">COLLECT_LTO_WRAPPER</span><span class="o">=</span>~/src/aarch64--glibc--stable-2020.08-1/bin/../libexec/gcc/aarch64-buildroot-linux-gnu/9.3.0/lto-wrapper
Target:<span class="w"> </span>aarch64-buildroot-linux-gnu
&lt;...&gt;
Thread<span class="w"> </span>model:<span class="w"> </span>posix
gcc<span class="w"> </span>version<span class="w"> </span><span class="m">9</span>.3.0<span class="w"> </span><span class="o">(</span>Buildroot<span class="w"> </span><span class="m">2020</span>.08-14-ge5a2a90<span class="o">)</span>
</pre></div>
<p>Concerning the variable <tt class="docutils literal">PATH</tt> this one will be set afterwards because its value depends on the binary that will be built.</p>
</div>
<div class="section" id="build-the-linux-kernel">
<h2>Build the Linux kernel</h2>
<p>So, the environment is ready to pull the sources of the latest stable branch of the kernel <a class="reference external" href="https://www.kernel.org">Linux</a> and to build them:</p>
<div class="highlight"><pre><span></span>git<span class="w"> </span>clone<span class="w"> </span>git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git
<span class="nb">cd</span><span class="w"> </span>linux
git<span class="w"> </span>checkout<span class="w"> </span>-b<span class="w"> </span>local/linux-5.4.y<span class="w"> </span>origin/linux-5.4.y
<span class="c1"># git show HEAD</span>

<span class="nb">export</span><span class="w"> </span><span class="nv">ARCH</span><span class="o">=</span>arm64

make<span class="w"> </span>defconfig
<span class="w">  </span>HOSTCC<span class="w">  </span>scripts/basic/fixdep
<span class="w">  </span>HOSTCC<span class="w">  </span>scripts/kconfig/conf.o
<span class="w">  </span>HOSTCC<span class="w">  </span>scripts/kconfig/confdata.o
<span class="w">  </span>HOSTCC<span class="w">  </span>scripts/kconfig/expr.o
<span class="w">  </span>LEX<span class="w">     </span>scripts/kconfig/lexer.lex.c
<span class="w">  </span>YACC<span class="w">    </span>scripts/kconfig/parser.tab.<span class="o">[</span>ch<span class="o">]</span>
<span class="w">  </span>HOSTCC<span class="w">  </span>scripts/kconfig/lexer.lex.o
<span class="w">  </span>HOSTCC<span class="w">  </span>scripts/kconfig/parser.tab.o
<span class="w">  </span>HOSTCC<span class="w">  </span>scripts/kconfig/preprocess.o
<span class="w">  </span>HOSTCC<span class="w">  </span>scripts/kconfig/symbol.o
<span class="w">  </span>HOSTLD<span class="w">  </span>scripts/kconfig/conf
***<span class="w"> </span>Default<span class="w"> </span>configuration<span class="w"> </span>is<span class="w"> </span>based<span class="w"> </span>on<span class="w"> </span><span class="s1">&#39;defconfig&#39;</span>
<span class="c1">#</span>
<span class="c1"># configuration written to .config</span>
<span class="c1">#</span>

<span class="c1"># make menuconfig</span>

make<span class="w"> </span>-j<span class="k">$(</span>nproc<span class="k">)</span>
<span class="w">  </span>&lt;...&gt;
<span class="w">  </span>AR<span class="w">      </span>drivers/net/ethernet/built-in.a
<span class="w">  </span>AR<span class="w">      </span>drivers/net/built-in.a
<span class="w">  </span>AR<span class="w">      </span>drivers/built-in.a
<span class="w">  </span>GEN<span class="w">     </span>.version
<span class="w">  </span>CHK<span class="w">     </span>include/generated/compile.h
<span class="w">  </span>LD<span class="w">      </span>vmlinux.o
<span class="w">  </span>MODPOST<span class="w"> </span>vmlinux.o
<span class="w">  </span>MODINFO<span class="w"> </span>modules.builtin.modinfo
<span class="w">  </span>LD<span class="w">      </span>.tmp_vmlinux.kallsyms1
<span class="w">  </span>KSYM<span class="w">    </span>.tmp_vmlinux.kallsyms1.o
<span class="w">  </span>LD<span class="w">      </span>.tmp_vmlinux.kallsyms2
<span class="w">  </span>KSYM<span class="w">    </span>.tmp_vmlinux.kallsyms2.o
<span class="w">  </span>LD<span class="w">      </span>vmlinux
<span class="w">  </span>SORTEX<span class="w">  </span>vmlinux
<span class="w">  </span>SYSMAP<span class="w">  </span>System.map
<span class="w">  </span>Building<span class="w"> </span>modules,<span class="w"> </span>stage<span class="w"> </span><span class="m">2</span>.
<span class="w">  </span>MODPOST<span class="w"> </span><span class="m">531</span><span class="w"> </span>modules
<span class="w">  </span>OBJCOPY<span class="w"> </span>arch/arm64/boot/Image
<span class="w">  </span>GZIP<span class="w">    </span>arch/arm64/boot/Image.gz
</pre></div>
<p>The command <tt class="docutils literal">make defconfig</tt> will apply the default configuration for the target platform (cf. <tt class="docutils literal">ARCH=arm64</tt>), and the
compilation will be performed by <tt class="docutils literal">make <span class="pre">-j$(nproc)</span></tt>.</p>
<p>The commands <tt class="docutils literal">git show HEAD</tt> and <tt class="docutils literal">make defconfig</tt> are optional:
- the first is useful to verify that the latest commit corresponding to the latest tag of the branch <tt class="docutils literal"><span class="pre">linux-5.4.y</span></tt>.
- the second can be used if you want to customize the kernel configuration.</p>
<p><em>NB</em>. The kernel <a class="reference external" href="https://www.kernel.org">Linux</a> but also <a class="reference external" href="https://busybox.net">Busybox</a> and some projects use <a class="reference external" href="https://www.kernel.org/doc/html/latest/kbuild/kbuild.html">Kbuild</a> to manage the build options</p>
</div>
<div class="section" id="populate-the-sysroot">
<h2>Populate the sysroot</h2>
<p>The easy way to bootstrap a sysroot is to use <a class="reference external" href="https://busybox.net">Busybox</a> that has been created to offer common UNIX tools into a single
executable and it is size-optimized. To create a sysroot, it is only required to add a few configuration files.</p>
<p>The steps to pull and build <a class="reference external" href="https://busybox.net">Busybox</a> are similar to those of the kernel <a class="reference external" href="https://www.kernel.org">Linux</a>.</p>
<div class="highlight"><pre><span></span>git<span class="w"> </span>clone<span class="w"> </span>git://git.busybox.net/busybox
<span class="nb">cd</span><span class="w"> </span>busybox
git<span class="w"> </span>checkout<span class="w"> </span>-b<span class="w"> </span>local/1_32_stable<span class="w"> </span>origin/1_32_stable
<span class="c1"># git show HEAD</span>

<span class="nb">export</span><span class="w"> </span><span class="nv">ARCH</span><span class="o">=</span>aarch64
<span class="nb">export</span><span class="w"> </span><span class="nv">LDFLAGS</span><span class="o">=</span><span class="s2">&quot;--static&quot;</span>

make<span class="w"> </span>defconfig
<span class="c1"># make menuconfig</span>
make<span class="w"> </span>-j<span class="k">$(</span>nproc<span class="k">)</span>

make<span class="w"> </span>install
</pre></div>
<p>Here, the <em>LDFLAGS</em> is set to force static linking of <a class="reference external" href="https://busybox.net">Busybox</a> quickly, but it is also possible to use
<em>make menuconfig</em> to set <em>CONFIG_STATIC=y</em>. The advantage of the static executable is that it can be tested with Qemu:</p>
<div class="highlight"><pre><span></span>qemu-aarch64-static<span class="w"> </span>busybox<span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Hello!&quot;</span>
Hello!
qemu-aarch64-static<span class="w"> </span>busybox<span class="w"> </span>date
Sat<span class="w"> </span>Jun<span class="w"> </span><span class="m">27</span><span class="w"> </span><span class="m">15</span>:06:41<span class="w"> </span>UTC<span class="w"> </span><span class="m">2020</span>
</pre></div>
<p>The binary <em>qemu-aarch64-static</em> allows to execute a binary built for another architecture on the host computer, for
example here it allows to execute the <a class="reference external" href="https://busybox.net">Busybox</a> binary compiled for an aarch64 target on a x86-64 host.</p>
<p>The last command <em>make install</em> created a tree into the <em>_install</em> directory that can be used to populate the sysroot:</p>
<div class="highlight"><pre><span></span>ls<span class="w"> </span>-l<span class="w"> </span>_install
total<span class="w"> </span><span class="m">4</span>
drwxr-xr-x.<span class="w"> </span><span class="m">1</span><span class="w"> </span>tperrot<span class="w"> </span>tperrot<span class="w"> </span><span class="m">974</span><span class="w"> </span>Nov<span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="m">15</span>:22<span class="w"> </span>bin
lrwxrwxrwx.<span class="w"> </span><span class="m">1</span><span class="w"> </span>tperrot<span class="w"> </span>tperrot<span class="w">  </span><span class="m">11</span><span class="w"> </span>Nov<span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="m">15</span>:22<span class="w"> </span>linuxrc<span class="w"> </span>-&gt;<span class="w"> </span>bin/busybox
drwxr-xr-x.<span class="w"> </span><span class="m">1</span><span class="w"> </span>tperrot<span class="w"> </span>tperrot<span class="w"> </span><span class="m">986</span><span class="w"> </span>Nov<span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="m">15</span>:22<span class="w"> </span>sbin
drwxr-xr-x.<span class="w"> </span><span class="m">1</span><span class="w"> </span>tperrot<span class="w"> </span>tperrot<span class="w">  </span><span class="m">14</span><span class="w"> </span>Nov<span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="m">15</span>:22<span class="w"> </span>usr

ls<span class="w"> </span>-l<span class="w"> </span>_install/bin
&lt;...&gt;
lrwxrwxrwx.<span class="w"> </span><span class="m">1</span><span class="w"> </span>tperrot<span class="w"> </span>tperrot<span class="w">       </span><span class="m">7</span><span class="w"> </span>Nov<span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="m">15</span>:22<span class="w"> </span>umount<span class="w"> </span>-&gt;<span class="w"> </span>busybox
lrwxrwxrwx.<span class="w"> </span><span class="m">1</span><span class="w"> </span>tperrot<span class="w"> </span>tperrot<span class="w">       </span><span class="m">7</span><span class="w"> </span>Nov<span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="m">15</span>:22<span class="w"> </span>uname<span class="w"> </span>-&gt;<span class="w"> </span>busybox
lrwxrwxrwx.<span class="w"> </span><span class="m">1</span><span class="w"> </span>tperrot<span class="w"> </span>tperrot<span class="w">       </span><span class="m">7</span><span class="w"> </span>Nov<span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="m">15</span>:22<span class="w"> </span>usleep<span class="w"> </span>-&gt;<span class="w"> </span>busybox
lrwxrwxrwx.<span class="w"> </span><span class="m">1</span><span class="w"> </span>tperrot<span class="w"> </span>tperrot<span class="w">       </span><span class="m">7</span><span class="w"> </span>Nov<span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="m">15</span>:22<span class="w"> </span>vi<span class="w"> </span>-&gt;<span class="w"> </span>busybox
lrwxrwxrwx.<span class="w"> </span><span class="m">1</span><span class="w"> </span>tperrot<span class="w"> </span>tperrot<span class="w">       </span><span class="m">7</span><span class="w"> </span>Nov<span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="m">15</span>:22<span class="w"> </span>watch<span class="w"> </span>-&gt;<span class="w"> </span>busybox
lrwxrwxrwx.<span class="w"> </span><span class="m">1</span><span class="w"> </span>tperrot<span class="w"> </span>tperrot<span class="w">       </span><span class="m">7</span><span class="w"> </span>Nov<span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="m">15</span>:22<span class="w"> </span>zcat<span class="w"> </span>-&gt;<span class="w"> </span>busybox
</pre></div>
<p>In order, to finalize this minimal sysroot, it is required to create a rcS init script:</p>
<div class="highlight"><pre><span></span>mkdir<span class="w"> </span>_install/proc<span class="w"> </span>_install/sys<span class="w"> </span>_install/dev<span class="w"> </span>_install/etc<span class="w"> </span>_install/etc/init.d
cat<span class="w"> </span>&gt;<span class="w"> </span>_install/etc/init.d/rcS<span class="w"> </span><span class="s">&lt;&lt; EOF</span>
<span class="s">#!/bin/sh</span>
<span class="s">mount -t proc none /proc</span>
<span class="s">mount -t sysfs none /sys</span>
<span class="s">/sbin/mdev -s</span>
<span class="s">[ ! -h /etc/mtab ]  &amp;&amp; ln -s /proc/mounts /etc/mtab</span>
<span class="s">[ ! -f /etc/resolv.conf ] &amp;&amp; cat /proc/net/pnp &gt; /etc/resolv.conf</span>
<span class="s">EOF</span>
chmod<span class="w"> </span>+x<span class="w"> </span>_install/etc/init.d/rcS
</pre></div>
</div>
<div class="section" id="build-the-filesystem">
<h2>Build the filesystem</h2>
<p>The target of this step is to package the sysroot tree into a filesystem that can be mounted by the kernel.
There is two available possibilities, either build a <em>ramfs</em> or a <em>rootfs</em>.</p>
<p>Globally, the difference between both is that:</p>
<ul class="simple">
<li>the ramfs is a very simple filesystem that can be used by the kernel to create a block device into the RAM space from an archive.</li>
<li>the rootfs is a filesystem mounted from a non volatile device by the kernel.</li>
</ul>
<p>For more information about the difference between the ramfs and the rootfs, you can you refer to the <a class="reference external" href="https://www.kernel.org/doc/html/latest/filesystems/ramfs-rootfs-initramfs.html">kernel documentation</a>.</p>
<div class="section" id="build-a-ramfs">
<h3>Build a ramfs</h3>
<p>To build the ramfs we will use <em>cpio</em> and <em>gzip</em> to construct the compressed archive after modifying the rights:</p>
<div class="highlight"><pre><span></span>mkdir<span class="w"> </span>_rootfs
rsync<span class="w"> </span>-a<span class="w"> </span>_install/<span class="w"> </span>_rootfs
chown<span class="w"> </span>-R<span class="w"> </span>root:root<span class="w"> </span>_rootfs
<span class="nb">cd</span><span class="w"> </span>_rootfs
find<span class="w"> </span>.<span class="w"> </span><span class="p">|</span><span class="w"> </span>cpio<span class="w"> </span>-o<span class="w"> </span>--format<span class="o">=</span>newc<span class="w"> </span>&gt;<span class="w"> </span>../rootfs.cpio
<span class="nb">cd</span><span class="w"> </span>..
gzip<span class="w"> </span>-c<span class="w"> </span>rootfs.cpio<span class="w"> </span>&gt;<span class="w"> </span>rootfs.cpio.gz
</pre></div>
</div>
<div class="section" id="build-a-rootfs">
<h3>Build a rootfs</h3>
<p>To build the rootfs, the first step is to create an empty binary blob that will be mounted into a loop device to be
formatted to create a ext3 filesystem. Then the tree can be copied and the rights updated.</p>
<div class="highlight"><pre><span></span>dd<span class="w"> </span><span class="k">if</span><span class="o">=</span>/dev/zero<span class="w"> </span><span class="nv">of</span><span class="o">=</span>rootfs.img<span class="w"> </span><span class="nv">bs</span><span class="o">=</span>1M<span class="w"> </span><span class="nv">count</span><span class="o">=</span><span class="m">10</span>
mke2fs<span class="w"> </span>-j<span class="w"> </span>rootfs.img
mkdir<span class="w"> </span>_rootfs
mount<span class="w"> </span>-o<span class="w"> </span>loop<span class="w"> </span>rootfs.img<span class="w"> </span>_rootfs
rsync<span class="w"> </span>-a<span class="w"> </span>_install/<span class="w"> </span>_rootfs
chown<span class="w"> </span>-R<span class="w"> </span>root:root<span class="w"> </span>_rootfs
sync
umount<span class="w"> </span>_rootfs
</pre></div>
</div>
</div>
<div class="section" id="boot-the-target">
<h2>Boot the target</h2>
<p>Following, the qemu commands to boot the minimal embedded Linux system that has been built.</p>
<div class="highlight"><pre><span></span><span class="c1"># With the ramfs</span>
qemu-system-aarch64<span class="w"> </span>-nographic<span class="w"> </span>-no-reboot<span class="w"> </span>-machine<span class="w"> </span>virt<span class="w"> </span>-cpu<span class="w"> </span>cortex-a57<span class="w"> </span>-smp<span class="w"> </span><span class="m">2</span><span class="w"> </span>-m<span class="w"> </span><span class="m">256</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-kernel<span class="w"> </span>~/src/linux/arch/arm64/boot/Image<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-initrd<span class="w"> </span>~/src/busybox/rootfs.cpio.gz<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-append<span class="w"> </span><span class="s2">&quot;panic=5 ro ip=dhcp root=/dev/ram rdinit=/sbin/init&quot;</span>

<span class="c1"># With the rootfs</span>
qemu-system-aarch64<span class="w"> </span>-nographic<span class="w"> </span>-no-reboot<span class="w"> </span>-machine<span class="w"> </span>virt<span class="w"> </span>-cpu<span class="w"> </span>cortex-a57<span class="w"> </span>-smp<span class="w"> </span><span class="m">2</span><span class="w"> </span>-m<span class="w"> </span><span class="m">256</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-kernel<span class="w"> </span>~/src/linux/arch/arm64/boot/Image<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-append<span class="w"> </span><span class="s2">&quot;panic=5 ro ip=dhcp root=/dev/vda&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-drive<span class="w"> </span><span class="nv">file</span><span class="o">=</span>~/src/busybox/rootfs.img,format<span class="o">=</span>raw,if<span class="o">=</span>none,id<span class="o">=</span>hd0<span class="w"> </span>-device<span class="w"> </span>virtio-blk-device,drive<span class="o">=</span>hd0
</pre></div>
<p>Then the target will be boot to shell, <em>&quot;It's alive!&quot;</em>:</p>
<div class="highlight"><pre><span></span><span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w"> </span>Booting<span class="w"> </span>Linux<span class="w"> </span>on<span class="w"> </span>physical<span class="w"> </span>CPU<span class="w"> </span>0x0000000000<span class="w"> </span><span class="o">[</span>0x411fd070<span class="o">]</span>
<span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w"> </span>Linux<span class="w"> </span>version<span class="w"> </span><span class="m">5</span>.10.0-rc5<span class="w"> </span><span class="o">(</span>tperrot@27ea4a863f61<span class="o">)</span><span class="w"> </span><span class="o">(</span>aarch64-linux-gcc.br_real<span class="w"> </span><span class="o">(</span>Buildroot<span class="w"> </span><span class="m">2020</span>.08-14-ge5a2a90<span class="o">)</span><span class="w"> </span><span class="m">9</span>.3.0,<span class="w"> </span>GNU<span class="w"> </span>ld<span class="w"> </span><span class="o">(</span>GNU<span class="w"> </span>Binutils<span class="o">)</span><span class="w"> </span><span class="m">2</span>.33.1<span class="o">)</span><span class="w"> </span><span class="c1">#1 SMP PREEMPT Mon Nov 30 14:40:05 UTC 2020</span>
<span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w"> </span>Machine<span class="w"> </span>model:<span class="w"> </span>linux,dummy-virt
&lt;...&gt;
<span class="o">[</span><span class="w">    </span><span class="m">0</span>.858346<span class="o">]</span><span class="w"> </span>Sending<span class="w"> </span>DHCP<span class="w"> </span>requests<span class="w"> </span>.,<span class="w"> </span>OK
<span class="o">[</span><span class="w">    </span><span class="m">0</span>.870558<span class="o">]</span><span class="w"> </span>IP-Config:<span class="w"> </span>Got<span class="w"> </span>DHCP<span class="w"> </span>answer<span class="w"> </span>from<span class="w"> </span><span class="m">10</span>.0.2.2,<span class="w"> </span>my<span class="w"> </span>address<span class="w"> </span>is<span class="w"> </span><span class="m">10</span>.0.2.15
<span class="o">[</span><span class="w">    </span><span class="m">0</span>.870909<span class="o">]</span><span class="w"> </span>IP-Config:<span class="w"> </span>Complete:
<span class="o">[</span><span class="w">    </span><span class="m">0</span>.871199<span class="o">]</span><span class="w">      </span><span class="nv">device</span><span class="o">=</span>eth0,<span class="w"> </span><span class="nv">hwaddr</span><span class="o">=</span><span class="m">52</span>:54:00:12:34:56,<span class="w"> </span><span class="nv">ipaddr</span><span class="o">=</span><span class="m">10</span>.0.2.15,<span class="w"> </span><span class="nv">mask</span><span class="o">=</span><span class="m">255</span>.255.255.0,<span class="w"> </span><span class="nv">gw</span><span class="o">=</span><span class="m">10</span>.0.2.2
<span class="o">[</span><span class="w">    </span><span class="m">0</span>.871566<span class="o">]</span><span class="w">      </span><span class="nv">host</span><span class="o">=</span><span class="m">10</span>.0.2.15,<span class="w"> </span><span class="nv">domain</span><span class="o">=</span>,<span class="w"> </span>nis-domain<span class="o">=(</span>none<span class="o">)</span>
<span class="o">[</span><span class="w">    </span><span class="m">0</span>.871825<span class="o">]</span><span class="w">      </span><span class="nv">bootserver</span><span class="o">=</span><span class="m">10</span>.0.2.2,<span class="w"> </span><span class="nv">rootserver</span><span class="o">=</span><span class="m">10</span>.0.2.2,<span class="w"> </span><span class="nv">rootpath</span><span class="o">=</span>
<span class="o">[</span><span class="w">    </span><span class="m">0</span>.871866<span class="o">]</span><span class="w">      </span><span class="nv">nameserver0</span><span class="o">=</span><span class="m">10</span>.0.2.3
<span class="o">[</span><span class="w">    </span><span class="m">0</span>.872389<span class="o">]</span>
<span class="o">[</span><span class="w">    </span><span class="m">0</span>.875863<span class="o">]</span><span class="w"> </span>ALSA<span class="w"> </span>device<span class="w"> </span>list:
<span class="o">[</span><span class="w">    </span><span class="m">0</span>.876151<span class="o">]</span><span class="w">   </span>No<span class="w"> </span>soundcards<span class="w"> </span>found.
<span class="o">[</span><span class="w">    </span><span class="m">0</span>.879353<span class="o">]</span><span class="w"> </span>uart-pl011<span class="w"> </span><span class="m">9000000</span>.pl011:<span class="w"> </span>no<span class="w"> </span>DMA<span class="w"> </span>platform<span class="w"> </span>data
<span class="o">[</span><span class="w">    </span><span class="m">0</span>.920237<span class="o">]</span><span class="w"> </span>Freeing<span class="w"> </span>unused<span class="w"> </span>kernel<span class="w"> </span>memory:<span class="w"> </span>5952K
<span class="o">[</span><span class="w">    </span><span class="m">0</span>.921223<span class="o">]</span><span class="w"> </span>Run<span class="w"> </span>/sbin/init<span class="w"> </span>as<span class="w"> </span>init<span class="w"> </span>process

Please<span class="w"> </span>press<span class="w"> </span>Enter<span class="w"> </span>to<span class="w"> </span>activate<span class="w"> </span>this<span class="w"> </span>console.
</pre></div>
</div>

                <div class="clear"></div>

                <div class="info">
                    <a href="https://tprrt.tupi.fr/build-an-embedded-linux-in-fifteen-min.html">posted at 13:01</a>
                    &nbsp;&middot;&nbsp;<a href="https://tprrt.tupi.fr/category/linux.html" rel="tag">linux</a>
                    &nbsp;&middot;
                    &nbsp;<a href="https://tprrt.tupi.fr/tag/busybox.html" class="tags">busybox</a>
                    &nbsp;<a href="https://tprrt.tupi.fr/tag/embedded.html" class="tags selected">embedded</a>
                    &nbsp;<a href="https://tprrt.tupi.fr/tag/intermediate.html" class="tags">intermediate</a>
                    &nbsp;<a href="https://tprrt.tupi.fr/tag/linux.html" class="tags">linux</a>
                    &nbsp;<a href="https://tprrt.tupi.fr/tag/qemu.html" class="tags">qemu</a>
                </div>
            </article>

            <div class="clear"></div>
            <footer>
                <p>
                <a href="https://github.com/jody-frankowski/blue-penguin">Blue Penguin</a> Theme
                &middot;
                Powered by <a href="http://getpelican.com">Pelican</a>
                &middot;
                <a href="https://tprrt.tupi.fr/feeds/all.atom.xml" rel="alternate">Atom Feed</a>
                &middot;
                <a href="https://tprrt.tupi.fr/feeds/all.rss.xml" rel="alternate">Rss Feed</a>
            </footer>
        </div>
        <div class="clear"></div>
    </div>
    <script type="text/javascript">
    var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
    document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
    try {
        var pageTracker = _gat._getTracker("UA-169118252-1");
    pageTracker._trackPageview();
    } catch(err) {}</script>
</body>
</html>