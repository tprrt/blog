<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom"><title>A Pelican Blog - tperrot</title><link href="https://tprrt.tupi.fr/" rel="alternate"></link><link href="https://tprrt.tupi.fr/feeds/tperrot.atom.xml" rel="self"></link><id>https://tprrt.tupi.fr/</id><updated>2021-02-03T11:37:00+00:00</updated><entry><title>Build RIOT-OS with Podman</title><link href="https://tprrt.tupi.fr/build-riot-oswith-podman.html" rel="alternate"></link><published>2020-09-27T13:01:00+00:00</published><updated>2021-02-03T11:37:00+00:00</updated><author><name>tperrot</name></author><id>tag:tprrt.tupi.fr,2020-09-27:/build-riot-oswith-podman.html</id><summary type="html">&lt;p class="first last"&gt;This article is a tip that explains how it is possible to build a
&lt;a class="reference external" href="https://github.com/RIOT-OS/RIOT"&gt;RIOT-OS&lt;/a&gt; application with &lt;a class="reference external" href="https://podman.io"&gt;Podman&lt;/a&gt;.&lt;/p&gt;
</summary><content type="html">&lt;div class="section" id="summary"&gt;
&lt;h2&gt;Summary&lt;/h2&gt;
&lt;p&gt;This article is a tip that explains how it is possible to build a &lt;a class="reference external" href="https://github.com/RIOT-OS/RIOT"&gt;RIOT-OS&lt;/a&gt;
application with &lt;a class="reference external" href="https://podman.io"&gt;Podman&lt;/a&gt; and the official build container. And I would like to
take this opportunity to introduce you to &lt;a class="reference external" href="https://podman.io"&gt;Podman&lt;/a&gt; and &lt;a class="reference external" href="https://github.com/RIOT-OS/RIOT"&gt;RIOT-OS&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="podman"&gt;
&lt;h2&gt;Podman&lt;/h2&gt;
&lt;p&gt;Some Linux distribution, like &lt;a class="reference external" href="https://getfedora.org"&gt;Fedora&lt;/a&gt; chosen to officially only support
&lt;a class="reference external" href="https://podman.io"&gt;Podman&lt;/a&gt; instead of &lt;a class="reference external" href="https://www.docker.com"&gt;Docker&lt;/a&gt; for some available reason:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;It is daemonless container engine.&lt;/li&gt;
&lt;li&gt;It is rootless.&lt;/li&gt;
&lt;li&gt;It follows Open Container Initiative (&lt;a class="reference external" href="https://opencontainers.org"&gt;OCI&lt;/a&gt;) standards.&lt;/li&gt;
&lt;li&gt;It is safer than the &lt;a class="reference external" href="https://www.docker.com"&gt;Docker&lt;/a&gt; engine.&lt;/li&gt;
&lt;li&gt;It introduces the notion of &lt;a class="reference external" href="https://kubernetes.io/docs/concepts/workloads/pods"&gt;Pods&lt;/a&gt;: a group of container(s) that share storage
or network resources.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Moreover, &lt;a class="reference external" href="https://podman.io"&gt;Podman&lt;/a&gt; is able to use the images built by the &lt;a class="reference external" href="https://www.docker.com"&gt;Docker&lt;/a&gt; engine and
has been stored in &lt;a class="reference external" href="https://www.docker.com"&gt;Docker&lt;/a&gt; registry.&lt;/p&gt;
&lt;p&gt;However, most of the time the &lt;a class="reference external" href="https://podman.io"&gt;Podman&lt;/a&gt; commands are identical to that of
&lt;a class="reference external" href="https://www.docker.com"&gt;Docker&lt;/a&gt;, the a simple alias is enough to be misleading:
&lt;em&gt;alias docker=podman&lt;/em&gt;.&lt;/p&gt;
&lt;p&gt;But as &lt;a class="reference external" href="https://podman.io"&gt;Podman&lt;/a&gt; is rootless and safer than &lt;a class="reference external" href="https://www.docker.com"&gt;Docker&lt;/a&gt;, then sometimes it is
necessary to specify additional security parameters.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="riot-os"&gt;
&lt;h2&gt;RIOT-OS&lt;/h2&gt;
&lt;p&gt;&lt;a class="reference external" href="https://github.com/RIOT-OS/RIOT"&gt;RIOT-OS&lt;/a&gt; is a memory-constrained &lt;a class="reference external" href="https://en.wikipedia.org/wiki/Real-time_operating_system"&gt;RTOS&lt;/a&gt;, such as &lt;a class="reference external" href="https://en.wikipedia.org/wiki/Contiki"&gt;Contiki&lt;/a&gt;, that provides
real-time and multithreading abilities, and it runs on processors from 8bits to
32bits.&lt;/p&gt;
&lt;p&gt;It was designed for &lt;a class="reference external" href="https://en.wikipedia.org/wiki/Internet_of_things"&gt;IoT&lt;/a&gt; devices then to be low power consumption and it
provides three very complete network stacks including some protocols as:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;a class="reference external" href="https://en.wikipedia.org/wiki/IPv6"&gt;IPv6&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://en.wikipedia.org/wiki/6LoWPAN"&gt;6LoWPAN&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://en.wikipedia.org/wiki/Constrained_Application_Protocol"&gt;CoAP&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;etc.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;The &lt;a class="reference external" href="https://github.com/RIOT-OS/RIOT"&gt;RIOT-OS&lt;/a&gt; project also provides some useful tools including a build
container (&lt;a class="reference external" href="https://github.com/RIOT-OS/riotdocker"&gt;riotdocker&lt;/a&gt;).&lt;/p&gt;
&lt;p&gt;And the build environment of &lt;a class="reference external" href="https://github.com/RIOT-OS/RIOT"&gt;RIOT-OS&lt;/a&gt; offers a &lt;a class="reference external" href="https://en.wikipedia.org/wiki/Makefile"&gt;Makefile&lt;/a&gt; to build an
application with this container simply by setting the variable &lt;em&gt;BUILD_IN_DOCKER&lt;/em&gt;
to  &lt;em&gt;1&lt;/em&gt;. Then the prebuilt image is downloaded and instantiated to execute the
&lt;a class="reference external" href="https://en.wikipedia.org/wiki/Make_(software)"&gt;make&lt;/a&gt; command.&lt;/p&gt;
&lt;p&gt;By default, this feature is configured to be used with the &lt;a class="reference external" href="https://www.docker.com"&gt;Docker&lt;/a&gt; engine,
but it is possible to override some variables from the build environment
either to use a custom prebuilt image, either use another engine or to use
custom engine parameters.&lt;/p&gt;
&lt;p&gt;Then here, we will use these environments variable to instantiate a container
with &lt;a class="reference external" href="https://podman.io"&gt;Podman&lt;/a&gt; (instead of &lt;a class="reference external" href="https://www.docker.com"&gt;Docker&lt;/a&gt;) and with the required parameters.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="tip-of-the-day"&gt;
&lt;h2&gt;Tip of the day&lt;/h2&gt;
&lt;p&gt;In the following example, we build the Helloworld application for a STM32
Discovery board.
To do that we specify the engine by setting the variable &lt;em&gt;DOCKER&lt;/em&gt; to the value
&lt;em&gt;podman&lt;/em&gt;. The variable &lt;em&gt;DOCKER_USER&lt;/em&gt; is set empty because in the variable
&lt;em&gt;DOCKER_RUN_FLAGS&lt;/em&gt; the parameter &lt;em&gt;--userns&lt;/em&gt; is set to &lt;em&gt;keep-id&lt;/em&gt; to map the
uid:gid of the current rootless user (from host) with the values that will be
used into the container.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nb"&gt;export&lt;/span&gt; &lt;span class="nv"&gt;BUILD_IN_DOCKER&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;
&lt;span class="nb"&gt;export&lt;/span&gt; &lt;span class="nv"&gt;DOCKER&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;podman&amp;quot;&lt;/span&gt;
&lt;span class="nb"&gt;export&lt;/span&gt; &lt;span class="nv"&gt;DOCKER_USER&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&amp;quot;&lt;/span&gt;
&lt;span class="nb"&gt;export&lt;/span&gt; &lt;span class="nv"&gt;DOCKER_RUN_FLAGS&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;--rm -i -t --security-opt seccomp=unconfined --security-opt label=disable --userns=keep-id&amp;quot;&lt;/span&gt;
&lt;span class="nb"&gt;export&lt;/span&gt; &lt;span class="nv"&gt;DOCKER_MAKE_ARGS&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;-j&lt;/span&gt;&lt;span class="k"&gt;$(&lt;/span&gt;nproc&lt;span class="k"&gt;)&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;

make &lt;span class="nv"&gt;BOARD&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;stm32l476g-disco
Launching build container using image &lt;span class="s2"&gt;&amp;quot;riot/riotbuild:latest&amp;quot;&lt;/span&gt;.
podman run --rm -i -t --security-opt &lt;span class="nv"&gt;seccomp&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;unconfined --security-opt &lt;span class="nv"&gt;label&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;disable --userns&lt;span class="o"&gt;=&lt;/span&gt;keep-id -v &lt;span class="s1"&gt;&amp;#39;/usr/share/zoneinfo/Europe/Paris:/etc/localtime:ro&amp;#39;&lt;/span&gt; -v &lt;span class="s1"&gt;&amp;#39;/home/tperrot/dev/tprrt/pwm-ramp-gen/RIOT:/data/riotbuild/riotbase:delegated&amp;#39;&lt;/span&gt; -e &lt;span class="s1"&gt;&amp;#39;RIOTBASE=/data/riotbuild/riotbase&amp;#39;&lt;/span&gt; -e &lt;span class="s1"&gt;&amp;#39;CCACHE_BASEDIR=/data/riotbuild/riotbase&amp;#39;&lt;/span&gt; -e &lt;span class="s1"&gt;&amp;#39;BUILD_DIR=/data/riotbuild/riotbase/build&amp;#39;&lt;/span&gt; -v &lt;span class="s1"&gt;&amp;#39;/home/tperrot/dev/tprrt/pwm-ramp-gen:/data/riotbuild/riotproject:delegated&amp;#39;&lt;/span&gt; -e &lt;span class="s1"&gt;&amp;#39;RIOTPROJECT=/data/riotbuild/riotproject&amp;#39;&lt;/span&gt; -e &lt;span class="s1"&gt;&amp;#39;RIOTCPU=/data/riotbuild/riotbase/cpu&amp;#39;&lt;/span&gt; -e &lt;span class="s1"&gt;&amp;#39;RIOTBOARD=/data/riotbuild/riotbase/boards&amp;#39;&lt;/span&gt; -e &lt;span class="s1"&gt;&amp;#39;RIOTMAKE=/data/riotbuild/riotbase/makefiles&amp;#39;&lt;/span&gt;     -v &lt;span class="s1"&gt;&amp;#39;/home/tperrot/dev/tprrt/pwm-ramp-gen/.git:/home/tperrot/dev/tprrt/pwm-ramp-gen/.git:delegated&amp;#39;&lt;/span&gt; -e &lt;span class="s1"&gt;&amp;#39;BOARD=stm32l476g-disco&amp;#39;&lt;/span&gt;  -w &lt;span class="s1"&gt;&amp;#39;/data/riotbuild/riotproject/&amp;#39;&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;riot/riotbuild:latest&amp;#39;&lt;/span&gt; make &lt;span class="s1"&gt;&amp;#39;BOARD=stm32l476g-disco&amp;#39;&lt;/span&gt;   -j8
Building application &lt;span class="s2"&gt;&amp;quot;hello-world&amp;quot;&lt;/span&gt; &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;stm32l476g-disco&amp;quot;&lt;/span&gt; with MCU &lt;span class="s2"&gt;&amp;quot;stm32&amp;quot;&lt;/span&gt;.

&lt;span class="o"&gt;[&lt;/span&gt;INFO&lt;span class="o"&gt;]&lt;/span&gt; cloning stm32cmsis
fatal: not a git repository: /data/riotbuild/riotbase/../.git/modules/RIOT
Cloning into &lt;span class="s1"&gt;&amp;#39;/data/riotbuild/riotbase/cpu/stm32/include/vendor/cmsis/l4&amp;#39;&lt;/span&gt;...
remote: Enumerating objects: &lt;span class="m"&gt;364&lt;/span&gt;, &lt;span class="k"&gt;done&lt;/span&gt;.
remote: Counting objects: &lt;span class="m"&gt;100&lt;/span&gt;% &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="m"&gt;364&lt;/span&gt;/364&lt;span class="o"&gt;)&lt;/span&gt;, &lt;span class="k"&gt;done&lt;/span&gt;.
remote: Compressing objects: &lt;span class="m"&gt;100&lt;/span&gt;% &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="m"&gt;71&lt;/span&gt;/71&lt;span class="o"&gt;)&lt;/span&gt;, &lt;span class="k"&gt;done&lt;/span&gt;.
remote: Total &lt;span class="m"&gt;364&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;delta &lt;span class="m"&gt;309&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;, reused &lt;span class="m"&gt;344&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;delta &lt;span class="m"&gt;289&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;, pack-reused &lt;span class="m"&gt;0&lt;/span&gt;
Receiving objects: &lt;span class="m"&gt;100&lt;/span&gt;% &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="m"&gt;364&lt;/span&gt;/364&lt;span class="o"&gt;)&lt;/span&gt;, &lt;span class="m"&gt;709&lt;/span&gt;.56 KiB &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;561&lt;/span&gt;.00 KiB/s, &lt;span class="k"&gt;done&lt;/span&gt;.
Resolving deltas: &lt;span class="m"&gt;100&lt;/span&gt;% &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="m"&gt;309&lt;/span&gt;/309&lt;span class="o"&gt;)&lt;/span&gt;, &lt;span class="k"&gt;done&lt;/span&gt;.
HEAD is now at e442c72 Release v1.6.1
&lt;span class="o"&gt;[&lt;/span&gt;INFO&lt;span class="o"&gt;]&lt;/span&gt; updating stm32cmsis /data/riotbuild/riotbase/cpu/stm32/include/vendor/cmsis/l4/.pkg-state.git-downloaded
&lt;span class="nb"&gt;echo&lt;/span&gt; e442c72651e8d4757f6562acc14da949644944ce   &amp;gt; /data/riotbuild/riotbase/cpu/stm32/include/vendor/cmsis/l4/.pkg-state.git-downloaded
&lt;span class="o"&gt;[&lt;/span&gt;INFO&lt;span class="o"&gt;]&lt;/span&gt; patch stm32cmsis
&lt;span class="s2"&gt;&amp;quot;make&amp;quot;&lt;/span&gt; -C /data/riotbuild/riotbase/boards/stm32l476g-disco
&lt;span class="s2"&gt;&amp;quot;make&amp;quot;&lt;/span&gt; -C /data/riotbuild/riotbase/core
&lt;span class="s2"&gt;&amp;quot;make&amp;quot;&lt;/span&gt; -C /data/riotbuild/riotbase/cpu/stm32
&lt;span class="s2"&gt;&amp;quot;make&amp;quot;&lt;/span&gt; -C /data/riotbuild/riotbase/drivers
&lt;span class="s2"&gt;&amp;quot;make&amp;quot;&lt;/span&gt; -C /data/riotbuild/riotbase/sys
&lt;span class="s2"&gt;&amp;quot;make&amp;quot;&lt;/span&gt; -C /data/riotbuild/riotbase/cpu/cortexm_common
&lt;span class="s2"&gt;&amp;quot;make&amp;quot;&lt;/span&gt; -C /data/riotbuild/riotbase/cpu/stm32/periph
&lt;span class="s2"&gt;&amp;quot;make&amp;quot;&lt;/span&gt; -C /data/riotbuild/riotbase/drivers/periph_common
&lt;span class="s2"&gt;&amp;quot;make&amp;quot;&lt;/span&gt; -C /data/riotbuild/riotbase/cpu/stm32/stmclk
&lt;span class="s2"&gt;&amp;quot;make&amp;quot;&lt;/span&gt; -C /data/riotbuild/riotbase/sys/auto_init
&lt;span class="s2"&gt;&amp;quot;make&amp;quot;&lt;/span&gt; -C /data/riotbuild/riotbase/cpu/cortexm_common/periph
&lt;span class="s2"&gt;&amp;quot;make&amp;quot;&lt;/span&gt; -C /data/riotbuild/riotbase/cpu/stm32/vectors
&lt;span class="s2"&gt;&amp;quot;make&amp;quot;&lt;/span&gt; -C /data/riotbuild/riotbase/sys/malloc_thread_safe
&lt;span class="s2"&gt;&amp;quot;make&amp;quot;&lt;/span&gt; -C /data/riotbuild/riotbase/sys/newlib_syscalls_default
&lt;span class="s2"&gt;&amp;quot;make&amp;quot;&lt;/span&gt; -C /data/riotbuild/riotbase/sys/pm_layered
&lt;span class="s2"&gt;&amp;quot;make&amp;quot;&lt;/span&gt; -C /data/riotbuild/riotbase/sys/stdio_uart
   text    data     bss     dec     hex filename
   &lt;span class="m"&gt;8900&lt;/span&gt;     &lt;span class="m"&gt;112&lt;/span&gt;    &lt;span class="m"&gt;2300&lt;/span&gt;   &lt;span class="m"&gt;11312&lt;/span&gt;    2c30 /data/riotbuild/riotproject/bin/stm32l476g-disco/hello-world.elf
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
</content><category term="riot-os"></category><category term="container"></category><category term="podman"></category><category term="riot-os"></category></entry><entry><title>How the Busybox's chrt applet works</title><link href="https://tprrt.tupi.fr/busybox-chrt-dissection.html" rel="alternate"></link><published>2020-09-08T19:20:00+00:00</published><updated>2020-09-09T07:05:00+00:00</updated><author><name>tperrot</name></author><id>tag:tprrt.tupi.fr,2020-09-08:/busybox-chrt-dissection.html</id><summary type="html">&lt;p class="first last"&gt;This article details the implementation of the &lt;em&gt;chrt&lt;/em&gt; applet from &lt;a class="reference external" href="https://www.busybox.net"&gt;Busybox&lt;/a&gt;.&lt;/p&gt;
</summary><content type="html">&lt;div class="section" id="introduction"&gt;
&lt;h2&gt;Introduction&lt;/h2&gt;
&lt;p&gt;In this article, I will dissect how the &lt;em&gt;chrt&lt;/em&gt; applet from the release 1.32.0 of &lt;a class="reference external" href="https://www.busybox.net"&gt;Busybox&lt;/a&gt; works, what it does, etc.&lt;/p&gt;
&lt;p&gt;This command is a Linux utils allowing to consult or to modify the scheduling attributes of a process.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;chrt -m
SCHED_OTHER min/max priority    : &lt;span class="m"&gt;0&lt;/span&gt;/0
SCHED_FIFO min/max priority     : &lt;span class="m"&gt;1&lt;/span&gt;/99
SCHED_RR min/max priority       : &lt;span class="m"&gt;1&lt;/span&gt;/99
SCHED_BATCH min/max priority    : &lt;span class="m"&gt;0&lt;/span&gt;/0
SCHED_IDLE min/max priority     : &lt;span class="m"&gt;0&lt;/span&gt;/0
SCHED_DEADLINE min/max priority : &lt;span class="m"&gt;0&lt;/span&gt;/0

pidof firefox
&lt;span class="m"&gt;6987&lt;/span&gt; &lt;span class="m"&gt;6851&lt;/span&gt; &lt;span class="m"&gt;6825&lt;/span&gt; &lt;span class="m"&gt;6816&lt;/span&gt; &lt;span class="m"&gt;6800&lt;/span&gt; &lt;span class="m"&gt;6771&lt;/span&gt; &lt;span class="m"&gt;6767&lt;/span&gt; &lt;span class="m"&gt;6761&lt;/span&gt; &lt;span class="m"&gt;6720&lt;/span&gt; &lt;span class="m"&gt;6611&lt;/span&gt;

chrt -p &lt;span class="m"&gt;6987&lt;/span&gt;
pid &lt;span class="m"&gt;6987&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;s current scheduling policy: SCHED_OTHER&lt;/span&gt;
&lt;span class="s1"&gt;pid 6987&amp;#39;&lt;/span&gt;s current scheduling priority: &lt;span class="m"&gt;0&lt;/span&gt;

sudo chrt -f -p &lt;span class="m"&gt;1&lt;/span&gt; &lt;span class="m"&gt;6987&lt;/span&gt;
chrt -p &lt;span class="m"&gt;6987&lt;/span&gt;
pid &lt;span class="m"&gt;6987&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;s current scheduling policy: SCHED_FIFO&lt;/span&gt;
&lt;span class="s1"&gt;pid 6987&amp;#39;&lt;/span&gt;s current scheduling priority: &lt;span class="m"&gt;1&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;a class="reference external" href="https://www.busybox.net"&gt;Busybox&lt;/a&gt; provides an applet which size, once compiled, and ten times smaller than that of the binary implementation
and with some limitations.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="the-dissection"&gt;
&lt;h2&gt;The dissection&lt;/h2&gt;
&lt;p&gt;The implementation of the &lt;em&gt;chrt&lt;/em&gt; applet is in the file &lt;a class="reference external" href="https://elixir.bootlin.com/busybox/1.32.0/source/util-linux/chrt.c"&gt;util-linux/chrt.c&lt;/a&gt; that containing several functions which are
called in the main function of this applet.&lt;/p&gt;
&lt;p&gt;The main function of this applet is divised in three main parts:
- the first parses the command options
- the second prints the scheduler's information
- the last one, to apply scheduler changes in case of a set&lt;/p&gt;
&lt;p&gt;At start of main, the character string containing the options are parsed to obtain a bitfield easier to use:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="n"&gt;opt&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;getopt32&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;argv&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;^&amp;quot;&lt;/span&gt;
                &lt;span class="s"&gt;&amp;quot;+&amp;quot;&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;mprfobi&amp;quot;&lt;/span&gt;
                &lt;span class="s"&gt;&amp;quot;&lt;/span&gt;&lt;span class="se"&gt;\0&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;&lt;/span&gt;
                &lt;span class="cm"&gt;/* only one policy accepted: */&lt;/span&gt;
                &lt;span class="s"&gt;&amp;quot;r--fobi:f--robi:o--rfbi:b--rfoi:i--rfob&amp;quot;&lt;/span&gt;
&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;If the (-m) is set then the min and max valid priorities for each scheduling policies are shown and the command is existed:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;opt&lt;/span&gt; &lt;span class="o"&gt;&amp;amp;&lt;/span&gt; &lt;span class="n"&gt;OPT_m&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt; &lt;span class="cm"&gt;/* print min/max and exit */&lt;/span&gt;
        &lt;span class="n"&gt;show_min_max&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;SCHED_OTHER&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
        &lt;span class="n"&gt;show_min_max&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;SCHED_FIFO&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
        &lt;span class="n"&gt;show_min_max&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;SCHED_RR&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
        &lt;span class="n"&gt;show_min_max&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;SCHED_BATCH&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
        &lt;span class="n"&gt;show_min_max&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;SCHED_IDLE&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
        &lt;span class="n"&gt;fflush_stdout_and_exit&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;EXIT_SUCCESS&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The function &lt;em&gt;show_min_max&lt;/em&gt; sends use the Posix functions &lt;em&gt;sched_get_priority_max&lt;/em&gt; and &lt;em&gt;sched_get_priority_min&lt;/em&gt; from the
standard C library to send a syscall to the kernel in order to obtain the min and max values accepted by each policy:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="n"&gt;max&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;sched_get_priority_max&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;pol&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;span class="n"&gt;min&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;sched_get_priority_min&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;pol&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;((&lt;/span&gt;&lt;span class="n"&gt;max&lt;/span&gt;&lt;span class="o"&gt;|&lt;/span&gt;&lt;span class="n"&gt;min&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;fmt&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;SCHED_%s not supported&lt;/span&gt;&lt;span class="se"&gt;\n&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Otherwise the required options and arguments to show or to apply real-time attributes of a process:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c1"&gt;//if (opt &amp;amp; OPT_r)&lt;/span&gt;
&lt;span class="c1"&gt;//  policy = SCHED_RR; - default, already set&lt;/span&gt;
&lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;opt&lt;/span&gt; &lt;span class="o"&gt;&amp;amp;&lt;/span&gt; &lt;span class="n"&gt;OPT_f&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;policy&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;SCHED_FIFO&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;opt&lt;/span&gt; &lt;span class="o"&gt;&amp;amp;&lt;/span&gt; &lt;span class="n"&gt;OPT_o&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;policy&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;SCHED_OTHER&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;opt&lt;/span&gt; &lt;span class="o"&gt;&amp;amp;&lt;/span&gt; &lt;span class="n"&gt;OPT_b&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;policy&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;SCHED_BATCH&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;opt&lt;/span&gt; &lt;span class="o"&gt;&amp;amp;&lt;/span&gt; &lt;span class="n"&gt;OPT_i&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;policy&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;SCHED_IDLE&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;

&lt;span class="n"&gt;argv&lt;/span&gt; &lt;span class="o"&gt;+=&lt;/span&gt; &lt;span class="n"&gt;optind&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;!&lt;/span&gt;&lt;span class="n"&gt;argv&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;
    &lt;span class="n"&gt;bb_show_usage&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
&lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;opt&lt;/span&gt; &lt;span class="o"&gt;&amp;amp;&lt;/span&gt; &lt;span class="n"&gt;OPT_p&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="n"&gt;pid_str&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;argv&lt;/span&gt;&lt;span class="o"&gt;++&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
    &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;argv&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt; &lt;span class="cm"&gt;/* &amp;quot;-p PRIO PID [...]&amp;quot; */&lt;/span&gt;
            &lt;span class="n"&gt;priority&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;pid_str&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
            &lt;span class="n"&gt;pid_str&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;argv&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
    &lt;span class="p"&gt;}&lt;/span&gt;
    &lt;span class="cm"&gt;/* else &amp;quot;-p PID&amp;quot;, and *argv == NULL */&lt;/span&gt;
    &lt;span class="n"&gt;pid&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;xatoul_range&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;pid_str&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="p"&gt;((&lt;/span&gt;&lt;span class="kt"&gt;unsigned&lt;/span&gt;&lt;span class="p"&gt;)(&lt;/span&gt;&lt;span class="kt"&gt;pid_t&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="n"&gt;ULONG_MAX&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt; &lt;span class="k"&gt;else&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="n"&gt;priority&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;argv&lt;/span&gt;&lt;span class="o"&gt;++&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
    &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;!*&lt;/span&gt;&lt;span class="n"&gt;argv&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
            &lt;span class="n"&gt;bb_show_usage&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Then the applet uses the Posix function &lt;em&gt;sched_getscheduler&lt;/em&gt; provides by the standard C library to obtain the scheduling attributes of the process specified by the pid.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nl"&gt;print_rt_info&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
    &lt;span class="n"&gt;pol&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;sched_getscheduler&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;pid&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
    &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;pol&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
            &lt;span class="n"&gt;bb_perror_msg_and_die&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;can&amp;#39;t %cet pid %u&amp;#39;s policy&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="sc"&gt;&amp;#39;g&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kt"&gt;int&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="n"&gt;pid&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Finally, when the &lt;em&gt;chrt&lt;/em&gt; applet is used to modify scheduling attributes then the Posix function &lt;em&gt;sched_getscheduler&lt;/em&gt; is used and the new scheduling attributes are showed:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;sched_setscheduler&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;pid&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;policy&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;&amp;amp;&lt;/span&gt;&lt;span class="n"&gt;sp&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;bb_perror_msg_and_die&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;can&amp;#39;t %cet pid %u&amp;#39;s policy&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="sc"&gt;&amp;#39;s&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kt"&gt;int&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="n"&gt;pid&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;

&lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;!&lt;/span&gt;&lt;span class="n"&gt;argv&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt; &lt;span class="cm"&gt;/* &amp;quot;-p PRIO PID [...]&amp;quot; */&lt;/span&gt;
    &lt;span class="k"&gt;goto&lt;/span&gt; &lt;span class="n"&gt;print_rt_info&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The function &lt;em&gt;sched_getscheduler&lt;/em&gt; and &lt;em&gt;sched_getscheduler&lt;/em&gt; will send a syscall to the scheduler subsystem of the kernel Linux.
This subsystem also exposes this information from &lt;em&gt;/proc&lt;/em&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;cat /proc/6987/sched
WebExtensions &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="m"&gt;6987&lt;/span&gt;, &lt;span class="c1"&gt;#threads: 23)&lt;/span&gt;
-------------------------------------------------------------------
se.exec_start                                :       &lt;span class="m"&gt;4421312&lt;/span&gt;.640001
se.vruntime                                  :        &lt;span class="m"&gt;344438&lt;/span&gt;.942254
se.sum_exec_runtime                          :         &lt;span class="m"&gt;38238&lt;/span&gt;.466094
se.nr_migrations                             :                 &lt;span class="m"&gt;6811&lt;/span&gt;
nr_switches                                  :                &lt;span class="m"&gt;49452&lt;/span&gt;
nr_voluntary_switches                        :                &lt;span class="m"&gt;21749&lt;/span&gt;
nr_involuntary_switches                      :                &lt;span class="m"&gt;27703&lt;/span&gt;
se.load.weight                               :              &lt;span class="m"&gt;1048576&lt;/span&gt;
se.runnable_weight                           :              &lt;span class="m"&gt;1048576&lt;/span&gt;
se.avg.load_sum                              :                 &lt;span class="m"&gt;3415&lt;/span&gt;
se.avg.runnable_load_sum                     :                 &lt;span class="m"&gt;3415&lt;/span&gt;
se.avg.util_sum                              :              &lt;span class="m"&gt;3497621&lt;/span&gt;
se.avg.load_avg                              :                   &lt;span class="m"&gt;74&lt;/span&gt;
se.avg.runnable_load_avg                     :                   &lt;span class="m"&gt;74&lt;/span&gt;
se.avg.util_avg                              :                   &lt;span class="m"&gt;74&lt;/span&gt;
se.avg.last_update_time                      :        &lt;span class="m"&gt;4421312640000&lt;/span&gt;
se.avg.util_est.ewma                         :                   &lt;span class="m"&gt;75&lt;/span&gt;
se.avg.util_est.enqueued                     :                   &lt;span class="m"&gt;75&lt;/span&gt;
policy                                       :                    &lt;span class="m"&gt;0&lt;/span&gt;
prio                                         :                  &lt;span class="m"&gt;120&lt;/span&gt;
clock-delta                                  :                   &lt;span class="m"&gt;89&lt;/span&gt;
mm-&amp;gt;numa_scan_seq                            :                    &lt;span class="m"&gt;0&lt;/span&gt;
numa_pages_migrated                          :                    &lt;span class="m"&gt;0&lt;/span&gt;
numa_preferred_nid                           :                   -1
total_numa_faults                            :                    &lt;span class="m"&gt;0&lt;/span&gt;
&lt;span class="nv"&gt;current_node&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;, &lt;span class="nv"&gt;numa_group_id&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;
numa_faults &lt;span class="nv"&gt;node&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt; &lt;span class="nv"&gt;task_private&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt; &lt;span class="nv"&gt;task_shared&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt; &lt;span class="nv"&gt;group_private&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt; &lt;span class="nv"&gt;group_shared&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="limitations"&gt;
&lt;h2&gt;Limitations&lt;/h2&gt;
&lt;p&gt;Below a short list of limitations that I observed during my analysis of this applet.&lt;/p&gt;
&lt;div class="section" id="resetting-scheduling-policy"&gt;
&lt;h3&gt;Resetting scheduling policy&lt;/h3&gt;
&lt;p&gt;The &lt;em&gt;chrt&lt;/em&gt; applet doesn't offer an option (-R) to specify if the scheduling policy should be applied or reseted when a
process is fork to create children. This feature, introduced since Linux 2.6.32, can be only enabled or disabled at the
build of busybox and it is applied on all scheduling attributes modifications done with this applet.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="deadline-support"&gt;
&lt;h3&gt;Deadline support&lt;/h3&gt;
&lt;p&gt;The &lt;em&gt;chrt&lt;/em&gt; applet doesn't provide the required scheduling options (-d, -T, -P and -D) to set the deadline scheduling attributes of a process.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
</content><category term="busybox"></category><category term="busybox"></category><category term="chrt"></category><category term="dissection"></category><category term="beginner"></category></entry><entry><title>Build an embedded Linux in less than 15 minutes</title><link href="https://tprrt.tupi.fr/build-an-embedded-linux-in-fifteen-min.html" rel="alternate"></link><published>2020-06-27T13:01:00+00:00</published><updated>2020-11-30T16:11:00+00:00</updated><author><name>tperrot</name></author><id>tag:tprrt.tupi.fr,2020-06-27:/build-an-embedded-linux-in-fifteen-min.html</id><summary type="html">&lt;p class="first last"&gt;This article will explain how to build a minimal embedded Linux, in less than 15 minutes, and without a build framework.&lt;/p&gt;
</summary><content type="html">&lt;div class="section" id="introduction"&gt;
&lt;h2&gt;Introduction&lt;/h2&gt;
&lt;p&gt;Since some years, I no longer built a embedded Linux without using a framework, like &lt;a class="reference external" href="https://openembedded.org"&gt;Open Embedded&lt;/a&gt; from the &lt;a class="reference external" href="https://yoctoproject.org"&gt;Yocto&lt;/a&gt;
project.
Then here, I wanted to make a guide to help you to build quickly, from &amp;quot;scratch&amp;quot; a very minimal embedded Linux to boot a
target.
The following examples have been writen to boot a virtual Qemu target but, they can be adapted to boot a real target.
Moreover, the build environment will be boot strapped with a prebuilt cross-toolchain, I have chosen to use one provided
by &lt;a class="reference external" href="https://toolchains.bootlin.com"&gt;Bootlin&lt;/a&gt; and using glibc.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="setup-the-environment"&gt;
&lt;h2&gt;Setup the environment&lt;/h2&gt;
&lt;p&gt;First, It is required to install the packages that are needed to install and use the cross-toolchain but also to compile the host tools and to provide Qemu:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;The Ncurses libraries are only required to execute the command &lt;cite&gt;make menuconfig&lt;/cite&gt;.&lt;/li&gt;
&lt;li&gt;The certificates and wget will be used to download the prebuilt toolchain.&lt;/li&gt;
&lt;li&gt;In the same way, git will be used to checkout the source of &lt;a class="reference external" href="https://busybox.net"&gt;Busybox&lt;/a&gt; and &lt;a class="reference external" href="https://www.kernel.org"&gt;Linux&lt;/a&gt;.&lt;/li&gt;
&lt;li&gt;The Qemu packages will be used to emulate systeme platform and to execute static binaries cross-compiled for aarch64 on the x86-64 host.&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;apt update
apt install -y --no-install-recommends &lt;span class="se"&gt;\&lt;/span&gt;
    bc &lt;span class="se"&gt;\&lt;/span&gt;
    build-essential &lt;span class="se"&gt;\&lt;/span&gt;
    ca-certificates &lt;span class="se"&gt;\&lt;/span&gt;
    cpio &lt;span class="se"&gt;\&lt;/span&gt;
    file &lt;span class="se"&gt;\&lt;/span&gt;
    flex &lt;span class="se"&gt;\&lt;/span&gt;
    git &lt;span class="se"&gt;\&lt;/span&gt;
    ipxe-qemu &lt;span class="se"&gt;\&lt;/span&gt;
    libncurses5-dev &lt;span class="se"&gt;\&lt;/span&gt;
    libncursesw5-dev &lt;span class="se"&gt;\&lt;/span&gt;
    libssl-dev &lt;span class="se"&gt;\&lt;/span&gt;
    qemu &lt;span class="se"&gt;\&lt;/span&gt;
    qemu-system-aarch64 &lt;span class="se"&gt;\&lt;/span&gt;
    qemu-user-static &lt;span class="se"&gt;\&lt;/span&gt;
    wget
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Now, it is time to download and install the prebuild toolchain:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;mkdir ~/src
&lt;span class="nb"&gt;cd&lt;/span&gt; ~/src
wget https://toolchains.bootlin.com/downloads/releases/toolchains/aarch64/tarballs/aarch64--glibc--stable-2020.08-1.tar.bz2
tar xvjf aarch64--glibc--stable-2020.08-1.tar.bz2
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Once the toolchain has been extracted you have to set the required environment variables to cross-compile binaries:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;PATH&lt;/tt&gt;: It shall be extended then the cross-tools from the cross-toolchain will be available from the environment&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;CROSS_COMPILE&lt;/tt&gt;: In order to clarify the prefix used by the cross-tools&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;ARCH&lt;/tt&gt;: The architecture of the target platform&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;ls ~/src/aarch64--glibc--stable-2020.08-1/bin/*gcc
~/src/aarch64--glibc--stable-2020.08-1/bin/aarch64-linux-gcc

&lt;span class="nb"&gt;export&lt;/span&gt; &lt;span class="nb"&gt;export&lt;/span&gt; &lt;span class="nv"&gt;PATH&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;~/src/aarch64--glibc--stable-2020.08-1/bin:&lt;span class="nv"&gt;$PATH&lt;/span&gt;
&lt;span class="nb"&gt;export&lt;/span&gt; &lt;span class="nv"&gt;CROSS_COMPILE&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;aarch64-linux-
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Now, it is possible to call the cross-tools from the shell:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;aarch64-linux-gcc -v
Using built-in specs.
&lt;span class="nv"&gt;COLLECT_GCC&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;~/src/aarch64--glibc--stable-2020.08-1/bin/aarch64-linux-gcc.br_real
&lt;span class="nv"&gt;COLLECT_LTO_WRAPPER&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;~/src/aarch64--glibc--stable-2020.08-1/bin/../libexec/gcc/aarch64-buildroot-linux-gnu/9.3.0/lto-wrapper
Target: aarch64-buildroot-linux-gnu
&amp;lt;...&amp;gt;
Thread model: posix
gcc version &lt;span class="m"&gt;9&lt;/span&gt;.3.0 &lt;span class="o"&gt;(&lt;/span&gt;Buildroot &lt;span class="m"&gt;2020&lt;/span&gt;.08-14-ge5a2a90&lt;span class="o"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Concerning the variable &lt;tt class="docutils literal"&gt;PATH&lt;/tt&gt; this one will be set afterwards because its value depends of the binary that will be built.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="build-the-linux-kernel"&gt;
&lt;h2&gt;Build the Linux kernel&lt;/h2&gt;
&lt;p&gt;So, the environment is ready to pull the sources of the latest stable branch of the kernel &lt;a class="reference external" href="https://www.kernel.org"&gt;Linux&lt;/a&gt; and to build them:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;git clone git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git
&lt;span class="nb"&gt;cd&lt;/span&gt; linux
git checkout -b local/linux-5.4.y origin/linux-5.4.y
&lt;span class="c1"&gt;# git show HEAD&lt;/span&gt;

&lt;span class="nb"&gt;export&lt;/span&gt; &lt;span class="nv"&gt;ARCH&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;arm64

make defconfig
  HOSTCC  scripts/basic/fixdep
  HOSTCC  scripts/kconfig/conf.o
  HOSTCC  scripts/kconfig/confdata.o
  HOSTCC  scripts/kconfig/expr.o
  LEX     scripts/kconfig/lexer.lex.c
  YACC    scripts/kconfig/parser.tab.&lt;span class="o"&gt;[&lt;/span&gt;ch&lt;span class="o"&gt;]&lt;/span&gt;
  HOSTCC  scripts/kconfig/lexer.lex.o
  HOSTCC  scripts/kconfig/parser.tab.o
  HOSTCC  scripts/kconfig/preprocess.o
  HOSTCC  scripts/kconfig/symbol.o
  HOSTLD  scripts/kconfig/conf
*** Default configuration is based on &lt;span class="s1"&gt;&amp;#39;defconfig&amp;#39;&lt;/span&gt;
&lt;span class="c1"&gt;#&lt;/span&gt;
&lt;span class="c1"&gt;# configuration written to .config&lt;/span&gt;
&lt;span class="c1"&gt;#&lt;/span&gt;

&lt;span class="c1"&gt;# make menuconfig&lt;/span&gt;

make -j&lt;span class="k"&gt;$(&lt;/span&gt;nproc&lt;span class="k"&gt;)&lt;/span&gt;
  &amp;lt;...&amp;gt;
  AR      drivers/net/ethernet/built-in.a
  AR      drivers/net/built-in.a
  AR      drivers/built-in.a
  GEN     .version
  CHK     include/generated/compile.h
  LD      vmlinux.o
  MODPOST vmlinux.o
  MODINFO modules.builtin.modinfo
  LD      .tmp_vmlinux.kallsyms1
  KSYM    .tmp_vmlinux.kallsyms1.o
  LD      .tmp_vmlinux.kallsyms2
  KSYM    .tmp_vmlinux.kallsyms2.o
  LD      vmlinux
  SORTEX  vmlinux
  SYSMAP  System.map
  Building modules, stage &lt;span class="m"&gt;2&lt;/span&gt;.
  MODPOST &lt;span class="m"&gt;531&lt;/span&gt; modules
  OBJCOPY arch/arm64/boot/Image
  GZIP    arch/arm64/boot/Image.gz
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The command &lt;tt class="docutils literal"&gt;make defconfig&lt;/tt&gt; will apply the default configuration for the target platform (cf. &lt;tt class="docutils literal"&gt;ARCH=arm64&lt;/tt&gt;), and the
compilation will be performed by &lt;tt class="docutils literal"&gt;make &lt;span class="pre"&gt;-j$(nproc)&lt;/span&gt;&lt;/tt&gt;.&lt;/p&gt;
&lt;p&gt;The commands &lt;tt class="docutils literal"&gt;git show HEAD&lt;/tt&gt; and &lt;tt class="docutils literal"&gt;make defconfig&lt;/tt&gt; are optional:
- the first is usefull to verify that the latest commit corresponding to the latest tag of the branch &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;linux-5.4.y&lt;/span&gt;&lt;/tt&gt;.
- the second can be used if you want to customize the kernel configuration.&lt;/p&gt;
&lt;p&gt;&lt;em&gt;NB&lt;/em&gt;. The kernel &lt;a class="reference external" href="https://www.kernel.org"&gt;Linux&lt;/a&gt; but also &lt;a class="reference external" href="https://busybox.net"&gt;Busybox&lt;/a&gt; and some projects use &lt;a class="reference external" href="https://www.kernel.org/doc/html/latest/kbuild/kbuild.html"&gt;Kbuild&lt;/a&gt; to manage the build options&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="populate-the-sysroot"&gt;
&lt;h2&gt;Populate the sysroot&lt;/h2&gt;
&lt;p&gt;The easy way to bootstrap a sysroot is to use &lt;a class="reference external" href="https://busybox.net"&gt;Busybox&lt;/a&gt; that has been created to offer common UNIX tools into a single
executable and it has size-optimized. To create a sysroot, it is only required to add a few configuration files.&lt;/p&gt;
&lt;p&gt;The steps to pull and build &lt;a class="reference external" href="https://busybox.net"&gt;Busybox&lt;/a&gt; are similar to those of the kernel &lt;a class="reference external" href="https://www.kernel.org"&gt;Linux&lt;/a&gt;.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;git clone git://git.busybox.net/busybox
&lt;span class="nb"&gt;cd&lt;/span&gt; busybox
git checkout -b local/1_32_stable origin/1_32_stable
&lt;span class="c1"&gt;# git show HEAD&lt;/span&gt;

&lt;span class="nb"&gt;export&lt;/span&gt; &lt;span class="nv"&gt;ARCH&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;aarch64
&lt;span class="nb"&gt;export&lt;/span&gt; &lt;span class="nv"&gt;LDFLAGS&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;--static&amp;quot;&lt;/span&gt;

make defconfig
&lt;span class="c1"&gt;# make menuconfig&lt;/span&gt;
make -j&lt;span class="k"&gt;$(&lt;/span&gt;nproc&lt;span class="k"&gt;)&lt;/span&gt;

make install
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Here, the &lt;em&gt;LDFLAGS&lt;/em&gt; is set to force the static link of &lt;a class="reference external" href="https://busybox.net"&gt;Busybox&lt;/a&gt; quickly, but it is also possible to use
&lt;em&gt;make menuconfig&lt;/em&gt; to set &lt;em&gt;CONFIG_STATIC=y&lt;/em&gt;. The advantage of the static executable is that it can be tested with Qemu:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;qemu-aarch64-static busybox &lt;span class="nb"&gt;echo&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;Hello!&amp;quot;&lt;/span&gt;
Hello!
qemu-aarch64-static busybox date
Sat Jun &lt;span class="m"&gt;27&lt;/span&gt; &lt;span class="m"&gt;15&lt;/span&gt;:06:41 UTC &lt;span class="m"&gt;2020&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The binary &lt;em&gt;qemu-aarch64-static&lt;/em&gt; allows to execute a binary built for another architecture on the host computer, for
example here it allows to execute the &lt;a class="reference external" href="https://busybox.net"&gt;Busybox&lt;/a&gt; binary compiled for an aarch64 target on a x86-64 host.&lt;/p&gt;
&lt;p&gt;The last command &lt;em&gt;make install&lt;/em&gt; created a tree into the &lt;em&gt;_install&lt;/em&gt; directory that can be used to populate the sysroot:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;ls -l _install
total &lt;span class="m"&gt;4&lt;/span&gt;
drwxr-xr-x. &lt;span class="m"&gt;1&lt;/span&gt; tperrot tperrot &lt;span class="m"&gt;974&lt;/span&gt; Nov &lt;span class="m"&gt;30&lt;/span&gt; &lt;span class="m"&gt;15&lt;/span&gt;:22 bin
lrwxrwxrwx. &lt;span class="m"&gt;1&lt;/span&gt; tperrot tperrot  &lt;span class="m"&gt;11&lt;/span&gt; Nov &lt;span class="m"&gt;30&lt;/span&gt; &lt;span class="m"&gt;15&lt;/span&gt;:22 linuxrc -&amp;gt; bin/busybox
drwxr-xr-x. &lt;span class="m"&gt;1&lt;/span&gt; tperrot tperrot &lt;span class="m"&gt;986&lt;/span&gt; Nov &lt;span class="m"&gt;30&lt;/span&gt; &lt;span class="m"&gt;15&lt;/span&gt;:22 sbin
drwxr-xr-x. &lt;span class="m"&gt;1&lt;/span&gt; tperrot tperrot  &lt;span class="m"&gt;14&lt;/span&gt; Nov &lt;span class="m"&gt;30&lt;/span&gt; &lt;span class="m"&gt;15&lt;/span&gt;:22 usr

ls -l _install/bin
&amp;lt;...&amp;gt;
lrwxrwxrwx. &lt;span class="m"&gt;1&lt;/span&gt; tperrot tperrot       &lt;span class="m"&gt;7&lt;/span&gt; Nov &lt;span class="m"&gt;30&lt;/span&gt; &lt;span class="m"&gt;15&lt;/span&gt;:22 umount -&amp;gt; busybox
lrwxrwxrwx. &lt;span class="m"&gt;1&lt;/span&gt; tperrot tperrot       &lt;span class="m"&gt;7&lt;/span&gt; Nov &lt;span class="m"&gt;30&lt;/span&gt; &lt;span class="m"&gt;15&lt;/span&gt;:22 uname -&amp;gt; busybox
lrwxrwxrwx. &lt;span class="m"&gt;1&lt;/span&gt; tperrot tperrot       &lt;span class="m"&gt;7&lt;/span&gt; Nov &lt;span class="m"&gt;30&lt;/span&gt; &lt;span class="m"&gt;15&lt;/span&gt;:22 usleep -&amp;gt; busybox
lrwxrwxrwx. &lt;span class="m"&gt;1&lt;/span&gt; tperrot tperrot       &lt;span class="m"&gt;7&lt;/span&gt; Nov &lt;span class="m"&gt;30&lt;/span&gt; &lt;span class="m"&gt;15&lt;/span&gt;:22 vi -&amp;gt; busybox
lrwxrwxrwx. &lt;span class="m"&gt;1&lt;/span&gt; tperrot tperrot       &lt;span class="m"&gt;7&lt;/span&gt; Nov &lt;span class="m"&gt;30&lt;/span&gt; &lt;span class="m"&gt;15&lt;/span&gt;:22 watch -&amp;gt; busybox
lrwxrwxrwx. &lt;span class="m"&gt;1&lt;/span&gt; tperrot tperrot       &lt;span class="m"&gt;7&lt;/span&gt; Nov &lt;span class="m"&gt;30&lt;/span&gt; &lt;span class="m"&gt;15&lt;/span&gt;:22 zcat -&amp;gt; busybox
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;In order, to finalize this minimal sysroot, it is required to create a rcS init script:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;mkdir _install/proc _install/sys _install/dev _install/etc _install/etc/init.d
cat &amp;gt; _install/etc/init.d/rcS &lt;span class="s"&gt;&amp;lt;&amp;lt; EOF&lt;/span&gt;
&lt;span class="s"&gt;#!/bin/sh&lt;/span&gt;
&lt;span class="s"&gt;mount -t proc none /proc&lt;/span&gt;
&lt;span class="s"&gt;mount -t sysfs none /sys&lt;/span&gt;
&lt;span class="s"&gt;/sbin/mdev -s&lt;/span&gt;
&lt;span class="s"&gt;[ ! -h /etc/mtab ]  &amp;amp;&amp;amp; ln -s /proc/mounts /etc/mtab&lt;/span&gt;
&lt;span class="s"&gt;[ ! -f /etc/resolv.conf ] &amp;amp;&amp;amp; cat /proc/net/pnp &amp;gt; /etc/resolv.conf&lt;/span&gt;
&lt;span class="s"&gt;EOF&lt;/span&gt;
chmod +x _install/etc/init.d/rcS
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="build-the-filesystem"&gt;
&lt;h2&gt;Build the filesystem&lt;/h2&gt;
&lt;p&gt;The target of this step is to package the sysroot tree into a filesystem that can be mounted by the kernel.
There is two available possibilities, either build a &lt;em&gt;ramfs&lt;/em&gt; or a &lt;em&gt;rootfs&lt;/em&gt;.&lt;/p&gt;
&lt;p&gt;Globally, the difference between both is that:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;the ramfs is a very simple filesystem that can be used by the kernel to create a block device into the RAM space from an archive.&lt;/li&gt;
&lt;li&gt;the rootfs is a filesystem mounted from a non volatile device by the kernel.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;For more information about the difference between the ramfs and the rootfs, you can you refer to the &lt;a class="reference external" href="https://www.kernel.org/doc/html/latest/filesystems/ramfs-rootfs-initramfs.html"&gt;kernel documentation&lt;/a&gt;.&lt;/p&gt;
&lt;div class="section" id="build-a-ramfs"&gt;
&lt;h3&gt;Build a ramfs&lt;/h3&gt;
&lt;p&gt;To build the ramfs we will use &lt;em&gt;cpio&lt;/em&gt; and &lt;em&gt;gzip&lt;/em&gt; to construct the compressed archive after modifying the rights:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;mkdir _rootfs
rsync -a _install/ _rootfs
chown -R root:root _rootfs
&lt;span class="nb"&gt;cd&lt;/span&gt; _rootfs
find . &lt;span class="p"&gt;|&lt;/span&gt; cpio -o --format&lt;span class="o"&gt;=&lt;/span&gt;newc &amp;gt; ../rootfs.cpio
&lt;span class="nb"&gt;cd&lt;/span&gt; ..
gzip -c rootfs.cpio &amp;gt; rootfs.cpio.gz
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="build-a-rootfs"&gt;
&lt;h3&gt;Build a rootfs&lt;/h3&gt;
&lt;p&gt;To build the rootfs, the first step is to create an empty binary blob that will be mounted into a loop device to be
formated to create a ext3 filesytem. Then the tree can be copied and the rights updated.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;dd &lt;span class="k"&gt;if&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;/dev/zero &lt;span class="nv"&gt;of&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;rootfs.img &lt;span class="nv"&gt;bs&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;1M &lt;span class="nv"&gt;count&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="m"&gt;10&lt;/span&gt;
mke2fs -j rootfs.img
mkdir _rootfs
mount -o loop rootfs.img _rootfs
rsync -a _install/ _rootfs
chown -R root:root _rootfs
sync
umount _rootfs
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="boot-the-target"&gt;
&lt;h2&gt;Boot the target&lt;/h2&gt;
&lt;p&gt;Following, the qemu commands to boot the minimal embedded Linux system that has been built.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c1"&gt;# With the ramfs&lt;/span&gt;
qemu-system-aarch64 -nographic -no-reboot -machine virt -cpu cortex-a57 -smp &lt;span class="m"&gt;2&lt;/span&gt; -m &lt;span class="m"&gt;256&lt;/span&gt; &lt;span class="se"&gt;\&lt;/span&gt;
    -kernel ~/src/linux/arch/arm64/boot/Image &lt;span class="se"&gt;\&lt;/span&gt;
    -initrd ~/src/busybox/rootfs.cpio.gz &lt;span class="se"&gt;\&lt;/span&gt;
    -append &lt;span class="s2"&gt;&amp;quot;panic=5 ro ip=dhcp root=/dev/ram rdinit=/sbin/init&amp;quot;&lt;/span&gt;

&lt;span class="c1"&gt;# With the rootfs&lt;/span&gt;
qemu-system-aarch64 -nographic -no-reboot -machine virt -cpu cortex-a57 -smp &lt;span class="m"&gt;2&lt;/span&gt; -m &lt;span class="m"&gt;256&lt;/span&gt; &lt;span class="se"&gt;\&lt;/span&gt;
    -kernel ~/src/linux/arch/arm64/boot/Image &lt;span class="se"&gt;\&lt;/span&gt;
    -append &lt;span class="s2"&gt;&amp;quot;panic=5 ro ip=dhcp root=/dev/vda&amp;quot;&lt;/span&gt; &lt;span class="se"&gt;\&lt;/span&gt;
    -drive &lt;span class="nv"&gt;file&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;~/src/busybox/rootfs.img,format&lt;span class="o"&gt;=&lt;/span&gt;raw,if&lt;span class="o"&gt;=&lt;/span&gt;none,id&lt;span class="o"&gt;=&lt;/span&gt;hd0 -device virtio-blk-device,drive&lt;span class="o"&gt;=&lt;/span&gt;hd0
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Then the target will be boot to shell, &lt;em&gt;&amp;quot;It's alive!&amp;quot;&lt;/em&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;    &lt;span class="m"&gt;0&lt;/span&gt;.000000&lt;span class="o"&gt;]&lt;/span&gt; Booting Linux on physical CPU 0x0000000000 &lt;span class="o"&gt;[&lt;/span&gt;0x411fd070&lt;span class="o"&gt;]&lt;/span&gt;
&lt;span class="o"&gt;[&lt;/span&gt;    &lt;span class="m"&gt;0&lt;/span&gt;.000000&lt;span class="o"&gt;]&lt;/span&gt; Linux version &lt;span class="m"&gt;5&lt;/span&gt;.10.0-rc5 &lt;span class="o"&gt;(&lt;/span&gt;tperrot@27ea4a863f61&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;aarch64-linux-gcc.br_real &lt;span class="o"&gt;(&lt;/span&gt;Buildroot &lt;span class="m"&gt;2020&lt;/span&gt;.08-14-ge5a2a90&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="m"&gt;9&lt;/span&gt;.3.0, GNU ld &lt;span class="o"&gt;(&lt;/span&gt;GNU Binutils&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="m"&gt;2&lt;/span&gt;.33.1&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="c1"&gt;#1 SMP PREEMPT Mon Nov 30 14:40:05 UTC 2020&lt;/span&gt;
&lt;span class="o"&gt;[&lt;/span&gt;    &lt;span class="m"&gt;0&lt;/span&gt;.000000&lt;span class="o"&gt;]&lt;/span&gt; Machine model: linux,dummy-virt
&amp;lt;...&amp;gt;
&lt;span class="o"&gt;[&lt;/span&gt;    &lt;span class="m"&gt;0&lt;/span&gt;.858346&lt;span class="o"&gt;]&lt;/span&gt; Sending DHCP requests ., OK
&lt;span class="o"&gt;[&lt;/span&gt;    &lt;span class="m"&gt;0&lt;/span&gt;.870558&lt;span class="o"&gt;]&lt;/span&gt; IP-Config: Got DHCP answer from &lt;span class="m"&gt;10&lt;/span&gt;.0.2.2, my address is &lt;span class="m"&gt;10&lt;/span&gt;.0.2.15
&lt;span class="o"&gt;[&lt;/span&gt;    &lt;span class="m"&gt;0&lt;/span&gt;.870909&lt;span class="o"&gt;]&lt;/span&gt; IP-Config: Complete:
&lt;span class="o"&gt;[&lt;/span&gt;    &lt;span class="m"&gt;0&lt;/span&gt;.871199&lt;span class="o"&gt;]&lt;/span&gt;      &lt;span class="nv"&gt;device&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;eth0, &lt;span class="nv"&gt;hwaddr&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="m"&gt;52&lt;/span&gt;:54:00:12:34:56, &lt;span class="nv"&gt;ipaddr&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="m"&gt;10&lt;/span&gt;.0.2.15, &lt;span class="nv"&gt;mask&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="m"&gt;255&lt;/span&gt;.255.255.0, &lt;span class="nv"&gt;gw&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="m"&gt;10&lt;/span&gt;.0.2.2
&lt;span class="o"&gt;[&lt;/span&gt;    &lt;span class="m"&gt;0&lt;/span&gt;.871566&lt;span class="o"&gt;]&lt;/span&gt;      &lt;span class="nv"&gt;host&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="m"&gt;10&lt;/span&gt;.0.2.15, &lt;span class="nv"&gt;domain&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;, nis-domain&lt;span class="o"&gt;=(&lt;/span&gt;none&lt;span class="o"&gt;)&lt;/span&gt;
&lt;span class="o"&gt;[&lt;/span&gt;    &lt;span class="m"&gt;0&lt;/span&gt;.871825&lt;span class="o"&gt;]&lt;/span&gt;      &lt;span class="nv"&gt;bootserver&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="m"&gt;10&lt;/span&gt;.0.2.2, &lt;span class="nv"&gt;rootserver&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="m"&gt;10&lt;/span&gt;.0.2.2, &lt;span class="nv"&gt;rootpath&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;
&lt;span class="o"&gt;[&lt;/span&gt;    &lt;span class="m"&gt;0&lt;/span&gt;.871866&lt;span class="o"&gt;]&lt;/span&gt;      &lt;span class="nv"&gt;nameserver0&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="m"&gt;10&lt;/span&gt;.0.2.3
&lt;span class="o"&gt;[&lt;/span&gt;    &lt;span class="m"&gt;0&lt;/span&gt;.872389&lt;span class="o"&gt;]&lt;/span&gt;
&lt;span class="o"&gt;[&lt;/span&gt;    &lt;span class="m"&gt;0&lt;/span&gt;.875863&lt;span class="o"&gt;]&lt;/span&gt; ALSA device list:
&lt;span class="o"&gt;[&lt;/span&gt;    &lt;span class="m"&gt;0&lt;/span&gt;.876151&lt;span class="o"&gt;]&lt;/span&gt;   No soundcards found.
&lt;span class="o"&gt;[&lt;/span&gt;    &lt;span class="m"&gt;0&lt;/span&gt;.879353&lt;span class="o"&gt;]&lt;/span&gt; uart-pl011 &lt;span class="m"&gt;9000000&lt;/span&gt;.pl011: no DMA platform data
&lt;span class="o"&gt;[&lt;/span&gt;    &lt;span class="m"&gt;0&lt;/span&gt;.920237&lt;span class="o"&gt;]&lt;/span&gt; Freeing unused kernel memory: 5952K
&lt;span class="o"&gt;[&lt;/span&gt;    &lt;span class="m"&gt;0&lt;/span&gt;.921223&lt;span class="o"&gt;]&lt;/span&gt; Run /sbin/init as init process

Please press Enter to activate this console.
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
</content><category term="linux"></category><category term="busybox"></category><category term="embedded"></category><category term="intermediate"></category><category term="linux"></category><category term="qemu"></category></entry><entry><title>My blog opening</title><link href="https://tprrt.tupi.fr/my-blog-opening.html" rel="alternate"></link><published>2020-05-28T16:50:00+00:00</published><updated>2020-05-28T16:50:00+00:00</updated><author><name>tperrot</name></author><id>tag:tprrt.tupi.fr,2020-05-28:/my-blog-opening.html</id><summary type="html">&lt;p class="first last"&gt;Why do I choose to open a new blog and a quick description about the subject that will be treated.&lt;/p&gt;
</summary><content type="html">&lt;p&gt;Welcome,&lt;/p&gt;
&lt;p&gt;After closing my last blog since seventeen years, in order to share my knowledges and my little experiments about
embedded open source. You would have understood it, this blog will mainly speak about embedded Linux operating system,
but also about open firmware and rtos, as well as related topics like virtualization, security, etc.&lt;/p&gt;
&lt;p&gt;I hope you will like the articles of this blog, enjoy the reading.&lt;/p&gt;
</content><category term="misc"></category><category term="blog"></category></entry></feed>