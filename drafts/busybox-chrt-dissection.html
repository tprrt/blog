<!DOCTYPE html>
<html lang="en">

<head>
      <meta charset="utf-8">
  <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />


  <title>How the Busybox's chrt applet works</title>


  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="referrer" content="origin" />
  <meta name="generator" content="Pelican" />
  <link href="https://tprrt.tupi.fr" rel="canonical" />

  <!-- Feed -->
        <link href="/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Tprrt's Blog Full Atom Feed" />

  <link href="https://tprrt.tupi.fr/theme/css/style.css" type="text/css" rel="stylesheet" />

  <!-- Code highlight color scheme -->
      <link href="https://tprrt.tupi.fr/theme/css/code_blocks/github.css" rel="stylesheet">


  <!-- Custom fonts -->
  <link href='https://fonts.googleapis.com/css?family=Montserrat:400,300' rel='stylesheet' type='text/css' />
  <link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet" type="text/css" />

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
  <![endif]-->

      <script data-ad-client="ca-pub-8632147971669760" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


    <link href="https://tprrt.tupi.fr/drafts/busybox-chrt-dissection.html" rel="canonical" />

        <meta name="description" content="This article details the implementation of the chrt applet from Busybox">

        <meta name="author" content="tperrot">

        <meta name="tags" content="busybox">
        <meta name="tags" content="chrt">

        <meta property="og:locale" content="" />
    <meta property="og:site_name" content="Tprrt's Blog" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Tprrt's Blog" />
    <meta property="og:description" content="Yet another  blog about Linux embedded" />
    <meta property="og:url" content="https://tprrt.tupi.fr" />
      <meta property="og:image" content="https://tprrt.tupi.fr/static/header_cover.png" />
      <meta property="article:publisher" content="https://facebook.com/tperrot31" />

  <meta property="og:type" content="article">
            <meta property="article:author" content="https://tprrt.tupi.fr/author/tperrot">
  <meta property="og:url" content="https://tprrt.tupi.fr/drafts/busybox-chrt-dissection.html">
  <meta property="og:title" content="How the Busybox's chrt applet works">
  <meta property="article:published_time" content="2020-09-08 19:20:00+02:00">
            <meta property="og:description" content="This article details the implementation of the chrt applet from Busybox">

            <meta property="og:image" content="https://tprrt.tupi.fr/static/header_cover.png">
        <meta name="twitter:card" content="summary_large_image">
        <meta name="twitter:site" content="@tprrt31">
        <meta name="twitter:title" content="How the Busybox's chrt applet works">
        <meta name="twitter:url" content="https://tprrt.tupi.fr/drafts/busybox-chrt-dissection.html">

            <meta name="twitter:image:src" content="https://tprrt.tupi.fr/static/header_cover.png">

            <meta name="twitter:description" content="This article details the implementation of the chrt applet from Busybox">
</head>
<!-- TODO : Body class -->
<body class="home-template">

<nav id="menu">
  <a class="close-button">Close</a>
  <div class="nav-wrapper">
    <p class="nav-label">Menu</p>
    <ul>


    </ul>
  </div>
</nav>
    <!-- Progressbar -->
    <div class="progress-container">
        <span class="progress-bar"></span>
    </div>

    <!-- Page Header -->
    <!-- Set your background image for this header on the line below. -->
    <header id="post-header" class="has-cover">
      <div class="inner">
        <nav id="navigation">
            <span id="home-button" class="nav-button">
                <a class="home-button" href="https://tprrt.tupi.fr" title="Home"><i class="ic ic-arrow-left"></i> Home</a>
            </span>
          <span id="menu-button" class="nav-button">
            <a class="menu-button"><i class="ic ic-menu"></i> Menu</a>
          </span>
        </nav>
        <h1 class="post-title">How the Busybox's chrt applet works</h1>
        <!-- TODO : Proper class for headline -->
        <span class="post-meta">
                <a href="https://tprrt.tupi.fr/author/tperrot">Tperrot</a>
            | <time datetime="08 Sep 2020">08 Sep 2020</time>
        </span>
        <!-- TODO : Modified check -->
            <span class="post-meta"> | Updated on 09 Sep 2020</span>
        
            <div class="post-cover cover" style="background-image: url('static/header_cover.png')">            
        
      </div>
    </header>    

  <section id="wrapper">
    <a class="hidden-close"></a>

    <!-- Post content -->
    <main class="content" role="main">
        <article class="post">
        <div class="inner">
            <section class="post-content">
                <div class="section" id="introduction">
<h2>Introduction</h2>
<p>In this article, I will dissect how the <em>chrt</em> applet from the release 1.32.0 of Busybox works, what it does, etc.</p>
<p>This command is a Linux utils allowing to consult or to modify the scheduling attributes of a process.</p>
<pre class="literal-block">
$ chrt -m
SCHED_OTHER min/max priority    : 0/0
SCHED_FIFO min/max priority     : 1/99
SCHED_RR min/max priority       : 1/99
SCHED_BATCH min/max priority    : 0/0
SCHED_IDLE min/max priority     : 0/0
SCHED_DEADLINE min/max priority : 0/0

$ pidof firefox
6987 6851 6825 6816 6800 6771 6767 6761 6720 6611

$ chrt -p 6987
pid 6987's current scheduling policy: SCHED_OTHER
pid 6987's current scheduling priority: 0

$ sudo chrt -f -p 1 6987
$ chrt -p 6987
pid 6987's current scheduling policy: SCHED_FIFO
pid 6987's current scheduling priority: 1
</pre>
<p>Busybox provides an applet which size, once compiled, and ten times smaller than that of the binary implementation and with
some limitations.</p>
</div>
<div class="section" id="the-dissection">
<h2>The dissection</h2>
<p>The implementation of the <em>chrt</em> applet is in the file
<a class="reference external" href="https://elixir.free-electrons.com/busybox/1.32.0/source/util-linux/chrt.c">util-linux/chrt.c</a> that containing several
functions which are called in the main function of this applet.</p>
<p>The main function of this applet is divised in three main parts:
- the first parses the command options
- the second prints the scheduler's information
- the last one, to apply scheduler changes in case of a set</p>
<p>At start of main, the character string containing the options are parsed to obtain a bitfield easier to use:</p>
<pre class="literal-block">
opt = getopt32(argv, &quot;^&quot;
                &quot;+&quot; &quot;mprfobi&quot;
                &quot;\0&quot;
                /* only one policy accepted: */
                &quot;r--fobi:f--robi:o--rfbi:b--rfoi:i--rfob&quot;
);
</pre>
<p>If the (-m) is set then the min and max valid priorities for each scheduling policies are shown and the command is existed:</p>
<pre class="literal-block">
if (opt &amp; OPT_m) { /* print min/max and exit */
        show_min_max(SCHED_OTHER);
        show_min_max(SCHED_FIFO);
        show_min_max(SCHED_RR);
        show_min_max(SCHED_BATCH);
        show_min_max(SCHED_IDLE);
        fflush_stdout_and_exit(EXIT_SUCCESS);
}
</pre>
<p>The function <em>show_min_max</em> sends use the Posix functions <em>sched_get_priority_max</em> and <em>sched_get_priority_min</em> from the
standard C library to send a syscall to the kernel in order to obtain the min and max values accepted by each policy:</p>
<pre class="literal-block">
max = sched_get_priority_max(pol);
min = sched_get_priority_min(pol);
if ((max|min) &lt; 0)
    fmt = &quot;SCHED_%s not supported\n&quot;;
</pre>
<p>Otherwise the required options and arguments to show or to apply real-time attributes of a process:</p>
<pre class="literal-block">
//if (opt &amp; OPT_r)
//  policy = SCHED_RR; - default, already set
if (opt &amp; OPT_f)
    policy = SCHED_FIFO;
if (opt &amp; OPT_o)
    policy = SCHED_OTHER;
if (opt &amp; OPT_b)
    policy = SCHED_BATCH;
if (opt &amp; OPT_i)
    policy = SCHED_IDLE;

argv += optind;
if (!argv[0])
    bb_show_usage();
if (opt &amp; OPT_p) {
    pid_str = *argv++;
    if (*argv) { /* &quot;-p PRIO PID [...]&quot; */
            priority = pid_str;
            pid_str = *argv;
    }
    /* else &quot;-p PID&quot;, and *argv == NULL */
    pid = xatoul_range(pid_str, 1, ((unsigned)(pid_t)ULONG_MAX) &gt;&gt; 1);
} else {
    priority = *argv++;
    if (!*argv)
            bb_show_usage();
}
</pre>
<p>Then the applet uses the Posix function <em>sched_getscheduler</em> provides by the standard C library to obtain the scheduling attributes of the process specified by the pid.</p>
<pre class="literal-block">
print_rt_info:
    pol = sched_getscheduler(pid);
    if (pol &lt; 0)
            bb_perror_msg_and_die(&quot;can't %cet pid %u's policy&quot;, 'g', (int)pid);
</pre>
<p>Finally, when the <em>chrt</em> applet is used to modify scheduling attributes then the Posix function <em>sched_getscheduler</em> is used and the new scheduling attributes are showed:</p>
<pre class="literal-block">
if (sched_setscheduler(pid, policy, &amp;sp) &lt; 0)
    bb_perror_msg_and_die(&quot;can't %cet pid %u's policy&quot;, 's', (int)pid);

if (!argv[0]) /* &quot;-p PRIO PID [...]&quot; */
    goto print_rt_info;
</pre>
<p>The function <em>sched_getscheduler</em> and <em>sched_getscheduler</em> will send a syscall to the scheduler subsystem of the kernel Linux.
This subsystem also exposes this information from <em>/proc</em>:</p>
<pre class="literal-block">
$ cat /proc/6987/sched
WebExtensions (6987, #threads: 23)
-------------------------------------------------------------------
se.exec_start                                :       4421312.640001
se.vruntime                                  :        344438.942254
se.sum_exec_runtime                          :         38238.466094
se.nr_migrations                             :                 6811
nr_switches                                  :                49452
nr_voluntary_switches                        :                21749
nr_involuntary_switches                      :                27703
se.load.weight                               :              1048576
se.runnable_weight                           :              1048576
se.avg.load_sum                              :                 3415
se.avg.runnable_load_sum                     :                 3415
se.avg.util_sum                              :              3497621
se.avg.load_avg                              :                   74
se.avg.runnable_load_avg                     :                   74
se.avg.util_avg                              :                   74
se.avg.last_update_time                      :        4421312640000
se.avg.util_est.ewma                         :                   75
se.avg.util_est.enqueued                     :                   75
policy                                       :                    0
prio                                         :                  120
clock-delta                                  :                   89
mm-&gt;numa_scan_seq                            :                    0
numa_pages_migrated                          :                    0
numa_preferred_nid                           :                   -1
total_numa_faults                            :                    0
current_node=0, numa_group_id=0
numa_faults node=0 task_private=0 task_shared=0 group_private=0 group_shared=0
</pre>
</div>
<div class="section" id="limitations">
<h2>Limitations</h2>
<p>Below a short list of limitations that I observed during my analysis of this applet.</p>
<div class="section" id="resetting-scheduling-policy">
<h3>Resetting scheduling policy</h3>
<p>The <em>chrt</em> applet doesn't offer an option (-R) to specify if the scheduling policy should be applied or reseted when a
process is fork to create children. This feature, introduced since Linux 2.6.32, can be only enabled or disabled at the
build of busybox and it is applied on all scheduling attributes modifications done with this applet.</p>
</div>
<div class="section" id="deadline-support">
<h3>Deadline support</h3>
<p>The <em>chrt</em> applet doesn't provide the required scheduling options (-d, -T, -P and -D) to set the deadline scheduling attributes of a process.</p>
</div>
</div>

            </section>

            <section class="post-info">
                <div class="post-share">
                    <a class="twitter" href="https://twitter.com/share?text=How the Busybox's chrt applet works&amp;url=https://tprrt.tupi.fr/drafts/busybox-chrt-dissection.html" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                    <i class="ic ic-twitter"></i><span class="hidden">Twitter</span>
                    </a>
                    <a class="facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://tprrt.tupi.fr/drafts/busybox-chrt-dissection.html" onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                    <i class="ic ic-facebook"></i><span class="hidden">Facebook</span>
                    </a>
                    <a class="googleplus" href="https://plus.google.com/share?url=https://tprrt.tupi.fr/drafts/busybox-chrt-dissection.html" onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
                    <i class="ic ic-googleplus"></i><span class="hidden">Google+</span>
                    </a>
                    <div class="clear"></div>
                </div>

                <aside class="post-tags">
<a href="https://tprrt.tupi.fr/tag/busybox">busybox</a><a href="https://tprrt.tupi.fr/tag/chrt">chrt</a>                </aside>

                <div class="clear"></div>

                <aside class="post-author">
                        <figure class="post-author-avatar">
                            <img src="static/avatar.png" alt="Tperrot" />
                        </figure>
                    <div class="post-author-bio">
                        <h4 class="post-author-name"><a href="https://tprrt.tupi.fr/author/tperrot">Tperrot</a></h4>
                            <p class="post-author-about">This is the place for a small biography with max 200 characters. Well, now 100 are left. Cool, hugh?</p>
                            <span class="post-author-location"><i class="ic ic-location"></i> Toulouse</span>
                            <span class="post-author-website"><a href="https://tprrt.tupi.fr"><i class="ic ic-link"></i> Website</a></span>
                    </div>
                    <div class="clear"></div>
                </aside>
 

                </section>


                <aside class="post-nav">
                    <div class="clear"></div>
                </aside>

            </div>
        </article>
    </main>
      <!-- TODO : Body class -->
    <div id="body-class" style="display: none;" class=""></div>
  
    <footer id="footer">
      <div class="inner">
        <section class="credits">
          <span class="credits-theme">Theme <a href="https://github.com/arulrajnet/attila" rel="nofollow">Attila</a></span>
          <span class="credits-software">Published with <a href="https://github.com/getpelican/pelican" rel="nofollow">Pelican</a></span>
        </section>
      </div>
    </footer>
  </section>

  <script type="text/javascript" src="https://tprrt.tupi.fr/theme/js/script.js"></script>
  
    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-169118252-1']);
    _gaq.push(['_trackPageview']);
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>
</body>
</html>